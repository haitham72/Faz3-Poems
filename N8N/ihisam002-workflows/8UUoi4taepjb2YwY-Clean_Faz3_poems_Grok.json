{
  "name": "Clean - Faz3 poems - Grok",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        5216,
        2704
      ],
      "id": "bd0f7d5d-06be-4564-91af-da5329e63e97",
      "name": "When clicking ‘Execute workflow’"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w",
          "mode": "list",
          "cachedResultName": "FAZ_POEMS_REVIEW",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1031138690,
          "mode": "list",
          "cachedResultName": "Entity_extractions of Exact_search",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit#gid=1031138690"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "Status",
              "lookupValue": "Ready"
            }
          ]
        },
        "options": {
          "returnFirstMatch": false
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2624,
        1792
      ],
      "id": "9895e141-f950-4d21-b271-888b4d84bc57",
      "name": "Get row(s) in sheet7",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "OV5c4nxTt4atkgGW",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=TASK: Analyze each line below individually.\n\nPoem title: {{ $json.poem }}\n\nLines to process:\n{{ $json.contents_tagged }}\n\nmake sure to grasp full poem and be coherent with entities through the poem lines and never lose track of the context.",
        "options": {
          "systemMessage": "=You are an AI assistant that extracts special event tags from Arabic poetry lines provided in a specific grouped format.  \nYou must be extremely strict: only pick tags that appear exactly or very closely in the poetry line text AND are present in the strict reference list below.  \nNever add new tags. Never normalize beyond minor spelling variations (e.g., \"ليله القدر\" → \"ليلة القدر\").\n\n### Input Format\nThe input will be an array of objects, where each object represents one poem and contains a `contents_tagged` array.  \nEach entry in `contents_tagged` is a string in the exact format:  \n`\"Row_ID\":\"poetry line text\"`  \nExample:  \n```json\n[\n  {\n    \"poem_id\": 10,\n    \"poem\": \"شعب الامارات\",\n    \"contents_tagged\": [\n      \"\\\"108\\\":\\\"ابارك له في شهر نزل القران فيه انزال يضم من الليالي ليله القدر وفضايلها\\\"\",\n      \"\\\"120\\\":\\\"وعسي شعب الامارات العزيزه دوم ف احسن حال عسي دعواتهم ربي في شهر الخير يقبلها\\\"\"\n    ]\n  }\n]\n```\n\n### Strict Reference List (pick ONLY from these exact terms)\n\n**يوم وطني**  \nيوم الاتحاد، اليوم الوطني، يوم الشهيد، يوم العلم، يوم الوطن، احتفال الاتحاد، ذكرى التأسيس\n\n**مناسبة دينية**  \nرمضان، عيد الفطر، عيد الأضحى، ليلة القدر، الحج، عمرة، وقفة عرفات، الإفطار، السحور، صلاة الجمعة\n\n**احتفال شخصي**  \nعام جديد، عيد ميلاد، يوم الأب، يوم الأم، عيد الحب\n\n**فعالية تقليدية**  \nسباق الهجن، سباق الخيل، صيد الصقور، مهرجانات ثقافية\n\n**حدث تاريخي**  \nمعارك تاريخية، عيد الجلوس، قيام الاتحاد، توحيد الإمارة\n\n### Extraction Rules\n- Process **every** line in every `contents_tagged` array across all input items.\n- For **each line**, always extract its Row_ID.\n- Search the line text for any exact or very close match to tags in the reference list.\n- If one or more tags are found → create one output object **per matched tag** with the Row_ID and the tag.\n- If **no tag** is found in a line → still output **one object** for that line with the Row_ID and an empty array as the event value.\n\n### Output Format (JSON array of objects only – always one object per processed line)\n```json\n[\n  {\n    \"Row_ID\": \"108\",\n    \"event\": \"ليلة القدر\"\n  },\n  {\n    \"Row_ID\": \"108\",\n    \"event\": \"رمضان\"\n  },\n  {\n    \"Row_ID\": \"120\",\n    \"event\": []\n  }\n]\n```\nor when no events anywhere:\n```json\n[\n  {\n    \"Row_ID\": \"108\",\n    \"event\": []\n  },\n  {\n    \"Row_ID\": \"120\",\n    \"event\": []\n  }\n]\n```\n\n**Important**: Every processed line must appear in the output with its Row_ID. Use `event: []` when no event is detected for that line.\n\nOnly output the final JSON array. No additional text, no explanations."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        3760,
        1808
      ],
      "id": "b6441456-1313-4c24-971c-be0a45406f89",
      "name": "AI Agent6"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nlet results = [];\n\nitems.forEach(item => {\n  let outputStr = item.json.output || \"\";\n\n  // Remove markdown code blocks and any leading/trailing whitespace\n  outputStr = outputStr.replace(/```json|```/g, '').trim();\n\n  // Remove all whitespace characters that could interfere (newlines, tabs, etc.)\n  // but keep spaces inside strings\n  const normalized = outputStr.replace(/\\s+/g, ' ');\n\n  // Regex to match objects: {\"Row_ID\": \"number\", \"event\": ...}\n  // Captures Row_ID and the full event part (array or string)\n  const objectRegex = /{\\s*\"Row_ID\"\\s*:\\s*\"([^\"]+)\"\\s*,\\s*\"event\"\\s*:\\s*(\\[[^\\]]*\\]|\"[^\"]*\")\\s*}/g;\n\n  let match;\n  while ((match = objectRegex.exec(normalized)) !== null) {\n    const rowId = match[1].trim();\n    const eventRaw = match[2].trim();\n\n    let eventValue;\n\n    if (eventRaw === '[]') {\n      eventValue = [];\n    } else if (eventRaw.startsWith('[') && eventRaw.endsWith(']')) {\n      // Handle multiple tags: [\"رمضان\", \"ليلة القدر\"]\n      try {\n        eventValue = JSON.parse(eventRaw);\n      } catch (e) {\n        eventValue = [];\n      }\n    } else {\n      // Single quoted string\n      eventValue = eventRaw.slice(1, -1); // remove quotes\n    }\n\n    results.push({\n      Row_ID: rowId,\n      event: eventValue\n    });\n  }\n});\n\n// Return as proper n8n items\nreturn results.map(result => ({ json: result }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4256,
        1904
      ],
      "id": "7f2f58d8-688d-4144-b68a-54f37f2a7152",
      "name": "Code in JavaScript9"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        3504,
        1792
      ],
      "id": "96f87c77-f376-4ff7-a8b3-ac2cf3cb12a1",
      "name": "Loop Over Items7",
      "executeOnce": false
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w",
          "mode": "list",
          "cachedResultName": "FAZ_POEMS_REVIEW",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1031138690,
          "mode": "list",
          "cachedResultName": "Entity_extractions of Exact_search",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit#gid=1031138690"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Row_ID": "={{ $json.Row_ID }}",
            "Status": "Done",
            "أحداث": "={{ $json.event }}"
          },
          "matchingColumns": [
            "Row_ID"
          ],
          "schema": [
            {
              "id": "poem_id",
              "displayName": "poem_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Row_ID",
              "displayName": "Row_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Title_raw",
              "displayName": "Title_raw",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Poem_line_raw",
              "displayName": "Poem_line_raw",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "summary",
              "displayName": "summary",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Title_cleaned",
              "displayName": "Title_cleaned",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Poem_line_cleaned",
              "displayName": "Poem_line_cleaned",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "قافية",
              "displayName": "قافية",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "روي",
              "displayName": "روي",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "البحر",
              "displayName": "البحر",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "وصل",
              "displayName": "وصل",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "حركة",
              "displayName": "حركة",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "confidence",
              "displayName": "confidence",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "comment",
              "displayName": "comment",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "شخص",
              "displayName": "شخص",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "sentiments",
              "displayName": "sentiments",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "أماكن",
              "displayName": "أماكن",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "أحداث",
              "displayName": "أحداث",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Status",
              "displayName": "Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "دين",
              "displayName": "دين",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "religion_status",
              "displayName": "religion_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "مواضيع",
              "displayName": "مواضيع",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "تصنيف",
              "displayName": "تصنيف",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Column 19",
              "displayName": "Column 19",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "useAppend": true
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        4512,
        1904
      ],
      "id": "0056c7af-90e5-437b-ba99-72ede21341bb",
      "name": "Append or update row in sheet6",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "OV5c4nxTt4atkgGW",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "content": "## Events enhancements\n\n"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2064,
        1776
      ],
      "typeVersion": 1,
      "id": "3f3d8222-0ece-40c7-89e0-80a2e9ded1f9",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst grouped = items.reduce((acc, item) => {\n  const json = item.json;\n  // Create unique key combining poem_id and title to distinguish different poem instances\n  const uniqueKey = `${json.poem_id}-${json.Title_cleaned}`;\n  if (!acc[uniqueKey]) {\n    acc[uniqueKey] = {\n      poem_id: json.poem_id,\n      poem: json.Title_cleaned.trim(),\n      contents_tagged: []\n    };\n  }\n  const lineText = (json.Poem_line_cleaned || \"\").trim();\n  const rowId = json.Row_ID;  // This line is present in your original code\n  acc[uniqueKey].contents_tagged.push(`\"${rowId}\":\"${lineText}\"`);\n  return acc;\n}, {});\nconst result = Object.values(grouped);\nreturn result;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3296,
        1792
      ],
      "id": "6b628c83-2d1d-437a-b3de-d1401732f530",
      "name": "Code in JavaScript10"
    },
    {
      "parameters": {
        "model": "grok-4-1-fast-non-reasoning",
        "options": {
          "temperature": 0.2
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatXAiGrok",
      "typeVersion": 1,
      "position": [
        3696,
        2176
      ],
      "id": "beea8916-79fe-4e9f-ae42-173344d246a4",
      "name": "xAI Grok Chat Model5",
      "credentials": {
        "xAiApi": {
          "id": "8xuEmNzOUuELUh3f",
          "name": "xAi account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w",
          "mode": "list",
          "cachedResultName": "FAZ_POEMS_REVIEW",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1896427276,
          "mode": "list",
          "cachedResultName": "Semantic_Search",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit#gid=1896427276"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "Status",
              "lookupValue": "Ready"
            }
          ]
        },
        "options": {
          "dataLocationOnSheet": {
            "values": {
              "rangeDefinition": "specifyRange",
              "firstDataRow": 800
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2464,
        736
      ],
      "id": "d6113d53-b3d2-4667-8edd-2f4442f5f87a",
      "name": "Get row(s) in sheet3",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "OV5c4nxTt4atkgGW",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=\nTASK: Analyze each line below individually.\n\nPoem title: {{ $json.Title_cleaned }}\n\nChunk to process:\n{{ $json.poem_lines_subset }}\n\nhere is the full poem to situate with and take inspiration from:\n{{ $json.Full_poem }}\n\nINSTRUCTIONS:\n- summarize the poem chunks situated with full poem to make sure you get full context incase entity/place/event is not clear in the current Chunk\n- Never mention starting words like \"الشاعر حمدان بن محمد يتكلم عن ..\" this is completly unnecessary\n- only mention the speaker \"حمدان\" when it is absolutly necessary if he points to him self or speak about him slef.\n- dont use complex arabic metaphors, this is for contextual rag after all\n- make absolutly sure to aggressivly capture entites when found.\n\n# You Must Understand that this Contextual summary is for semantic search friendly RAG, this is not for users to read , this si for AI to situate and embed.\n",
        "options": {
          "systemMessage": "=# Arabic Poetry Summarizer for RAG (Sheikh Hamdan)\n\nGenerate dense contextual summaries (10-50 words) for 4-line poetry chunks.\n\n## Output Format\nPure Arabic summary text only. No prefixes like \"القصيدة تتحدث عن\" or chunk markers.\n\n## Core Focus (Priority Order)\n1. **Named Entities**: People, places, events (resolve ALL pronouns/kinship using dictionary below)\n2. **Primary Theme**: Love/patriotism/praise/mourning (single dominant theme)\n3. **Emotional Tone**: شوق/فخر/حزن/غزل (max 2 emotions)\n4. **Key Actions/States**: Verbs indicating narrative movement\n\n## PEOPLE Dictionary (Mandatory Reference)\n\n```json\n[\n  {\n    \"name_ar\": \"حمدان بن محمد بن راشد آل مكتوم\",\n    \"relation\": \"الذات\",\n    \"tags\": [\"حمدان\", \"فزاع\", \"ولي العهد\", \"قائد\", \"سيدي\", \"أمير\"]\n  },\n  {\n    \"name_ar\": \"محمد بن راشد آل مكتوم\",\n    \"relation\": \"الأب\",\n    \"tags\": [\"محمد بن راشد\", \"أبي\", \"والدي\", \"قائدي\", \"سيدي\", \"معلمي\", \"حاكم دبي\", \"نائب رئيس الدولة\", \"رئيس الوزراء\", \"صاحب السمو\"]\n  },\n  {\n    \"name_ar\": \"هند بنت مكتوم بن جمعة\",\n    \"relation\": \"الأم\",\n    \"tags\": [\"هند\", \"أمي\", \"والدتي\", \"سيدتي\", \"الأميرة\"]\n  },\n  {\n    \"name_ar\": \"راشد بن حمدان بن محمد\",\n    \"relation\": \"الابن\",\n    \"tags\": [\"راشد\", \"ابني\", \"ولدي\", \"فلذة كبدي\", \"نور عيني\", \"حبيبي\", \"أملي\", \"ذريتي\"]\n  },\n  {\n    \"name_ar\": \"شيخة بنت حمدان بن محمد\",\n    \"relation\": \"الابنة\",\n    \"tags\": [\"شيخة\", \"ابنتي\", \"بنتي\", \"نور عيني\", \"حبيبتي\", \"فرحتي\", \"أملي\", \"ذريتي\"]\n  },\n  {\n    \"name_ar\": \"مكتوم بن محمد بن راشد آل مكتوم\",\n    \"relation\": \"الأخ\",\n    \"tags\": [\"مكتوم\", \"أخي\", \"رفيق دربي\", \"سندي\", \"نائب حاكم دبي\", \"وزير المالية\"]\n  },\n  {\n    \"name_ar\": \"أحمد بن محمد بن راشد آل مكتوم\",\n    \"relation\": \"الأخ\",\n    \"tags\": [\"أحمد\", \"أخي\", \"رفيق دربي\", \"سندي\", \"نائب حاكم دبي\"]\n  },\n  {\n    \"name_ar\": \"راشد بن محمد بن راشد آل مكتوم\",\n    \"relation\": \"الأخ (في ذمة ا��له)\",\n    \"tags\": [\"راشد\", \"أخي\", \"الفقيد\", \"رحمه الله\", \"طيب الله ثراه\", \"في ذمة الله\"]\n  },\n  {\n    \"name_ar\": \"محمد بن زايد آل نهيان\",\n    \"relation\": \"رئيس الدولة\",\n    \"tags\": [\"محمد بن زايد\", \"قائدي\", \"سيدي\", \"بو خالد\", \"رئيس الدولة\", \"حاكم أبوظبي\", \"صاحب السمو\", \"رفيق درب\"]\n  },\n  {\n    \"name_ar\": \"زايد بن سلطان آل نهيان\",\n    \"relation\": \"المؤسس\",\n    \"tags\": [\"زايد\", \"المؤسس\", \"الوالد المؤسس\", \"أبو الأمة\", \"الباني\", \"رحمه الله\", \"طيب الله ثراه\", \"القائد\"]\n  },\n  {\n    \"name_ar\": \"فاطمة بنت مبارك الكتبي\",\n    \"relation\": \"أم الإمارات\",\n    \"tags\": [\"فاطمة بنت مبارك\", \"أم الإمارات\", \"أم الأمة\", \"سيدتي\", \"الأميرة\"]\n  },\n  {\n    \"name_ar\": \"حمدان بن زايد آل نهيان\",\n    \"relation\": \"أخو رئيس الدولة\",\n    \"tags\": [\"حمدان بن زايد\", \"سيدي\", \"أخي\", \"ممثل الحاكم في المنطقة الغربية\", \"صاحب السمو\"]\n  },\n  {\n    \"name_ar\": \"منصور بن زايد آل نهيان\",\n    \"relation\": \"أخو رئيس الدولة\",\n    \"tags\": [\"منصور بن زايد\", \"سيدي\", \"أخي\", \"نائب رئيس الدولة\", \"وزير شؤون الرئاسة\", \"صاحب السمو\"]\n  },\n  {\n    \"name_ar\": \"طحنون بن زايد آل نهيان\",\n    \"relation\": \"أخو رئيس الدولة\",\n    \"tags\": [\"طحنون بن زايد\", \"سيدي\", \"أخي\", \"مستشار الأمن الوطني\", \"صاحب السمو\"]\n  },\n  {\n    \"name_ar\": \"عبدالله بن زايد آل نهيان\",\n    \"relation\": \"أخو رئيس الدولة\",\n    \"tags\": [\"عبدالله بن زايد\", \"سيدي\", \"أخي\", \"وزير الخارجية والتعاون الدولي\", \"صاحب السمو\"]\n  },\n  {\n    \"name_ar\": \"خالد بن محمد آل نهيان\",\n    \"relation\": \"ولي عهد أبوظبي\",\n    \"tags\": [\"خالد بن محمد\", \"ولي العهد\", \"ابن محمد بن زايد\", \"خالد\"]\n  },\n  {\n    \"name_ar\": \"سلطان بن محمد القاسمي\",\n    \"relation\": \"حاكم الشارقة\",\n    \"tags\": [\"سلطان بن محمد\", \"القاسمي\", \"حاكم الشارقة\", \"أمير الشارقة\", \"سلطان\"]\n  },\n  {\n    \"name_ar\": \"سعود بن صقر القاسمي\",\n    \"relation\": \"حاكم رأس الخيمة\",\n    \"tags\": [\"سعود بن صقر\", \"القاسمي\", \"حاكم رأس الخيمة\", \"أمير رأس الخيمة\", \"سعود\"]\n  },\n  {\n    \"name_ar\": \"حميد بن راشد النعيمي\",\n    \"relation\": \"حاكم عجمان\",\n    \"tags\": [\"حميد بن راشد\", \"النعيمي\", \"حاكم عجمان\", \"أمير عجمان\", \"حميد\"]\n  },\n  {\n    \"name_ar\": \"سعود بن راشد المعلا\",\n    \"relation\": \"حاكم أم القيوين\",\n    \"tags\": [\"سعود بن راشد\", \"المعلا\", \"حاكم أم القيوين\", \"أمير أم القيوين\", \"سعود\"]\n  },\n  {\n    \"name_ar\": \"حمد بن محمد الشرقي\",\n    \"relation\": \"حاكم الفجيرة\",\n    \"tags\": [\"حمد بن محمد\", \"الشرقي\", \"حاكم الفجيرة\", \"أمير الفجيرة\", \"حمد\"]\n  },\n  {\n    \"name_ar\": \"سلمان بن عبدالعزيز آل سعود\",\n    \"relation\": \"ملك المملكة العربية السعودية\",\n    \"tags\": [\"سلمان\", \"خادم الحرمين الشريفين\", \"ملك السعودية\", \"أخي\", \"قائد\", \"جار\"]\n  },\n  {\n    \"name_ar\": \"محمد بن سلمان آل سعود\",\n    \"relation\": \"ولي عهد المملكة العربية السعودية\",\n    \"tags\": [\"محمد بن سلمان\", \"ولي العهد\", \"أمير\", \"أخي\", \"صديق\", \"رفيق\", \"قائد\"]\n  },\n  {\n    \"name_ar\": \"تميم بن حمد آل ثاني\",\n    \"relation\": \"أمير دولة قطر\",\n    \"tags\": [\"تميم\", \"أمير\", \"أمير قطر\", \"أخي\", \"جار\", \"صديق\"]\n  },\n  {\n    \"name_ar\": \"حمد بن عيسى آل خليفة\",\n    \"relation\": \"ملك مملكة البحرين\",\n    \"tags\": [\"حمد\", \"ملك\", \"ملك البحرين\", \"أخي\", \"جار\", \"صديق\"]\n  },\n  {\n    \"name_ar\": \"مشعل الأحمد الجابر الصباح\",\n    \"relation\": \"أمير دولة الكويت\",\n    \"tags\": [\"مشعل\", \"أمير\", \"أمير الكويت\", \"أخي\", \"جار\", \"صديق\"]\n  },\n  {\n    \"name_ar\": \"هيثم بن طارق\",\n    \"relation\": \"سلطان عُمان\",\n    \"tags\": [\"هيثم\", \"سلطان\", \"عمان\", \"جار\", \"صديق\"]\n  },\n  {\n    \"name_ar\": \"هزاع بن زايد آل نهيان\",\n    \"relation\": \"أخو رئيس الدولة\",\n    \"tags\": [\"هزاع بن زايد\", \"سيدي\", \"أخي\", \"نائب حاكم أبوظبي\"]\n  },\n  {\n    \"name_ar\": \"سيف بن زايد آل نهيان\",\n    \"relation\": \"أخو رئيس الدولة\",\n    \"tags\": [\"سيف بن زايد\", \"سيدي\", \"أخي\", \"نائب رئيس مجلس الوزراء\", \"وزير الداخلية\"]\n  },\n  {\n    \"name_ar\": \"ذياب بن محمد آل نهيان\",\n    \"relation\": \"ابن رئيس الدولة\",\n    \"tags\": [\"ذياب بن محمد\", \"ابن محمد بن زايد\"]\n  },\n  {\n    \"name_ar\": \"مريم بنت محمد آل مكتوم\",\n    \"relation\": \"الأخت\",\n    \"tags\": [\"مريم\", \"أختي\", \"بنت محمد بن راشد\"]\n  },\n  {\n    \"name_ar\": \"سلامة بنت محمد آل مكتوم\",\n    \"relation\": \"الأخت\",\n    \"tags\": [\"سلامة\", \"أختي\", \"بنت محمد بن راشد\"]\n  },\n  {\n    \"name_ar\": \"شمسة بنت محمد آل مكتوم\",\n    \"relation\": \"الأخت\",\n    \"tags\": [\"شمسة\", \"أختي\", \"بنت محمد بن راشد\"]\n  },\n  {\n    \"name_ar\": \"مهيرة بنت محمد آل مكتوم\",\n    \"relation\": \"الأخت\",\n    \"tags\": [\"مهيرة\", \"أختي\", \"بنت محمد بن راشد\"]\n  },\n  {\n    \"name_ar\": \"لطيفة بنت محمد آل مكتوم\",\n    \"relation\": \"الأخت\",\n    \"tags\": [\"لطيفة\", \"أختي\", \"بنت محمد بن راشد\"]\n  },\n  {\n    \"name_ar\": \"عبد الفتاح السيسي\",\n    \"relation\": \"رئيس مصر\",\n    \"tags\": [\"السيسي\", \"عبد الفتاح السيسي\", \"رئيس مصر\", \"صديق\"]\n  },\n  {\n    \"name_ar\": \"محمد السادس\",\n    \"relation\": \"ملك المغرب\",\n    \"tags\": [\"محمد السادس\", \"ملك المغرب\", \"صديق\"]\n  }\n]\n```\n\n## Entity Resolution Rules\n\n**Pronoun Resolution (غزل context)**:\n- 2nd person (أنت/ـك/ـكِ) + body parts (عينيك/خصرك/رمشك) → الحبيبة\n- Qualities (أرقّ/راقي/جميل) addressing 2nd person → صفات الحبيبة\n\n**Kinship Resolution** (match tags to people above):\n- أبي/والدي/قائدي/معلمي → محمد بن راشد آل مكتوم\n- أمي/والدتي → هند بنت مكتوم بن جمعة  \n- ابني/راشد/ولدي/نور عيني (son context) → راشد بن حمدان بن محمد\n- ابنتي/شيخة/بنتي/نور عيني (daughter context) → شيخة بنت حمدان بن محمد\n- أخي + دبي context → مكتوم/أحمد بن محمد بن راشد\n- أخي + رحمه الله → راشد بن محمد بن راشد (الفقيد)\n\n**Leadership Terms**:\n- بو خالد/محمد بن زايد/رئيس الدولة → محمد بن زايد آل نهيان\n- زايد/المؤسس/الوالد المؤسس/الباني → زايد بن سلطان آل نهيان\n\n**Self-Reference**:\n- أنا/لي/قلبي (1st person Sheikh Hamdan) → حمدان بن محمد بن راشد آل مكتوم\n\n## Additional Entity Categories\n\n**GROUPS**: \n- شهداء/ابطال → شهداء الإمارات\n- مواطنين/الشعب → شعب الإمارات\n- الاباء المؤسسين → الآباء المؤسسين\n- جنود/الجيش → جنود الإمارات\n\n**LOCATIONS**: \n- دبي, أبوظبي, الشارقة, عجمان, أم القيوين, الفجيرة, رأس الخيمة\n- برج خليفة, مسجد الشيخ زايد, نخله جميرا\n\n**EVENTS**: \n- يوم الشهيد, اليوم الوطني, يوم العلم, عيد الأب, رمضان, عيد الفطر\n\n## Handling Ambiguity\n- **Multiple themes**: Pick dominant (غزل > وطنية > رثاء)\n- **Metaphors**: Keep literal if entity unclear (\"القمر\" = القمر unless proven person)\n- **Missing entities**: Describe theme (\"الشاعر يصف الشوق والفراق\")\n\n## Quality Rules\n- ✅ Entity name_ar + theme + emotion\n- ✅ Dense factual (no fluff)\n- ❌ No interpretation beyond text+dictionary\n- ❌ No generic \"يتحدث الشاعر\"\n- ❌ No English/transliteration\n\n## Example Outputs\n\n**Input:**\n```\nحبيبتي حالي من الشوق داني\nأشرق بحبك .. واعود أغرب\n```\n**Output:** `الشاعر يعبر عن شوقه لحبيبته، واصفا حبه المتناقض الذي يجمع بين الإشراق والغروب.`\n\n**Input:**\n```\nأبي والدي قائدي ومعلمي\nيا فخر الإمارات راشد بن سعيد\n```\n**Output:** `مدح محمد بن راشد آل مكتوم كقائد ومعلم، مع ذكر راشد بن سعيد كرمز للفخر والهمة.`\n\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        3248,
        752
      ],
      "id": "25405655-816d-4561-9375-167f13fbd9a3",
      "name": "AI Agent3"
    },
    {
      "parameters": {
        "batchSize": 10,
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        2912,
        736
      ],
      "id": "254e2434-dc2e-45b1-88d1-fb222457e13b",
      "name": "Loop Over Items3",
      "executeOnce": false
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w",
          "mode": "list",
          "cachedResultName": "FAZ_POEMS_REVIEW",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1896427276,
          "mode": "list",
          "cachedResultName": "Semantic_Search",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit#gid=1896427276"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chunk_id": "={{ $('Loop Over Items3').item.json.chunk_id }}",
            "Summary_chunked": "={{ $json.output }}",
            "Status": "Done"
          },
          "matchingColumns": [
            "chunk_id"
          ],
          "schema": [
            {
              "id": "poem_id",
              "displayName": "poem_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "chunk_id",
              "displayName": "chunk_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Title_cleaned",
              "displayName": "Title_cleaned",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "poem_lines_subset",
              "displayName": "poem_lines_subset",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Summary_chunked",
              "displayName": "Summary_chunked",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Status",
              "displayName": "Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Full_poem",
              "displayName": "Full_poem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Title_raw",
              "displayName": "Title_raw",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Poem_line_raw",
              "displayName": "Poem_line_raw",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        3808,
        752
      ],
      "id": "a1f26a84-9c96-4645-9879-086405bdde10",
      "name": "Append or update row in sheet3",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "OV5c4nxTt4atkgGW",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "content": "## contextual Rag"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2064,
        736
      ],
      "typeVersion": 1,
      "id": "9898e6fa-0d57-4fa4-966c-4eabf11353bf",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        3056,
        1104
      ],
      "id": "d8c1a645-cf52-43dd-b975-fd198e902419",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "frYVvB9GNXXi6o6J",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e3dc2c5e-6774-4bd6-a441-142324407e22",
              "name": "chunk_id",
              "value": "={{ $json.chunk_id }}",
              "type": "number"
            },
            {
              "id": "25b20dcf-591d-407e-bdce-39fffe2e150e",
              "name": "Title_cleaned",
              "value": "={{ $json.Title_cleaned }}",
              "type": "string"
            },
            {
              "id": "7c7e3207-1581-4351-b2d7-591abb1fd0f5",
              "name": "poem_lines_subset",
              "value": "={{ $json.poem_lines_subset }}",
              "type": "string"
            },
            {
              "id": "3398fdb8-194d-4b6d-8bad-cbfbf0f8c780",
              "name": "Full_poem",
              "value": "={{ $json.Full_poem }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2672,
        736
      ],
      "id": "fb806012-43a5-4be7-b186-087f0f4b4742",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "429e3501-75e6-4aa4-93b3-2891f316857a",
              "name": "output",
              "value": "={{ $json.output }}---{{ $('Loop Over Items3').item.json.poem_lines_subset }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3600,
        752
      ],
      "id": "61a94875-4a7c-4d29-bda8-538e6599531a",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "model": "grok-4-1-fast-non-reasoning",
        "options": {
          "temperature": 0.2
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatXAiGrok",
      "typeVersion": 1,
      "position": [
        3216,
        1104
      ],
      "id": "f8f23b9f-ffff-43de-beff-4ecfbfeba6a6",
      "name": "xAI Grok Chat Model2",
      "credentials": {
        "xAiApi": {
          "id": "8xuEmNzOUuELUh3f",
          "name": "xAi account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w",
          "mode": "list",
          "cachedResultName": "FAZ_POEMS_REVIEW",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1836724327,
          "mode": "list",
          "cachedResultName": "Exact_lines",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit#gid=1836724327"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "Status"
            }
          ]
        },
        "options": {
          "dataLocationOnSheet": {
            "values": {
              "rangeDefinition": "specifyRange",
              "firstDataRow": 1
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2496,
        1344
      ],
      "id": "4cf4a583-7b38-453d-bf2c-17aa1b97046b",
      "name": "Get row(s) in sheet4",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "OV5c4nxTt4atkgGW",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=TASK: Analyze each line below individually.\nPoem title: {{ $json.poem }}\n\nLines to process:\n{{ $json.contents_tagged }}\n",
        "options": {
          "systemMessage": "=You are a specialist Arabic prosody and rhyme analyzer (عَروض وقافية) with deep expertise in both Classical Arabic and Nabati poetry. You must analyze **each input line independently** and return **VALID JSON ONLY** following the exact schema and rules below. NO EXPLANATIONS, NO EXTRA TEXT, NO MARKDOWN.\n\n-------------------------\nINPUT\n-------------------------\nThe model will receive a batch of lines or single lines. Each item may be an object with keys like:\n- \"row_id\" (integer or string) — optional but preferred\n- \"line\" or \"Poem_line\" (Arabic text) — the poetry line to analyze\n\nIf the input item does not contain a poetry text field (line/Poem_line), do NOT guess prosody. Instead return an error object for that row (see Error Handling).\n\n-------------------------\nHARD RULES / DEFINITIONS (UNAMBIGUOUS)\n-------------------------\n1) الروي (rawi)\n- Definition: The single **final consonant** used as the rhyme anchor (e.g., ب، ت، ث، ج، ح، خ، د، ر، ز، س، ش، ص، ض، ط، ظ، ع، غ، ف، ق، ك، ل، م، ن، هـ، ي).\n- Output: EXACTLY ONE ARABIC LETTER (no diacritics, no words). If it cannot be isolated, output \"غير محدد\".\n\n2) الوصل (wasl)\n- Definition: A letter pronounced **immediately after** a ساكن rawi (examples: ألف وصل، واو وصل، ياء وصل، هاء وصل). \n- Rule: **Only set wasl if** the rawi is ساكن and the next pronounced letter is one of (ا، و، ي، ه). \n- Otherwise set `\"وصل\": \"لا يوجد\"`.\n- If uncertain, set `\"وصل\": \"لا يوجد\"` and reduce confidence.\n\n3) القافية (qafiya)\n- Definition: The **minimal phonetic rhyme suffix**, NOT the whole final word.\n- Rules:\n  - Return the minimal sequence of 1–3 letters representing the ending rhyme (examples: \"ها\", \"ور\", \"يب\", \"رب\", \"ني\").\n  - Do NOT return entire words or extra tokens (no spaces).\n  - Normalize common cases: trailing hamza/ta marbuta patterns should be represented phonetically (\"ة\"→\"ه\" when pronounced as /-a/ or keep \"ة\" if pronounced /-t/ in your judgment).\n  - If the final element is clearly a long vowel or diphthong, include it (e.g., \"يا\" if the rhyme is \"يا\").\n\n4) البحر (bahr)\n- Identify the meter accurately from these pools:\n  - Classical list (examples): \"الطويل\", \"الوافر\", \"الكامل\", \"البسيط\", \"الرمل\", \"الخفيف\", \"المتقارب\", \"الرجز\", ...\n  - Nabati/folk list (examples): \"المسحوب\", \"الهجيني\", \"مجزوء الهجيني\", \"الصخري\", ...\n- If you can match a classical or Nabati meter, return its canonical Arabic name. If not sure, return `\"غير محسوم\"`.\n\n5) حركة (haraka)\n- Return one of: \"فتحة\", \"ضمة\", \"كسرة\", \"سكون\".\n- Base this on pronunciation of the rawi in the final rhythmic foot.\n- If uncertain, choose the most likely and lower confidence.\n\n6) Status\n- \"محسوم\" only when bahr, rawi, and qafiya are all clear.\n- Otherwise \"غير محسوم\".\n\n7) confidence\n- Numeric between 0.0 and 1.0.\n  - >= 0.90 → very high confidence (clear meter & rhyme)\n  - 0.75–0.89 → minor uncertainty\n  - 0.60–0.74 → moderate uncertainty (use \"غير محسوم\")\n  - < 0.60 → low confidence, mark \"غير محسوم\"\n\n8) نوع (type)\n- Classify each line as one of: \"كلاسيكي\" (Classical Arabic), \"نبطي\" (Nabati/Bedouin), or \"غير محدد\".\n- Use linguistic features (lexicon, rhythm, markers) to decide. If unsure, \"غير محدد\".\n\n-------------------------\nFORBIDDEN (do not do these)\n-------------------------\n- Do NOT output full lexical words as qafiya.\n- Do NOT invent fields not listed below.\n- Do NOT output any prose, explanations, or markdown.\n- Do NOT continue a prior task (e.g., sentiment/entity extraction). If input looks like previous pipeline output (entities/sentiments), refuse (see Error Handling).\n- Do NOT normalize away essential pronunciation cues (unless explicitly described above).\n\n-------------------------\nERROR HANDLING (must follow)\n-------------------------\nIf the input item:\n- lacks a poetry line field OR\n- clearly contains only structured analyzer output (entities/sentiments) rather than raw poetry text,\n\nThen return for that item **only** a JSON object with:\n```json\n{\n  \"row_id\": <the row id if present or empty string>,\n  \"error\": \"invalid_input\",\n  \"message\": \"Expected raw Arabic poetry line in field 'line' or 'Poem_line'.\"\n}\n````\n\nDo NOT attempt to produce prosody for invalid input.\n\n---\n\n## OUTPUT SCHEMA (BATCH)\n\nReturn an ARRAY of objects. Each object must include these keys exactly (use Arabic field names):\n\n* row_id: integer or string (copy from input; if missing use \"\")\n* line: string (the original line; if not provided use \"\")\n* قافية: string (minimal rhyme suffix)\n* روي: string (one letter or \"غير محدد\")\n* البحر: string\n* وصل: string (\"لا يوجد\" or a single letter)\n* حركة: string\n* Status: string (\"محسوم\" or \"غير محسوم\")\n* confidence: number (0.0–1.0)\n* نوع: string (\"كلاسيكي\", \"نبطي\", or \"غير محدد\")\n\nExample (single item in array):\n[\n{\n\"row_id\": 1,\n\"line\": \"حبيبتي حالي من الشوق داني اشرق بحبك واعود اغرب\",\n\"قافية\": \"رب\",\n\"روي\": \"ر\",\n\"البحر\": \"الهجيني\",\n\"وصل\": \"لا يوجد\",\n\"حركة\": \"فتحة\",\n\"Status\": \"محسوم\",\n\"confidence\": 0.95,\n\"نوع\": \"نبطي\"\n}\n]\n\n---\n\n## ADDITIONAL INSTRUCTIONS\n\n* ALWAYS include the original 'line' field for traceability.\n* If multiple valid interpretations exist, choose the most conservative (lower confidence and \"غير محسوم\").\n* Keep qafiya minimal. If the editor needs fuller context, provide that elsewhere — not in the 'قافية' field.\n* If you cannot parse Arabic because of encoding issues, return error JSON as specified.\n* Output must be valid JSON only. Nothing outside the JSON array.\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        3216,
        1360
      ],
      "id": "7b7fa350-1a98-47fe-8829-6488d78d0df1",
      "name": "AI Agent4"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nif (!Array.isArray(items) || items.length === 0) {\n  return [{ json: { error: \"No input items\" } }];\n}\n\nconst result = items.flatMap(item => {\n  const outputStr = item.json?.output;\n  if (typeof outputStr !== \"string\" || !outputStr.trim()) {\n    return [{\n      json: {\n        Row_ID: item.json?.Row_ID ?? \"unknown\",\n        summary: {\n          error: \"empty_output\",\n          message: \"No output string found in this item.\"\n        }\n      }\n    }];\n  }\n\n  // Clean common LLM wrappers\n  const cleanJsonStr = outputStr.replace(/```json|```/g, \"\").trim();\n\n  let parsed;\n  try {\n    parsed = JSON.parse(cleanJsonStr);\n  } catch (e) {\n    return [{\n      json: {\n        Row_ID: item.json?.Row_ID ?? \"unknown\",\n        summary: {\n          error: \"json_parse_failed\",\n          message: e.message\n        }\n      }\n    }];\n  }\n\n  if (!Array.isArray(parsed)) {\n    return [{\n      json: {\n        Row_ID: item.json?.Row_ID ?? \"unknown\",\n        summary: {\n          error: \"invalid_format\",\n          message: \"Parsed output is not an array.\"\n        }\n      }\n    }];\n  }\n\n  return parsed.map(entry => {\n    if (!entry.line || typeof entry.line !== \"string\" || !entry.line.trim()) {\n      return {\n        json: {\n          Row_ID: String(entry.row_id ?? \"unknown\"),\n          summary: {\n            error: \"invalid_input\",\n            message: \"Expected raw Arabic poetry line in field 'line' or 'Poem_line'.\",\n            original: entry\n          }\n        }\n      };\n    }\n\n    // Valid entry\n    return {\n      json: {\n        Row_ID: String(entry.row_id ?? \"\"),\n        summary: { ...entry }\n      }\n    };\n  });\n});\n\nreturn result;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3520,
        1280
      ],
      "id": "6de65c5b-244c-417d-b4ac-373a49a68e4f",
      "name": "Code in JavaScript5"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        2960,
        1344
      ],
      "id": "30f07bc4-6643-4407-99cf-7f20cfeec71a",
      "name": "Loop Over Items5",
      "executeOnce": false
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w",
          "mode": "list",
          "cachedResultName": "FAZ_POEMS_REVIEW",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1836724327,
          "mode": "list",
          "cachedResultName": "Exact_lines",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit#gid=1836724327"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Row_ID": "={{ $json.summary.row_id }}",
            "قافية": "={{ $json.summary['قافية'] }}",
            "وصل": "={{ $json.summary['وصل'] }}",
            "روي": "={{ $json.summary['روي'] }}",
            "Status": "={{ $json.summary.Status }}",
            "confidence": "={{ $json.summary.confidence }}",
            "البحر": "={{ $json.summary['البحر'] }}",
            "حركة": "={{ $json.summary['حركة'] }}"
          },
          "matchingColumns": [
            "Row_ID"
          ],
          "schema": [
            {
              "id": "poem_id",
              "displayName": "poem_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Row_ID",
              "displayName": "Row_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Title_raw",
              "displayName": "Title_raw",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Poem_line_raw",
              "displayName": "Poem_line_raw",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "summary",
              "displayName": "summary",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Title_cleaned",
              "displayName": "Title_cleaned",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Poem_line_cleaned",
              "displayName": "Poem_line_cleaned",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "قافية",
              "displayName": "قافية",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "روي",
              "displayName": "روي",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "البحر",
              "displayName": "البحر",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "وصل",
              "displayName": "وصل",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "حركة",
              "displayName": "حركة",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Status",
              "displayName": "Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "confidence",
              "displayName": "confidence",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "شخص",
              "displayName": "شخص",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "sentiments",
              "displayName": "sentiments",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "أماكن",
              "displayName": "أماكن",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "أحداث",
              "displayName": "أحداث",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "مواضيع",
              "displayName": "مواضيع",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "تصنيف",
              "displayName": "تصنيف",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "useAppend": true
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        3744,
        1360
      ],
      "id": "c0d10bb6-f355-48c1-9414-9208f32d12d5",
      "name": "Append or update row in sheet4",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "OV5c4nxTt4atkgGW",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "content": "## Qafiya Enhancements\n\n"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2048,
        1344
      ],
      "typeVersion": 1,
      "id": "4fa8233b-66be-4c64-b4fe-a9dd2b2db6c9",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nconst grouped = items.reduce((acc, item) => {\n  const json = item.json;\n  // Create unique key combining poem_id and title to distinguish different poem instances\n  const uniqueKey = `${json.poem_id}-${json.Title_cleaned}`;\n\n  if (!acc[uniqueKey]) {\n    acc[uniqueKey] = {\n      poem_id: json.poem_id,\n      poem: json.Title_cleaned.trim(),\n      contents_tagged: []\n    };\n  }\n\n  const lineText = (json.Poem_line_cleaned || \"\").trim();\n  const rowId = json.Row_ID;\n\n  acc[uniqueKey].contents_tagged.push(`\"${rowId}\":\"${lineText}\"`);\n\n  return acc;\n}, {});\n\nconst result = Object.values(grouped);\n\nreturn result;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2752,
        1344
      ],
      "id": "e7fa0620-0e88-446d-baf5-b6d3909db191",
      "name": "Code in JavaScript6"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        3152,
        1568
      ],
      "id": "b6ac1b55-d55d-4184-9f6e-65fc5e2bcc5c",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "frYVvB9GNXXi6o6J",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w",
          "mode": "list",
          "cachedResultName": "FAZ_POEMS_REVIEW",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1031138690,
          "mode": "list",
          "cachedResultName": "Entity_extractions of Exact_search",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit#gid=1031138690"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "sentiments_Status",
              "lookupValue": "Ready"
            }
          ]
        },
        "options": {
          "returnFirstMatch": false
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2704,
        2320
      ],
      "id": "b47ee901-1423-4ba7-9396-cd35e998ecea",
      "name": "Get row(s) in sheet8",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "OV5c4nxTt4atkgGW",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=TASK: Analyze each line below individually.\n\nPoem title: {{ $json.poem }}\n\nLines to process:\n{{ $json.contents_tagged }}\n\nmake sure to grasp full poem and be coherent with entities through the poem lines and never lose track of the context.",
        "options": {
          "systemMessage": "=## SENTIMENT EXTRACTION SYSTEM PROMPT (STRICT 14-TAG LIMIT)\n\nYou are an AI assistant that extracts sentiment tags from Arabic poetry lines provided in a specific grouped format.  \nYou must be extremely strict: only pick tags from the **exact list of 14 canonical sentiment tags** below.  \n**NEVER** add new tags. **NEVER** normalize beyond mapping to these 14 tags.\n\n### Input Format\nThe input will be an array of objects, where each object represents one poem and contains a `contents_tagged` array.  \nEach entry in `contents_tagged` is a string in the exact format:  \n`\"Row_ID\":\"poetry line text\"`  \nExample:  \n```json\n[\n  {\n    \"poem_id\": 10,\n    \"poem\": \"شعب الامارات\",\n    \"contents_tagged\": [\n      \"\\\"108\\\":\\\"ابارك له في شهر نزل القران فيه انزال يضم من الليالي ليله القدر وفضايلها\\\"\",\n      \"\\\"120\\\":\\\"وعسي شعب الامارات العزيزه دوم ف احسن حال عسي دعواتهم ربي في شهر الخير يقبلها\\\"\"\n    ]\n  }\n]\n```\n\n### Strict Reference List (ONLY THESE 14 SENTIMENT TAGS ALLOWED)\n\n**1. حب** - Covers all variations of love, affection, admiration  \n**2. شوق** - Covers yearning, missing, longing for someone/something  \n**3. حزن** - Covers sadness, grief, sorrow, pain  \n**4. فرح** - Covers happiness, joy, delight  \n**5. غضب** - Covers anger, frustration, resentment  \n**6. خوف** - Covers fear, anxiety, apprehension  \n**7. أمل** - Covers hope, optimism, expectation  \n**8. صبر** - Covers patience, endurance, tolerance  \n**9. فخر** - Covers pride, honor, self-respect  \n**10. حكمة** - Covers wisdom, reflection, thoughtful consideration  \n**11. ندم** - Covers regret, remorse, sorrow for past actions  \n**12. تأمل** - Covers contemplation, reflection, deep thinking  \n**13. حنين** - Covers nostalgia, longing for the past  \n**14. غيرة** - Covers jealousy, envy, possessiveness  \n\n### Mapping Rules (MANDATORY)\n- **\"حب\", \"غلا\", \"وفاء\", \"عشق\", \"هيام\", \"ولع\", \"شغف\", \"حنان\", \"محبة\", \"تعلق\", \"تضحية\"** → **\"حب\"**\n- **\"شوق\", \"لهفة\", \"اشتياق\", \"تلهف\", \"تمنّي\", \"توق\", \"غربة\", \"فراق\", \"هجر\"** → **\"شوق\"**\n- **\"حزن\", \"ألم\", \"بكاء\", \"لوعة\", \"كآبة\", \"هم\", \"غم\", \"كرب\", \"أسى\", \"حسرة\", \"تأثر\", \"شقاء\", \"شجون\"** → **\"حزن\"**\n- **\"فرح\", \"سرور\", \"بهجة\", \"ابتهاج\", \"سعادة\", \"فرحة\"** → **\"فرح\"**\n- **\"غضب\", \"نفور\", \"استياء\", \"حقد\", \"لوم\", \"رفض\"** → **\"غضب\"**\n- **\"خوف\", \"رعب\", \"هلع\", \"جزع\", \"قلق\", \"وجل\", \"حذر\"** → **\"خوف\"**\n- **\"أمل\", \"تفاؤل\", \"تمنّي\", \"ترقّب\", \"توقع\"** → **\"أمل\"**\n- **\"صبر\", \"تحمل\", \"تسامح\", \"عزة نفس\", \"استمرار\"** → **\"صبر\"**\n- **\"فخر\", \"عزّة\", \"كرامة\", \"عظمة\", \"اعتزاز\", \"تفرد\"** → **\"فخر\"**\n- **\"حكمة\", \"تأمل\", \"تفكير\", \"مراجعة\", \"حساب\", \"نقد\", \"تصحيح\"** → **\"حكمة\"**\n- **\"ندم\", \"أسف\", \"حسرة\", \"تأنيب\"** → **\"ندم\"**\n- **\"تأمل\", \"تفكر\", \"تعمق\", \"خواطر\"** → **\"تأمل\"**\n- **\"حنين\", \"ذكرى\", \"شوق للماضي\", \"ضياع\"** → **\"حنين\"**\n- **\"غيرة\", \"حسد\", \"غيرة\", \"تسلط\"** → **\"غيرة\"**\n\n### Extraction Rules\n- Process **every** line in every `contents_tagged` array across all input items.\n- For **each line**, always extract its Row_ID.\n- Search the line text for any sentiment expression.\n- Map **ALL** sentiment expressions to **ONE OR MORE** of the 14 canonical tags above.\n- If one or more sentiments are found → create one output object **per sentiment tag** with the Row_ID and the canonical tag.\n- If **no sentiment** is found in a line → still output **one object** for that line with the Row_ID and an empty array as the sentiment value.\n- **NEVER** output more than 14 possible tags (only the 14 canonical tags listed above)\n- **NEVER** output compound tags like \"حب عميق\" - always map to \"حب\"\n\n### Output Format (JSON array of objects only – always one object per sentiment tag per line)\n```json\n[\n  {\n    \"Row_ID\": \"108\",\n    \"sentiment\": \"شوق\"\n  },\n  {\n    {\n    \"Row_ID\": \"108\",\n    \"sentiment\": \"حب\"\n  },\n  {\n    \"Row_ID\": \"120\",\n    \"sentiment\": []\n  }\n]\n```\nor when no sentiments anywhere:\n```json\n[\n  {\n    \"Row_ID\": \"108\",\n    \"sentiment\": []\n  },\n  {\n    \"Row_ID\": \"120\",\n    \"sentiment\": []\n  }\n]\n```\n\n**Important**: Every processed line must appear in the output with its Row_ID. Use `sentiment: []` when no sentiment is detected for that line. When multiple sentiments exist in a line, output multiple objects with the same Row_ID but different sentiment values.\n\nOnly output the final JSON array. No additional text, no explanations."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        3840,
        2336
      ],
      "id": "c478d1ff-a6dd-496e-8438-6c17f0144caa",
      "name": "AI Agent7"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nlet results = [];\n\nitems.forEach(item => {\n  let outputStr = item.json.output || \"\";\n\n  // Remove markdown code blocks if present\n  outputStr = outputStr.replace(/```json|```/g, '').trim();\n\n  // Normalize whitespace to make regex reliable\n  const normalized = outputStr.replace(/\\s+/g, ' ');\n\n  // Updated regex: matches \"Row_ID\": \"number\", \"sentiment\": ... \n  // where sentiment can be \"string\" or [] or [\"tag1\", \"tag2\"]\n  const objectRegex = /{\\s*\"Row_ID\"\\s*:\\s*\"([^\"]+)\"\\s*,\\s*\"sentiment\"\\s*:\\s*(\\[[^\\]]*\\]|\"[^\"]*\")\\s*}/g;\n\n  let match;\n  while ((match = objectRegex.exec(normalized)) !== null) {\n    const rowId = match[1].trim();\n    const sentimentRaw = match[2].trim();\n\n    let sentimentValue;\n\n    if (sentimentRaw === '[]') {\n      sentimentValue = [];\n    } else if (sentimentRaw.startsWith('[') && sentimentRaw.endsWith(']')) {\n      // Multiple sentiments as array\n      try {\n        sentimentValue = JSON.parse(sentimentRaw);\n      } catch (e) {\n        sentimentValue = [];\n      }\n    } else {\n      // Single sentiment string\n      sentimentValue = sentimentRaw.slice(1, -1); // remove surrounding quotes\n    }\n\n    results.push({\n      Row_ID: rowId,\n      sentiment: sentimentValue\n    });\n  }\n});\n\n// Return proper n8n items (one per extracted object)\nreturn results.map(result => ({ json: result }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4336,
        2432
      ],
      "id": "47f29b11-3d5a-49e8-a1f6-31b1f12cad38",
      "name": "Code in JavaScript11"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        3584,
        2320
      ],
      "id": "4af33262-d44b-4f43-9b3f-cb38b7bd66ea",
      "name": "Loop Over Items8",
      "executeOnce": false
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w",
          "mode": "list",
          "cachedResultName": "FAZ_POEMS_REVIEW",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1031138690,
          "mode": "list",
          "cachedResultName": "Entity_extractions of Exact_search",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit#gid=1031138690"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Row_ID": "={{ $json.Row_ID }}",
            "sentiments_Status": "Done",
            "sentiments": "={{ $json.sentiment }}"
          },
          "matchingColumns": [
            "Row_ID"
          ],
          "schema": [
            {
              "id": "poem_id",
              "displayName": "poem_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Row_ID",
              "displayName": "Row_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Title_raw",
              "displayName": "Title_raw",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Poem_line_raw",
              "displayName": "Poem_line_raw",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "summary",
              "displayName": "summary",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Title_cleaned",
              "displayName": "Title_cleaned",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Poem_line_cleaned",
              "displayName": "Poem_line_cleaned",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "قافية",
              "displayName": "قافية",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "روي",
              "displayName": "روي",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "البحر",
              "displayName": "البحر",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "وصل",
              "displayName": "وصل",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "حركة",
              "displayName": "حركة",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "confidence",
              "displayName": "confidence",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "comment",
              "displayName": "comment",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "شخص",
              "displayName": "شخص",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "sentiments",
              "displayName": "sentiments",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "sentiments_Status",
              "displayName": "sentiments_Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "أماكن",
              "displayName": "أماكن",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "أحداث",
              "displayName": "أحداث",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status",
              "displayName": "Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "دين",
              "displayName": "دين",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "religion_status",
              "displayName": "religion_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "مواضيع",
              "displayName": "مواضيع",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "تصنيف",
              "displayName": "تصنيف",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Column 19",
              "displayName": "Column 19",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "useAppend": true
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        4592,
        2432
      ],
      "id": "e67199a5-ab13-4403-a94b-54d24b96f6fe",
      "name": "Append or update row in sheet7",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "OV5c4nxTt4atkgGW",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "content": "## Sentimebts\nenhance"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2080,
        2304
      ],
      "typeVersion": 1,
      "id": "bb5e0946-25ae-4f9c-a7a9-4fa100af1063",
      "name": "Sticky Note8"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst grouped = items.reduce((acc, item) => {\n  const json = item.json;\n  // Create unique key combining poem_id and title to distinguish different poem instances\n  const uniqueKey = `${json.poem_id}-${json.Title_cleaned}`;\n  if (!acc[uniqueKey]) {\n    acc[uniqueKey] = {\n      poem_id: json.poem_id,\n      poem: json.Title_cleaned.trim(),\n      contents_tagged: []\n    };\n  }\n  const lineText = (json.Poem_line_cleaned || \"\").trim();\n  const rowId = json.Row_ID;  // This line is present in your original code\n  acc[uniqueKey].contents_tagged.push(`\"${rowId}\":\"${lineText}\"`);\n  return acc;\n}, {});\nconst result = Object.values(grouped);\nreturn result;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3376,
        2320
      ],
      "id": "5c659f4a-5454-4e0b-a409-6df0430d37cb",
      "name": "Code in JavaScript12"
    },
    {
      "parameters": {
        "model": "grok-4-1-fast-non-reasoning",
        "options": {
          "temperature": 0.2
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatXAiGrok",
      "typeVersion": 1,
      "position": [
        3776,
        2704
      ],
      "id": "10915c3b-f7a4-40a8-9954-64ce3fb7d82d",
      "name": "xAI Grok Chat Model6",
      "credentials": {
        "xAiApi": {
          "id": "8xuEmNzOUuELUh3f",
          "name": "xAi account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w",
          "mode": "list",
          "cachedResultName": "FAZ_POEMS_REVIEW",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1031138690,
          "mode": "list",
          "cachedResultName": "Entity_extractions of Exact_search",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit#gid=1031138690"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "subjects_status",
              "lookupValue": "Ready"
            }
          ]
        },
        "options": {
          "returnFirstMatch": false
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        5536,
        656
      ],
      "id": "5f1792c4-213f-4ce6-8dbb-3dbe13904109",
      "name": "Get row(s) in sheet9",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "OV5c4nxTt4atkgGW",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=TASK: Analyze each line below individually.\n\nPoem title: {{ $json.poem }}\n\nLines to process:\n{{ $json.contents_tagged }}\n\nmake sure to grasp full poem and be coherent with entities through the poem lines and never lose track of the context.",
        "options": {
          "systemMessage": "=# نظام تصنيف المواضيع الشعرية النبطي الإماراتي (النسخة المُحسّنة)\n\n**نظام الذكاء الاصطناعي المتخصص في تحليل المواضيع الشعرية:**\nأنت نظام متخصص في تحليل المواضيع الشعرية في القصائد النبطية الإماراتية، مع تركيز خاص على قصائد **الشيخ حمدان بن محمد آل مكتوم**. مهمتك الوحيدة هي استخراج **المواضيع** بدقة مع فهم السياق النبطي الإماراتي المميز. يجب أن تكون دقيقًا في التحليل وحازمًا في الالتزام بالفئات المحددة دون إضافة أي فئات جديدة.\n\n---\n\n## المخرجات المطلوبة (بنية موحدة)\n\n```json\n{\n  \"row_id\": \"رقم_السطر\",\n  \"topics\": [\"المواضيع_المستخرجة\"]\n}\n```\n\n---\n\n## التصنيف الضروري (20 فئة محددة - مُحسّن للسياق النبطي الإماراتي)\n\n1. **الحب والغزل**  \n   يغطي جميع أشكال الحب والعاطفة والغزل في الشعر النبطي  \n   *مثل: \"غزل\"، \"شوق\"، \"حب\"، \"عشق\"، \"هيام\"، \"ولع\"، \"شغف\"، \"جمال\"، \"رقة\"، \"ذوق\"*\n\n2. **الشوق والحنين**  \n   يغطي جميع أشكال الشوق والافتراق والحنين في الشعر النبطي  \n   *مثل: \"شوق\"، \"لهفة\"، \"اشتياق\"، \"تلهف\"، \"تمنّي\"، \"توق\"، \"غربة\"، \"فراق\"، \"هجر\"، \"حنين\"*\n\n3. **الفراق والهجر**  \n   يغطي جميع أشكال الفراق والهجر والوداع في الشعر النبطي  \n   *مثل: \"فراق\"، \"هجر\"، \"وداع\"، \"غياب\"، \"انفصال\"، \"خيانة\"*\n\n4. **الألم والحزن**  \n   يغطي جميع أشكال الألم والحزن والمعاناة في الشعر النبطي  \n   *مثل: \"ألم\"، \"حزن\"، \"بكاء\"، \"لوعة\"، \"كآبة\"، \"هم\"، \"غم\"، \"كرب\"، \"أسى\"، \"شقاء\"*\n\n5. **الوفاء والصبر**  \n   يغطي جميع أشكال الوفاء والصبر والتسامح في الشعر النبطي  \n   *مثل: \"وفاء\"، \"صبر\"، \"تحمل\"، \"تسامح\"، \"عزة نفس\"، \"استمرار\"، \"تضحية\"*\n\n6. **الجمال والعيون**  \n   يغطي جميع أشكال وصف الجمال والعيون في الشعر النبطي  \n   *مثل: \"جمال\"، \"رقة\"، \"ذوق\"، \"رقي\"، \"عيون\"، \"شفاه\"، \"نور\"، \"هيفاء\"*\n\n7. **حب الوطن**  \n   يغطي جميع أشكال حب الوطن والانتماء للإمارات  \n   *مثل: \"حب الوطن\"، \"الهوية\"، \"الانتماء\"، \"الولاء للوطن\"، \"هواء الإمارات\"، \"ثراها\"*\n\n8. **القيادة والزعماء**  \n   يغطي جميع الإشارات إلى قادة الإمارات (زايد، راشد، خليفة، محمد بن زايد، محمد بن راشد)  \n   *مثل: \"زايد\"، \"محمد بن زايد\"، \"محمد بن راشد\"، \"يابوراشد\"، \"بو خالد\"، \"القيادة\"، \"الرؤية\"*\n\n9. **الإمارات ودبي**  \n   يغطي جميع أشكال الفخر بالإمارات ودبي وتطورها  \n   *مثل: \"الإمارات\"، \"دبي\"، \"التقدم\"، \"التنمية\"، \"الريادة\"، \"التميز\"، \"التفوق\"*\n\n10. **المجد والعز**  \n    يغطي جميع أشكال المجد والعز والشرف في السياق النبطي  \n    *مثل: \"مجد\"، \"عزة\"، \"شجاعة\"، \"شموخ\"، \"فخر\"، \"كرامة\"، \"عظمة\"*\n\n11. **الشعر والإبداع**  \n    يغطي جميع المواضيع المتعلقة بالشعر والإبداع  \n    *مثل: \"الشعر\"، \"الإتقان\"، \"القافية\"، \"الإيقاع\"، \"الإتقان\"، \"الإبداع\"، \"الكتابة\"*\n\n12. **الطموح والنجاح**  \n    يغطي جميع أشكال الطموح والنجاح والإنجاز  \n    *مثل: \"طموح\"، \"نجاح\"، \"إنجاز\"، \"تفوق\"، \"تميز\"، \"ريادة\"، \"الوصول\"*\n\n13. **الزمن والقدر**  \n    يغطي جميع أشكال التأمل في الزمن والقدر  \n    *مثل: \"الزمن\"، \"القدر\"، \"الحياة\"، \"الموت\"، \"الفنا\"، \"الخلود\"، \"الحساب\"*\n\n14. **الطبيعة والخيل**  \n    يغطي جميع أشكال وصف الطبيعة والخيل في الشعر النبطي  \n    *مثل: \"الخيل\"، \"الصقور\"، \"الصحراء\"، \"الرمال\"، \"النخل\"، \"الشمس\"، \"القمر\"*\n\n15. **التراث النبطي**  \n    يغطي جميع أشكال التراث النبطي الإماراتي  \n    *مثل: \"التراث\"، \"العادات\"، \"التقاليد\"، \"القيم\"، \"الشجاعة\"، \"الكرم\"، \"الشيم\"*\n\n16. **الغيرة والعتاب**  \n    يغطي جميع أشكال الغيرة والعتاب والصراع العاطفي  \n    *مثل: \"غيرة\"، \"حسد\"، \"عتاب\"، \"نكد\"، \"لومة\"، \"صراع\"، \"تبرير\"*\n\n17. **الذكريات**  \n    يغطي جميع أشكال الذكريات والماضي في الشعر النبطي  \n    *مثل: \"ذكريات\"، \"ماضي\"، \"أيام\"، \"زمن\"، \"أحلام\"، \"تذكّر\"*\n\n18. **الفخر والشجاعة**  \n    يغطي جميع أشكال الفخر والشجاعة في السياق النبطي  \n    *مثل: \"فخر\"، \"شجاعة\"، \"شموخ\"، \"عزة\"، \"شجاعة\"، \"شجاعة\"، \"شجاعة\"*\n\n19. **الإيمان والدعاء**  \n    يغطي جميع المواضيع الدينية والعبادية  \n    *مثل: \"الإيمان\"، \"التقوى\"، \"العبادة\"، \"الدعاء\"، \"الذكر\"، \"التسبيح\"*\n\n20. **الصداقة والكرم**  \n    يغطي جميع أشكال الصداقة والكرم في الشعر النبطي  \n    *مثل: \"صداقة\"، \"كرم\"، \"عطاء\"، \"إيثار\"، \"وفاء\"، \"إخلاص\"، \"الضيافة\"*\n\n---\n\n## قواعد التصنيف الإلزامية (لا تفاوض)\n\n### أ. قواعد تصنيف المواضيع\n- **الحد الأقصى 20 فئة** - لا تضيف فئات جديدة\n- **الحد الأقصى 3 مواضيع لكل بيت** - لا تتجاوز 3 مواضيع في التصنيف الواحد\n- **السياق النبطي هو المحدد** - لا تصنف بناءً على كلمة واحدة، بل على السياق الكلي للبيت\n- **التمييز بين المواضيع المتشابهة** - مثلاً:\n  - \"الحب والغزل\" للعواطف الرومانسية\n  - \"الشوق والحنين\" للشوق العام والحنين للماضي\n  - \"الفراق والهجر\" للانفصال والوداع\n- **التركيز على السياق الإماراتي** - عندما تظهر مصطلحات مثل \"دبي\" أو \"الإمارات\" أو \"زايد\"، يجب تصنيف البيت تحت الفئة المقابلة\n- **التركيز على حمدان** - إذا ظهر اسم \"حمدان\" أو \"فزاع\"، يجب تصنيف البيت تحت \"القيادة والزعماء\" مع الإشارة إلى \"حمدان\" كجزء من السياق\n\n### ب. قواعد خاصة بقصائد حمدان بن محمد\n- **السياق القيادي** - إذا وردت إشارة إلى \"فزاع\" أو \"حمدان\" في سياق قيادي، يجب تصنيف البيت تحت \"القيادة والزعماء\"\n- **السياق النبطي** - إذا وردت مصطلحات مثل \"الخيل\" أو \"الصقور\" أو \"الصحراء\"، يجب تصنيف البيت تحت \"الطبيعة والخيل\" أو \"التراث النبطي\"\n- **السياق الوطني** - إذا وردت مصطلحات مثل \"الإمارات\" أو \"دبي\" أو \"هواء الإمارات\"، يجب تصنيف البيت تحت \"حب الوطن\" أو \"الإمارات ودبي\"\n- **السياق الشعري** - إذا وردت مصطلحات مثل \"القافية\" أو \"الإيقاع\" أو \"الشعر\"، يجب تصنيف البيت تحت \"الشعر والإبداع\"\n\n---\n\n## أمثلة تطبيقية مُحسّنة (للتوجيه)\n\n### المثال 1: قصيدة غزلية نبطية\n**المدخل:** `[\"غزل\",\"شوق\",\"حب\"]`  \n**المخرج الصحيح:**  \n```json\n{\n  \"row_id\": \"123\",\n  \"topics\": [\"الحب والغزل\", \"الشوق والحنين\"]\n}\n```\n**الشرح:**  \n- \"غزل\" و\"حب\" → \"الحب والغزل\"\n- \"شوق\" → \"الشوق والحنين\"\n- **لماذا لا \"الفراق والهجر\"؟** لأن النص لا يشير إلى الفراق\n\n### المثال 2: قصيدة وطنية عن زايد\n**المدخل:** `[\"تفوق الإمارات\",\"مقارنة بالعالم\"]`  \n**المخرج الصحيح:**  \n```json\n{\n  \"row_id\": \"124\",\n  \"topics\": [\"حب الوطن\", \"الإمارات ودبي\"]\n}\n```\n**الشرح:**  \n- \"تفوق الإمارات\" → \"حب الوطن\" و\"الإمارات ودبي\"\n- **لماذا لا \"المجد والعز\"؟** لأن النص يركز على تفوق الإمارات ككل\n\n### المثال 3: قصيدة عن حمدان\n**المدخل:** `[\"حمدان\",\"راشد\",\"القيادة\"]`  \n**المخرج الصحيح:**  \n```json\n{\n  \"row_id\": \"125\",\n  \"topics\": [\"القيادة والزعماء\"]\n}\n```\n**الشرح:**  \n- \"حمدان\" و\"راشد\" و\"القيادة\" → \"القيادة والزعماء\"\n- **لماذا لا \"المجد والعز\"؟** لأن النص يركز على القيادة تحديدًا\n\n### المثال 4: وصف طبيعي نبطي\n**المدخل:** `[\"الشمس\",\"القمر\",\"الورود\"]`  \n**المخرج الصحيح:**  \n```json\n{\n  \"row_id\": \"126\",\n  \"topics\": [\"الطبيعة والخيل\"]\n}\n```\n**الشرح:**  \n- \"الشمس\" و\"القمر\" و\"الورود\" → \"الطبيعة والخيل\"\n- **لماذا لا \"الجمال والعيون\"؟** لأن النص يصف عناصر طبيعية وليس جمال المحبوبة\n\n### المثال 5: قصيدة عن التراث النبطي\n**المدخل:** `[\"الخيل\",\"الصقور\",\"الصحراء\"]`  \n**المخرج الصحيح:**  \n```json\n{\n  \"row_id\": \"127\",\n  \"topics\": [\"الطبيعة والخيل\", \"التراث النبطي\"]\n}\n```\n**الشرح:**  \n- \"الخيل\" و\"الصقور\" و\"الصحراء\" → \"الطبيعة والخيل\" و\"التراث النبطي\"\n- **لماذا لا \"الجمال والعيون\"؟** لأن هذه الرموز لها دلالة تراثية في الشعر النبطي\n\n### المثال 6: قصيدة عن القيادة\n**المدخل:** `[\"القيادة\",\"رؤية\"]`  \n**المخرج الصحيح:**  \n```json\n{\n  \"row_id\": \"128\",\n  \"topics\": [\"القيادة والزعماء\"]\n}\n```\n**الشرح:**  \n- \"القيادة\" و\"الرؤية\" → \"القيادة والزعماء\"\n- **لماذا لا \"الطموح والنجاح\"؟** لأن النص يركز على القيادة تحديدًا\n\n### المثال 7: قصيدة عن الذكريات\n**المدخل:** `[\"ذكريات\",\"شوق\",\"فقدان\"]`  \n**المخرج الصحيح:**  \n```json\n{\n  \"row_id\": \"129\",\n  \"topics\": [\"الشوق والحنين\", \"الذكريات\"]\n}\n```\n**الشرح:**  \n- \"ذكريات\" → \"الذكريات\"\n- \"شوق\" و\"فقدان\" → \"الشوق والحنين\"\n- **لماذا لا \"الفراق والهجر\"؟** لأن النص يركز على الذكريات والحنين للماضي\n\n---\n\n## قائمة التحقق من الصحة\n\n✓ **الحد الأقصى 20 موضوع** - لا تتجاوز الفئات المحددة  \n✓ **الحد الأقصى 3 مواضيع** - لا تتجاوز 3 مواضيع لكل بيت  \n✓ **السياق النبطي هو المحدد** - لا تصنف بناءً على كلمة واحدة  \n✓ **التمييز بين المواضيع المتشابهة** - تجنب التداخل غير الضروري  \n✓ **التركيز على السياق الإماراتي** - أولوية للفئات الإماراتية عند التداخل  \n✓ **التركيز على حمدان** - إذا ظهر \"حمدان\" أو \"فزاع\"، يجب التصنيف تحت \"القيادة والزعماء\"  \n✓ **الحفاظ على Row_ID** - يجب مطابقة القيمة الأصلية تمامًا  \n\n---\n\n## بروتوكولات الطوارئ\n\n- **إذا كان السياق غامضًا** → لا تدرج الموضوع في المخرجات (الأمان أولًا)\n- **إذا كانت الكلمة في سياق نبطي غير واضح** → ابحث عن الرموز النبطية (الخيل، الصقور، الصحراء)\n- **إذا تعارضت المواضيع** → راجع السياق وحدد ما يناسبه\n- **إذا كانت القيمة خارج التصنيف** → تجاهلها تمامًا (لا تخلق فئات جديدة)\n- **إذا كانت الضمائر غامضة** → افحص السياق الكامل قبل التصنيف\n- **إذا ظهر \"حمدان\" أو \"فزاع\"** → صنف تحت \"القيادة والزعماء\" تلقائيًا\n\n---\n\n**التعليمات النهائية:**  \nأنت الآن تعمل كـ **نظام تحليل مواضيع شعري نبطي إماراتي متخصص**. مهمتك هي تحويل **كل** الأبيات إلى تحليل دقيق يشمل المواضيع مع فهم السياق النبطي الإماراتي. **لا تستخرج كلمات مباشرة** - المخرجات تشمل **أسماء الفئات فقط**. **السياق النبطي هو الملك** - إذا لم تكن متأكدًا من السياق، لا تدرج الفئة في المخرجات.\n\n**ابدأ المعالجة الآن. المخرجات JSON فقط. لا شرح. لا نص إضافي.**"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        6672,
        672
      ],
      "id": "73861c9b-d28e-401c-8f06-faa7b4138ac2",
      "name": "AI Agent8"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nlet results = [];\n\nitems.forEach(item => {\n  let outputStr = item.json.output || \"\";\n  \n  // Remove markdown code blocks like ```json or ```\n  outputStr = outputStr.replace(/```(?:json)?|```/g, '').trim();\n  \n  // Normalize whitespace (optional, helps regex)\n  const normalized = outputStr.replace(/\\s+/g, ' ');\n  \n  // Updated regex to match the actual keys: \"row_id\" and \"topics\"\n  const objectRegex = /{\\s*\"row_id\"\\s*:\\s*\"([^\"]+)\"\\s*,\\s*\"topics\"\\s*:\\s*(\\[[^\\]]*\\])\\s*}/g;\n  \n  let match;\n  while ((match = objectRegex.exec(normalized)) !== null) {\n    const rowId = match[1].trim();\n    const topicsRaw = match[2].trim();  // This is always an array string like [\"...\", \"...\"]\n    \n    let topicsValue = [];\n    if (topicsRaw && topicsRaw.startsWith('[') && topicsRaw.endsWith(']')) {\n      try {\n        topicsValue = JSON.parse(topicsRaw);\n      } catch (e) {\n        topicsValue = [];\n      }\n    }\n    \n    results.push({\n      row_id: rowId,       // keep the original key name, or change to Row_ID if you prefer\n      topics: topicsValue\n    });\n  }\n});\n\n// Return one n8n item per extracted object\nreturn results.map(result => ({ json: result }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7168,
        768
      ],
      "id": "91cb7f66-7106-4f86-a372-24a73c7b66b5",
      "name": "Code in JavaScript13"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        6416,
        656
      ],
      "id": "a8bbed33-9494-4a8f-9ac6-4373dce1fae6",
      "name": "Loop Over Items9",
      "executeOnce": false
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w",
          "mode": "list",
          "cachedResultName": "FAZ_POEMS_REVIEW",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1031138690,
          "mode": "list",
          "cachedResultName": "Entity_extractions of Exact_search",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit#gid=1031138690"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Row_ID": "={{ $json.row_id }}",
            "مواضيع": "={{ $json.topics }}",
            "subjects_status": "Done"
          },
          "matchingColumns": [
            "Row_ID"
          ],
          "schema": [
            {
              "id": "poem_id",
              "displayName": "poem_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Row_ID",
              "displayName": "Row_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Title_raw",
              "displayName": "Title_raw",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Poem_line_raw",
              "displayName": "Poem_line_raw",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "summary",
              "displayName": "summary",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Title_cleaned",
              "displayName": "Title_cleaned",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Poem_line_cleaned",
              "displayName": "Poem_line_cleaned",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "قافية",
              "displayName": "قافية",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "روي",
              "displayName": "روي",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "البحر",
              "displayName": "البحر",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "وصل",
              "displayName": "وصل",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "حركة",
              "displayName": "حركة",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "confidence",
              "displayName": "confidence",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "comment",
              "displayName": "comment",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "شخص",
              "displayName": "شخص",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "sentiments",
              "displayName": "sentiments",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "sentiments_Status",
              "displayName": "sentiments_Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "أماكن",
              "displayName": "أماكن",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "أحداث",
              "displayName": "أحداث",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status",
              "displayName": "Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "دين",
              "displayName": "دين",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "religion_status",
              "displayName": "religion_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "مواضيع",
              "displayName": "مواضيع",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "subjects_status",
              "displayName": "subjects_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "تصنيف",
              "displayName": "تصنيف",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Column 19",
              "displayName": "Column 19",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "useAppend": true
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        7424,
        768
      ],
      "id": "16ea4c39-465f-45af-99ad-2d821a106e7e",
      "name": "Append or update row in sheet8",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "OV5c4nxTt4atkgGW",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "content": "## Subjects"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        4912,
        640
      ],
      "typeVersion": 1,
      "id": "cd7e7940-7284-46bb-9f11-7825b856d10c",
      "name": "Sticky Note9"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst grouped = items.reduce((acc, item) => {\n  const json = item.json;\n  // Create unique key combining poem_id and title to distinguish different poem instances\n  const uniqueKey = `${json.poem_id}-${json.Title_cleaned}`;\n  if (!acc[uniqueKey]) {\n    acc[uniqueKey] = {\n      poem_id: json.poem_id,\n      poem: json.Title_cleaned.trim(),\n      contents_tagged: []\n    };\n  }\n  const lineText = (json.Poem_line_cleaned || \"\").trim();\n  const rowId = json.Row_ID;  // This line is present in your original code\n  acc[uniqueKey].contents_tagged.push(`\"${rowId}\":\"${lineText}\"`);\n  return acc;\n}, {});\nconst result = Object.values(grouped);\nreturn result;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6208,
        656
      ],
      "id": "62f8f6e0-cc4c-416b-a190-110549d3962c",
      "name": "Code in JavaScript14"
    },
    {
      "parameters": {
        "model": "grok-4-1-fast-non-reasoning",
        "options": {
          "temperature": 0.2
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatXAiGrok",
      "typeVersion": 1,
      "position": [
        6608,
        1040
      ],
      "id": "13324012-614c-4d94-afbc-d39c652360a0",
      "name": "xAI Grok Chat Model7",
      "credentials": {
        "xAiApi": {
          "id": "8xuEmNzOUuELUh3f",
          "name": "xAi account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w",
          "mode": "list",
          "cachedResultName": "FAZ_POEMS_REVIEW",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1031138690,
          "mode": "list",
          "cachedResultName": "Entity_extractions of Exact_search",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit#gid=1031138690"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "places_Status",
              "lookupValue": "Ready"
            }
          ]
        },
        "options": {
          "returnFirstMatch": false
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        5568,
        1232
      ],
      "id": "2595191d-fb8e-439b-be4f-3a8817cef8ea",
      "name": "Get row(s) in sheet10",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "OV5c4nxTt4atkgGW",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=TASK: Analyze each line below individually.\n\nPoem title: {{ $json.poem }}\n\nLines to process:\n{{ $json.contents_tagged }}\n\nmake sure to grasp full poem and be coherent with entities through the poem lines and never lose track of the context.",
        "options": {
          "systemMessage": "=\nأنت خبير متخصص في استخراج كيانات الأماكن من الشعر النبطي الإماراتي بدقة عالية.\n\nنظام التصنيف الإلزامي (8 فئات فقط - لا تستخدم أي فئة خارج هذه القائمة):\n\n1. أراضي_إماراتية          → الأراضي والمواقع المرتبطة بالإمارات (مثل: الإمارات، دبي، أبوظبي، الثرا، التراب، الوطن، الأرض في سياق إماراتي، الواحة)\n2. مدن_وأماكن_عربية       → مدن وبلدان عربية أخرى (مثل: الرياض، المنامة، الكويت، الدوحة، مكة خارج السياق الديني)\n3. طبيعة_عامة              → عناصر طبيعية عامة في سياق حرفي (مثل: البحر، الصحراء، السماء، الرمال، النخيل، الرياح، المطر)\n4. مواقع_نبطية             → مواقع تراثية نبطية (مثل: المرابيع، السيح، الشعيب، الهضاب، الوديان، الجبال، المطاليع، العيون)\n5. مواقع_دينية             → أماكن دينية إسلامية (مثل: مكة، المدينة، المسجد الحرام، عرفات، بيت المقدس)\n6. معالم_إماراتية          → معالم حديثة في الإمارات (مثل: برج خليفة، أبراج سمت، نخلة جميرا، مسجد الشيخ زايد)\n7. مواقع_اجتماعية         → أماكن اجتماعية (مثل: الديوانية، المجلس، السوق)\n8. أماكن_مجردة             → أماكن مجازية أو مجردة (مثل: المسيرة، الطريق، الزمان، الديار، البحر في سياق مجازي)\n\nالقواعد الإلزامية (يجب اتباعها بدقة تامة):\n- استخرج المكان فقط إذا كان له سياق مكاني واضح.\n- إذا كان المكان إماراتيًا → أولوية مطلقة لتصنيفه تحت \"أراضي_إماراتية\".\n- إذا كان المكان نبطيًا تقليديًا → \"مواقع_نبطية\".\n- إذا كان مجازيًا أو رمزيًا → \"أماكن_مجردة\".\n- لا تتجاوز 5 أماكن لكل بيت شعري.\n- لا تستخدم أي نوع خارج الـ 8 فئات أعلاه.\n\nأمثلة توضيحية صارمة:\n\n1. البيت: \"من غراءب هالحياه ارجو من الله السكينه فوق الارض ورحمته اكبر طموحاتي تحتها\"\n   → {\"row_id\": \"1\", \"places\": [{\"name\": \"الأرض\", \"type\": \"أراضي_إماراتية\"}]}\n\n2. البيت: \"خل الامل يصاحبك ف المسيره واطمح طموح يحفزك للتقدام\"\n   → {\"row_id\": \"1\", \"places\": [{\"name\": \"المسيرة\", \"type\": \"أماكن_مجردة\"}]}\n\n3. البيت: \"البحر والا الموت .. انا كلاهم اغرقهم واحذفهم ليابس الريع\"\n   → {\"row_id\": \"1\", \"places\": [{\"name\": \"البحر\", \"type\": \"أماكن_مجردة\"}]}\n\n4. البيت: \"للحين بعده ماوصل مستواهم لمستوي شقر الحرار المطاليع\"\n   → {\"row_id\": \"1\", \"places\": [{\"name\": \"المطاليع\", \"type\": \"مواقع_نبطية\"}]}\n\n5. البيت: \"حبيبتي حالي من الشوق داني اشرق بحبك .. واعود اغرب\"\n   → {\"row_id\": \"1\", \"places\": []}\n\n6. البيت: \"في دبي قلبي ساكن وفي الثرا روحي دفينة\"\n   → {\"row_id\": \"1\", \"places\": [{\"name\": \"دبي\", \"type\": \"أراضي_إماراتية\"}, {\"name\": \"الثرا\", \"type\": \"أراضي_إماراتية\"}]}\n\nصيغة الإخراج الوحيدة المسموح بها:\n- JSON صالح فقط.\n- داخل كتلة كود markdown واحدة ```json ... ```\n- بدون أي نص إضافي، شرح، تحليل، تعليق، أو كلام عربي خارج الـ JSON.\n\nالإخراج يجب أن يكون دائمًا بهذا الشكل بالضبط:\n\n```json\n{\n  \"row_id\": \"1\",\n  \"places\": []\n}\n```\n\nأو\n\n```json\n{\n  \"row_id\": \"1\",\n  \"places\": [\n    {\"name\": \"اسم المكان\", \"type\": \"الفئة_الصحيحة\"}\n  ]\n}\n```\n\nلا تكتب أي شيء آخر أبدًا. لا تحليل، لا **التحليل**، لا نقاط، لا عبارات مثل \"لا توجد أماكن\".\nابدأ مباشرة بـ ```json وأنهِ بـ ```"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        6304,
        1248
      ],
      "id": "591a7002-6204-466b-9281-2ca2d0e28f96",
      "name": "AI Agent9"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nlet results = [];\n\nitems.forEach(item => {\n    let outputStr = item.json.output || \"\";\n    if (!outputStr) return;\n\n    // Extract all ```json ... ``` blocks\n    const jsonBlocks = [...outputStr.matchAll(/```(?:json)?\\s*([\\s\\S]*?)```/g)];\n    if (jsonBlocks.length === 0) jsonBlocks.push([outputStr, outputStr]);\n\n    jsonBlocks.forEach(match => {\n        let block = match[1].trim();\n        if (!block) return;\n\n        try {\n            const parsed = JSON.parse(block);\n\n            // Case 1: Array of objects [{ row_id, topics/places }, ...]\n            if (Array.isArray(parsed)) {\n                parsed.forEach(obj => {\n                    if (!obj.row_id) return;\n                    const result = { row_id: String(obj.row_id) };\n                    Object.keys(obj).forEach(k => {\n                        if (Array.isArray(obj[k])) result[k] = obj[k];\n                    });\n                    results.push(result);\n                });\n            }\n            // Case 2: Object with row IDs as keys { \"2734\": [...], ... }\n            else if (parsed && typeof parsed === \"object\") {\n                if (parsed.row_id) {\n                    // Single object with row_id\n                    const result = { row_id: String(parsed.row_id) };\n                    Object.keys(parsed).forEach(k => {\n                        if (Array.isArray(parsed[k])) result[k] = parsed[k];\n                    });\n                    results.push(result);\n                } else {\n                    // Object-of-arrays with row IDs as keys\n                    Object.keys(parsed).forEach(key => {\n                        const val = Array.isArray(parsed[key]) ? parsed[key] : [];\n                        results.push({ row_id: key, topics: val });\n                    });\n                }\n            }\n        } catch (e) {\n            // Skip invalid JSON\n        }\n    });\n});\n\n// Return as n8n items\nreturn results.map(r => ({ json: r }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6688,
        1344
      ],
      "id": "e018822c-e61d-4ef6-ae40-f1c2bc9d8854",
      "name": "Code in JavaScript15"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        6048,
        1232
      ],
      "id": "87a129b6-b908-4bbf-97e2-f53d2349e299",
      "name": "Loop Over Items10",
      "executeOnce": false
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w",
          "mode": "list",
          "cachedResultName": "FAZ_POEMS_REVIEW",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1031138690,
          "mode": "list",
          "cachedResultName": "Entity_extractions of Exact_search",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit#gid=1031138690"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Row_ID": "={{ $json.row_id }}",
            "أماكن": "={{ $json.places }}",
            "places_Status": "Done"
          },
          "matchingColumns": [
            "Row_ID"
          ],
          "schema": [
            {
              "id": "poem_id",
              "displayName": "poem_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Row_ID",
              "displayName": "Row_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Title_raw",
              "displayName": "Title_raw",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Poem_line_raw",
              "displayName": "Poem_line_raw",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "summary",
              "displayName": "summary",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Title_cleaned",
              "displayName": "Title_cleaned",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Poem_line_cleaned",
              "displayName": "Poem_line_cleaned",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "قافية",
              "displayName": "قافية",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "روي",
              "displayName": "روي",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "البحر",
              "displayName": "البحر",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "وصل",
              "displayName": "وصل",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "حركة",
              "displayName": "حركة",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "confidence",
              "displayName": "confidence",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "comment",
              "displayName": "comment",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "شخص",
              "displayName": "شخص",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "sentiments",
              "displayName": "sentiments",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "sentiments_Status",
              "displayName": "sentiments_Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "أماكن",
              "displayName": "أماكن",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "places_Status",
              "displayName": "places_Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "أحداث",
              "displayName": "أحداث",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status",
              "displayName": "Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "دين",
              "displayName": "دين",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "religion_status",
              "displayName": "religion_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "مواضيع",
              "displayName": "مواضيع",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "subjects_status",
              "displayName": "subjects_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "تصنيف",
              "displayName": "تصنيف",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Column 19",
              "displayName": "Column 19",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "useAppend": true
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        6944,
        1344
      ],
      "id": "50d38adb-a394-4abc-8589-36d7815def30",
      "name": "Append or update row in sheet9",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "OV5c4nxTt4atkgGW",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "content": "## places"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        4944,
        1216
      ],
      "typeVersion": 1,
      "id": "40e24b9e-4570-4221-aab1-31a6cc660a4c",
      "name": "Sticky Note10"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst grouped = items.reduce((acc, item) => {\n  const json = item.json;\n  // Create unique key combining poem_id and title to distinguish different poem instances\n  const uniqueKey = `${json.poem_id}-${json.Title_cleaned}`;\n  if (!acc[uniqueKey]) {\n    acc[uniqueKey] = {\n      poem_id: json.poem_id,\n      poem: json.Title_cleaned.trim(),\n      contents_tagged: []\n    };\n  }\n  const lineText = (json.Poem_line_cleaned || \"\").trim();\n  const rowId = json.Row_ID;  // This line is present in your original code\n  acc[uniqueKey].contents_tagged.push(`\"${rowId}\":\"${lineText}\"`);\n  return acc;\n}, {});\nconst result = Object.values(grouped);\nreturn result;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5840,
        1232
      ],
      "id": "8014ad7d-3a87-4577-8735-ee03e4ebac92",
      "name": "Code in JavaScript16"
    },
    {
      "parameters": {
        "model": "grok-4-1-fast-non-reasoning",
        "options": {
          "temperature": 0.2
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatXAiGrok",
      "typeVersion": 1,
      "position": [
        6224,
        1568
      ],
      "id": "a1e83801-aaff-4248-862a-c11d70a0e14b",
      "name": "xAI Grok Chat Model8",
      "credentials": {
        "xAiApi": {
          "id": "8xuEmNzOUuELUh3f",
          "name": "xAi account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://ezcbshyresjinfyscals.supabase.co/functions/v1/word-stats-preview",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer sb_publishable_FjlIO4TFYGQZJpQm-PosDw_hk2AFmeN"
            },
            {
              "name": "apikey",
              "value": "sb_publishable_FjlIO4TFYGQZJpQm-PosDw_hk2AFmeN"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "query_text",
              "value": "محمد"
            },
            {
              "name": "result_limit",
              "value": "30"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1280,
        1936
      ],
      "id": "839cddaa-12e3-4958-a045-338dbc28a588",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://ezcbshyresjinfyscals.supabase.co/functions/v1/word-stats-preview",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "sb_publishable_FjlIO4TFYGQZJpQm-PosDw_hk2AFmeN"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "query_text",
              "value": "محمد"
            },
            {
              "name": "result_limit",
              "value": "30"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1280,
        2256
      ],
      "id": "a3cb704a-f825-426f-947b-f22afed4b132",
      "name": "HTTP Request1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://ezcbshyresjinfyscals.supabase.co/functions/v1/word-stats-preview",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer sb_publishable_FjlIO4TFYGQZJpQm-PosDw_hk2AFmeN"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "query_text",
              "value": "محمد"
            },
            {
              "name": "result_limit",
              "value": "30"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1280,
        2496
      ],
      "id": "0c7e2e48-a349-4ff1-b3b6-d128e2180160",
      "name": "HTTP Request2",
      "disabled": true
    },
    {
      "parameters": {
        "model": "grok-4-1-fast-non-reasoning",
        "options": {
          "temperature": 0.2
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatXAiGrok",
      "typeVersion": 1,
      "position": [
        6256,
        2288
      ],
      "id": "c18adef7-a677-4860-92ca-85a0ea3ec5da",
      "name": "xAI Grok Chat Model",
      "credentials": {
        "xAiApi": {
          "id": "8xuEmNzOUuELUh3f",
          "name": "xAi account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w",
          "mode": "list",
          "cachedResultName": "FAZ_POEMS_REVIEW",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1031138690,
          "mode": "list",
          "cachedResultName": "Entity_extractions of Exact_search",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit#gid=1031138690"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "religion_status",
              "lookupValue": "Ready"
            }
          ]
        },
        "options": {
          "returnFirstMatch": false
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        5568,
        1920
      ],
      "id": "bd9a1215-6b6b-4833-b0cd-757409585df4",
      "name": "Get row(s) in sheet12",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "OV5c4nxTt4atkgGW",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=TASK: Analyze each line below individually.\n\nPoem title: {{ $json.poem }}\n\nLines to process:\n{{ $json.contents_tagged }}\n\nmake sure to grasp full poem and be coherent with entities through the poem lines and never lose track of the context.\neven if the poet says \"هو، هناك ، معه،...\"make sure you grasp the context from other lines",
        "options": {
          "systemMessage": "=# نظام استخراج الكيانات الدينية المُحسّن (النسخة المُعدَّلة)\n\n**تعريف دور النظام:**  \nأنت **مصنف دقيق للمفاهيم الدينية** يعمل ضمن قيود تطبيق الهاتف الإماراتي. مهمتك الوحيدة هي تحديد ما إذا كانت الأبيات الشعرية تحتوي على أي محتوى ديني، وتصنيفه إلى **7 فئات رئيسية باللغة العربية** فقط. يجب أن تكون دقيقًا في تحديد الفئة الصحيحة، ولا تضيف أي فئات جديدة أبدًا.\n\n---\n\n### **التصنيف الديني الإلزامي (7 فئات فقط - بالعربية)**\n\nيجب رسم **جميع** المحتوى الديني إلى هذه الفئات السبع **باللغة العربية الفصحى**:\n\n```json\n{\n  \"التصنيف_الديني\": {\n    \"الله\": [\"الله\", \"رب\", \"خالق\", \"رب العالمين\", \"الرحمن\", \"الرحيم\", \"الله سبحانه\", \"إله العالمين\", \"ذو الجلال\", \"رب العرش\", \"الواحد الباري\", \"المعبود\", \"ربنا\", \"لله\", \"بالله\", \"لله درك\", \"الله يعلم\", \"الله سبحانه وتعالى\", \"والله\", \"الله أكبر\", \"يارب\", \"ربك\", \"إلهي\", \"يا إلهي\", \"يا رب\", \"يالله\", \"حبيبي محمد\", \"اله\", \"إله\"],\n    \"العبادة\": [\"صلاة\", \"صيام\", \"حج\", \"زكاة\", \"قرآن\", \"ذكر\", \"دعاء\", \"تقوى\", \"إيمان\", \"توبة\", \"استغفار\", \"تسبيح\", \"شهادة\", \"أذان\", \"خطبة\", \"وضوء\", \"صوم\", \"صلاة الجمعة\", \"قيام الليل\", \"خشوع\", \"صايم\", \"يصلي\", \"يدعو\", \"يتوب\", \"يصوم\", \"يقرأ\", \"يستغفر\", \"يسبح\", \"يشهد\", \"يؤذن\", \"يقرأ القرآن\", \"يخشع\", \"يقوم الليل\"],\n    \"الأنبياء\": [\"النبي محمد\", \"رسول الله\", \"خاتم الأنبياء\", \"سيدنا محمد\", \"النبي\", \"رسول\", \"نبي الله\", \"محمد\", \"إبراهيم\", \"موسى\", \"عيسى\", \"نوح\", \"صالح\", \"شعيب\", \"يونس\", \"يوسف\", \"داود\", \"سليمان\", \"أيوب\", \"زكريا\", \"يحيى\", \"إدريس\", \"هود\", \"ذو الكفل\", \"إلياس\", \"الياس\", \"اليسع\", \"ذو القرنين\"],\n    \"الكتب_المقدسة\": [\"القرآن\", \"السنة\", \"الكتاب المنزل\", \"المصحف\", \"الذكر الحكيم\", \"الإنجيل\", \"التوراة\", \"الزبور\", \"الصحف\", \"الوحي\", \"الرسالة\", \"الهدى\", \"النور\", \"الحكمة\", \"الفurقان\", \"الذِّكر\"],\n    \"الأماكن_المقدسة\": [\"مكة\", \"المدينة\", \"الأقصى\", \"مسجد زايد\", \"بيت الله\", \"الحرم\", \"عرفات\", \"المسجد\", \"الكعبة\", \"الحرم المكي\", \"الحرم النبوي\", \"المسجد الأقصى\", \"بيت المقدس\", \"القدس\", \"الحرم الشريف\", \"المسجد الحرام\", \"مسجد النبي\", \"مسجد القبلتين\", \"مسجد القيامة\", \"مسجد بيت المقدس\", \"مسجد فلسطين\"],\n    \"المناسبات_الدينية\": [\"رمضان\", \"عيد الفطر\", \"عيد الأضحى\", \"ليلة القدر\", \"الحج\", \"وقفة عرفة\", \"المولد النبوي\", \"الشهر الفضيل\", \"العشر الأواخر\", \"ليلة النصف من شعبان\", \"يوم عاشوراء\", \"الإسراء والمعراج\", \"أيام التشريق\", \"يوم عرفة\", \"يوم النحر\", \"يوم التروية\"],\n    \"المفاهيم_الإيمانية\": [\"الجنة\", \"النار\", \"اليوم الآخر\", \"القدر\", \"الشيطان\", \"إبليس\", \"الملائكة\", \"الغفران\", \"الرحمة\", \"الكفر\", \"الإسلام\", \"المسلمين\", \"الأنبياء\", \"الرسل\", \"اليوم القيامة\", \"الصراط المستقيم\", \"الميزان\", \"الحشر\", \"النشر\", \"الحساب\", \"الجزاء\", \"الثواب\", \"العقاب\", \"الصراط\", \"الصحف\", \"الكتاب\", \"الشهادة\", \"الخلود\", \"الأبدية\", \"الخلود في النار\", \"الأبدية في الجنة\"]\n  }\n}\n```\n\n---\n\n### **قواعد الاستخراج الإلزامية (غير قابلة للتفاوض)**\n\n#### **القاعدة 1: مبدأ التصنيف الوحيد (الأهم)**\n- **لا تخرج أبدًا عن الفئات السبع المذكورة أعلاه**\n- **لا تدرج أي مصطلح ديني مباشر في المخرجات** (مثل: \"رب\"،\"اله\"،\"معبود\"،\"تسبيح\"،\"سجود\"، \"صلاة\"، \"رمضان\")\n- **المخرجات تشمل فقط أسماء الفئات السبع** (مثل: \"الله\"، \"عبادة\") عندما توجد مصطلحات تنتمي لهذه الفئات في النص\n- **مثال خاطئ**: `{\"الديني\": [\"الله\", \"صلاة\"]}`  \n- **مثال صحيح**: `{\"الديني\": [\"الله\", \"عبادة\"]}`\n\n#### **القاعدة 2: السياق هو المحدد الوحيد (لا مجال للتأويل)**\n- **إذا وُجد مصطلح ينتمي لفئة ما في النص → أضف اسم الفئة إلى المخرجات**\n- **إذا لم يُوجد أي مصطلح ديني → اترك المخرجات فارغة**\n- **إذا كان المصطلح في سياق غير ديني (مثل سياق رومانسي) → تجاهله تمامًا**\n  - مثال: \"اسمك يزين لساني\" → \"اسمك\" هنا ليس دينيًا → لا تضيف \"الله\" إلى المخرجات\n  - مثال: \"رضاها أغلى من كل شيء\" → \"رضاها\" هنا ليس دينيًا → لا تضيف \"الله\" إلى المخرجات\n\n#### **القاعدة 3: قواعد التحديد المطلقة (لا تغيير)**\n- **إذا وُجد أي مصطلح من مصطلحات \"الله\" → أضف \"الله\" إلى المخرجات**\n- **إذا وُجد أي مصطلح من مصطلحات \"العبادة\" → أضف \"العبادة\" إلى المخرجات**\n- **إذا وُجد أي مصطلح من مصطلحات \"الأنبياء\" → أضف \"الأنبياء\" إلى المخرجات**\n- **إذا وُجد أي مصطلح من مصطلحات \"الكتب_المقدسة\" → أضف \"الكتب_المقدسة\" إلى المخرجات**\n- **إذا وُجد أي مصطلح من مصطلحات \"الأماكن_المقدسة\" → أضف \"الأماكن_المقدسة\" إلى المخرجات**\n- **إذا وُجد أي مصطلح من مصطلحات \"المناسبات_الدينية\" → أضف \"المناسبات_الدينية\" إلى المخرجات**\n- **إذا وُجد أي مصطلح من مصطلحات \"المفاهيم_الإيمانية\" → أضف \"المفاهيم_الإيمانية\" إلى المخرجات**\n\n#### **القاعدة 4: تنسيق المخرجات (دقيق ومحدد)**\n**المخرجات يجب أن تكون بهذا التنسيق بالضبط:**\n```json\n{\n  \"row_id\": \"123\",\n  \"الديني\": [\"الله\", \"عبادة\", \"المناسبات_الدينية\"]\n}\n```\n\n**لا تضيف أي حقول إضافية، لا تدرج درجات الثقة، لا تدرج المصادر.**\n\n---\n\n### **قائمة التحقق من الصحة (يجب اجتيازها)**\n\n✓ **اللغة العربية فقط** - جميع الفئات بالعربية الفصحى  \n✓ **الحد الأقصى 7 فئات** - لا تضيف فئات جديدة  \n✓ **المخرجات تشمل أسماء الفئات فقط** - لا تدرج مصطلحات دينية مباشرة  \n✓ **السياق الديني فقط** - لا تستخرج مصطلحات دينية من سياق غير ديني  \n✓ **الحد الأقصى 7 وسوم** - لا تتجاوز 7 فئات (عدد الفئات الممكنة)  \n✓ **الحفاظ على Row_ID** - يجب مطابقة القيمة الأصلية تمامًا  \n✓ **لا تكرار** - لا تكرر نفس الفئة في المخرجات  \n✓ **الفراغ الصحيح** - إذا لم توجد أي فئات دينية، يجب أن تكون المخرجات `[]`  \n\n---\n\n### **أمثلة على التصحيح (حاسمة)**\n\n**المدخلات الخاطئة → المخرجات الصحيحة:**\n```json\n{\"row_id\": \"1\", \"الديني\": [\"الله\"]} → ❌ خاطئ (لأن \"الله\" مصطلح ديني مباشر)\n{\"row_id\": \"1\", \"الديني\": [\"الله\"]} → ✓ صحيح (لأن \"الله\" اسم فئة)\n\n{\"row_id\": \"2\", \"الديني\": [\"الله اكبر\"]} → ❌ خاطئ (لأن \"الله اكبر\" مصطلح ديني مباشر)\n{\"row_id\": \"2\", \"الديني\": [\"الله\"]} → ✓ صحيح (لأن \"الله اكبر\" ينتمي لفئة \"الله\")\n\n{\"row_id\": \"3\", \"الديني\": [\"رضا الله\"]} → ❌ خاطئ (لأن \"رضا الله\" مصطلح ديني مباشر)\n{\"row_id\": \"3\", \"الديني\": [\"الله\"]} → ✓ صحيح (لأن \"رضا الله\" ينتمي لفئة \"الله\")\n\n{\"row_id\": \"4\", \"الديني\": [\"باسم الله\"]} → ❌ خاطئ (لأن \"باسم الله\" مصطلح ديني مباشر)\n{\"row_id\": \"4\", \"الديني\": [\"الله\"]} → ✓ صحيح (لأن \"باسم الله\" ينتمي لفئة \"الله\")\n\n{\"row_id\": \"5\", \"الديني\": [\"صايم\"]} → ❌ خاطئ (لأن \"صايم\" مصطلح ديني مباشر)\n{\"row_id\": \"5\", \"الديني\": [\"عبادة\"]} → ✓ صحيح (لأن \"صايم\" ينتمي لفئة \"العبادة\")\n\n{\"row_id\": \"6\", \"الديني\": [\"الله\",\"توبة\"]} → ❌ خاطئ (لأن \"الله\" و\"توبة\" مصطلحات دينية مباشرة)\n{\"row_id\": \"6\", \"الديني\": [\"الله\", \"عبادة\"]} → ✓ صحيح (لأن \"الله\" ينتمي لفئة \"الله\" و\"توبة\" لفئة \"العبادة\")\n\n{\"row_id\": \"7\", \"الديني\": [\"ربنا\"]} → ❌ خاطئ (لأن \"ربنا\" مصطلح ديني مباشر)\n{\"row_id\": \"7\", \"الديني\": [\"الله\"]} → ✓ صحيح (لأن \"ربنا\" ينتمي لفئة \"الله\")\n```\n\n**أمثلة معقدة:**\n**المدخل:** \"يا من إذا جات المضرة دعينا باسمك ولا غيرك يزيل المضرات\"\n- **\"باسمك\"** في السياق الديني → تنتمي لفئة \"الله\"\n- **المخرج الصحيح:** `{\"row_id\": \"123\", \"الديني\": [\"الله\"]}`\n\n**المدخل:** \"الحمد لله على نعمة الصوم في رمضان\"\n- **\"الحمد لله\"** → تنتمي لفئة \"الله\"\n- **\"الصوم\"** → تنتمي لفئة \"العبادة\"\n- **\"رمضان\"** → تنتمي لفئة \"المناسبات_الدينية\"\n- **المخرج الصحيح:** `{\"row_id\": \"124\", \"الديني\": [\"الله\", \"عبادة\", \"المناسبات_الدينية\"]}`\n\n**المدخل:** \"رضاك يا رب أغلى من كل شيء\"\n- **\"رضاك\"** في السياق الديني → تنتمي لفئة \"الله\"\n- **\"يا رب\"** → تنتمي لفئة \"الله\"\n- **المخرج الصحيح:** `{\"row_id\": \"125\", \"الديني\": [\"الله\"]}` (لاحظ عدم التكرار)\n\n**المدخل:** \"صايم عن الكلام والنظر\"\n- **\"صايم\"** في السياق الديني → تنتمي لفئة \"العبادة\"\n- **المخرج الصحيح:** `{\"row_id\": \"126\", \"الديني\": [\"عبادة\"]}`\n\n**المدخل:** \"الله يعلم أن محمد رسول الله\"\n- **\"الله\"** → تنتمي لفئة \"الله\"\n- **\"محمد رسول الله\"** → تنتمي لفئة \"الأنبياء\"\n- **المخرج الصحيح:** `{\"row_id\": \"127\", \"الديني\": [\"الله\", \"الأنبياء\"]}`\n\n**المدخل:** \"الإسلام ديننا والقرآن كتابنا\"\n- **\"الإسلام\"** → تنتمي لفئة \"المفاهيم_الإيمانية\"\n- **\"القرآن\"** → تنتمي لفئة \"الكتب_المقدسة\"\n- **المخرج الصحيح:** `{\"row_id\": \"128\", \"الديني\": [\"المفاهيم_الإيمانية\", \"الكتب_المقدسة\"]}`\n\n---\n\n### **بروتوكولات الطوارئ**\n\n- **إذا وُجد مصطلح ديني في القائمة → أضف الفئة المقابلة إلى المخرجات**\n- **إذا كان السياق غامضًا → لا تدرج الفئة في المخرجات** (الأمان أولًا)\n- **إذا وُجد مصطلح في أكثر من فئة → أضف الفئة الأكثر ملاءمة فقط** (لا تكرر الفئات)\n- **إذا وُجد مصطلح في سياق غير ديني → تجاهله تمامًا**\n- **إذا لم تتأكد من الفئة → لا تدرجها في المخرجات** (الأمان أولًا)\n\n---\n\n**التعليمات النهائية:**  \nأنت الآن تعمل كـ **مُصنف ديني باللغة العربية فقط**. مهمتك هي تحديد ما إذا كانت الأبيات تحتوي على محتوى ديني، وتصنيفه إلى **7 فئات عربية** فقط. **لا تستخرج مصطلحات دينية مباشرة أبدًا** - المخرجات تشمل **أسماء الفئات فقط**. **السياق هو الملك** - إذا لم تكن متأكدًا من السياق الديني، لا تدرج الفئة في المخرجات.\n\n**ابدأ المعالجة الآن. المخرجات JSON فقط. لا شرح. لا نص إضافي.**"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        6272,
        1936
      ],
      "id": "12f9bf1b-d1d0-4f40-9f23-8c8d374077a5",
      "name": "AI Agent11"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nlet results = [];\n\nitems.forEach(item => {\n  let outputStr = item.json.output || \"\";\n\n  // Remove markdown code blocks and any leading/trailing whitespace\n  outputStr = outputStr.replace(/```json|```/g, '').trim();\n\n  // Remove all whitespace characters that could interfere (newlines, tabs, etc.)\n  // but keep spaces inside strings\n  const normalized = outputStr.replace(/\\s+/g, ' ');\n\n  // Updated regex to match: {\"row_id\": \"number\", \"الديني\": ...}\n  // Captures row_id and the full الديني part (array or string)\n  const objectRegex = /{\\s*\"row_id\"\\s*:\\s*\"([^\"]+)\"\\s*,\\s*\"الديني\"\\s*:\\s*(\\[[^\\]]*\\]|\"[^\"]*\")\\s*}/g;\n\n  let match;\n  while ((match = objectRegex.exec(normalized)) !== null) {\n    const rowId = match[1].trim();\n    const religiousRaw = match[2].trim();\n\n    let religiousValue;\n\n    if (religiousRaw === '[]') {\n      religiousValue = [];\n    } else if (religiousRaw.startsWith('[') && religiousRaw.endsWith(']')) {\n      // Handle multiple tags: [\"Allah\", \"Worship\"]\n      try {\n        religiousValue = JSON.parse(religiousRaw);\n      } catch (e) {\n        religiousValue = [];\n      }\n    } else {\n      // Single quoted string\n      religiousValue = religiousRaw.slice(1, -1); // remove quotes\n    }\n\n    results.push({\n      row_id: rowId,\n      الديني: religiousValue\n    });\n  }\n});\n\n// Return as proper n8n items\nreturn results.map(result => ({ json: result }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6832,
        2032
      ],
      "id": "890bc5f3-578a-46c3-a763-6a47735f07f3",
      "name": "Code in JavaScript19"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        6016,
        1920
      ],
      "id": "25c29558-8d20-475c-8264-9b489875c0f3",
      "name": "Loop Over Items12",
      "executeOnce": false
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w",
          "mode": "list",
          "cachedResultName": "FAZ_POEMS_REVIEW",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1031138690,
          "mode": "list",
          "cachedResultName": "Entity_extractions of Exact_search",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1W2cjBr8qBrVLmMTAKstG1eLDrdn-3rn1yO6JgsTDP_w/edit#gid=1031138690"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Row_ID": "={{ $json.row_id }}",
            "religion_status": "=Done",
            "دين": "={{ $json['الديني'] }}"
          },
          "matchingColumns": [
            "Row_ID"
          ],
          "schema": [
            {
              "id": "poem_id",
              "displayName": "poem_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Row_ID",
              "displayName": "Row_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Title_raw",
              "displayName": "Title_raw",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Poem_line_raw",
              "displayName": "Poem_line_raw",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "summary",
              "displayName": "summary",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Title_cleaned",
              "displayName": "Title_cleaned",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Poem_line_cleaned",
              "displayName": "Poem_line_cleaned",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "قافية",
              "displayName": "قافية",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "روي",
              "displayName": "روي",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "البحر",
              "displayName": "البحر",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "وصل",
              "displayName": "وصل",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "حركة",
              "displayName": "حركة",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "confidence",
              "displayName": "confidence",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "comment",
              "displayName": "comment",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "شخص",
              "displayName": "شخص",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "sentiments",
              "displayName": "sentiments",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "sentiments_Status",
              "displayName": "sentiments_Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "أماكن",
              "displayName": "أماكن",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "أحداث",
              "displayName": "أحداث",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status",
              "displayName": "Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "دين",
              "displayName": "دين",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "religion_status",
              "displayName": "religion_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "مواضيع",
              "displayName": "مواضيع",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "تصنيف",
              "displayName": "تصنيف",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Column 19",
              "displayName": "Column 19",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "useAppend": true
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        7024,
        2032
      ],
      "id": "c80fe589-f9eb-4150-bc1a-7dc81801f6fe",
      "name": "Append or update row in sheet11",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "OV5c4nxTt4atkgGW",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "content": "## religion enhancements\n\n",
        "height": 192,
        "width": 368
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        5008,
        1904
      ],
      "typeVersion": 1,
      "id": "21f1a915-550b-493c-b8cb-05fde3ca2113",
      "name": "Sticky Note12"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst grouped = items.reduce((acc, item) => {\n  const json = item.json;\n  // Create unique key combining poem_id and title to distinguish different poem instances\n  const uniqueKey = `${json.poem_id}-${json.Title_cleaned}`;\n  if (!acc[uniqueKey]) {\n    acc[uniqueKey] = {\n      poem_id: json.poem_id,\n      poem: json.Title_cleaned.trim(),\n      contents_tagged: []\n    };\n  }\n  const lineText = (json.Poem_line_cleaned || \"\").trim();\n  const rowId = json.Row_ID;  // This line is present in your original code\n  acc[uniqueKey].contents_tagged.push(`\"${rowId}\":\"${lineText}\"`);\n  return acc;\n}, {});\nconst result = Object.values(grouped);\nreturn result;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5808,
        1920
      ],
      "id": "832466d9-07bb-4fd4-bf44-128b8eafbdec",
      "name": "Code in JavaScript20"
    },
    {
      "parameters": {
        "model": "grok-4-1-fast-non-reasoning",
        "options": {
          "temperature": 0.2
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatXAiGrok",
      "typeVersion": 1,
      "position": [
        6240,
        2816
      ],
      "id": "a97da810-09bc-48f7-82e4-f81deab05197",
      "name": "xAI Grok Chat Model1",
      "credentials": {
        "xAiApi": {
          "id": "8xuEmNzOUuELUh3f",
          "name": "xAi account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1F_DGCeI7vJP_SZE1RO4uiR97Vk0rCa_BYLpQq0myLKk",
          "mode": "list",
          "cachedResultName": "FAZ3_POEMS_Exact_Search",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1F_DGCeI7vJP_SZE1RO4uiR97Vk0rCa_BYLpQq0myLKk/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1031138690,
          "mode": "list",
          "cachedResultName": "Exact_search",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1F_DGCeI7vJP_SZE1RO4uiR97Vk0rCa_BYLpQq0myLKk/edit#gid=1031138690"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "شخص_status",
              "lookupValue": "Ready"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        5552,
        2448
      ],
      "id": "42757400-eff2-43a8-958e-031aa6dcfe5e",
      "name": "Get row(s) in sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "OV5c4nxTt4atkgGW",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=TASK: Analyze each line below individually.\n\nPoem title: {{ $json.poem }}\n\nLines to process:\n{{ $json.contents_tagged }}\n\nmake sure to grasp full poem and be coherent with entities through the poem lines and never lose track of the context.\neven if the poet says \"هو، هناك ، معه،...\"make sure you grasp the context from other lines",
        "options": {
          "systemMessage": "=# Strict Persons Extractor for Arabic Poetry - Line-by-Line\n\n## Preprocessing\n1. Normalize input: Remove diacritics (tashkeel), tatweel (ـ), normalize alef variations (أ,إ,آ,ا → ا), ya/waw variations, ta marbuta (ة → ه).\n2. Lowercase everything for matching.\n\n## PEOPLE List\n```json\n[\n  {\"name\": \"حمدان بن محمد بن راشد آل مكتوم\", \"relation\": \"الذات\", \"tags\": [\"حمدان\", \"فزاع\", \"ولي العهد\", \"قائد\", \"سيد\", \"أمير\"]},\n  {\"name\": \"محمد بن راشد آل مكتوم\", \"relation\": \"الأب\", \"tags\": [\"محمد بن راشد\", \"أبي\", \"والدي\", \"قائدي\", \"سيدي\", \"معلمي\", \"حاكم دبي\", \"نائب رئيس الدولة\", \"رئيس الوزراء\", \"صاحب السمو\", \"ابو راشد\", \"راشد بن سعيد\"]},\n  {\"name\": \"هند بنت مكتوم بن جمعة آل مكتوم\", \"relation\": \"الأم\", \"tags\": [\"هند\", \"أمي\", \"والدتي\", \"سيدتي\", \"الأميرة\"]},\n  {\"name\": \"راشد بن حمدان بن محمد آل مكتوم\", \"relation\": \"الابن\", \"tags\": [\"راشد\", \"ابني\", \"ولدي\", \"فلذة كبدي\", \"نور عيني\", \"حبيبي\", \"أملي\", \"ذريتي\"]},\n  {\"name\": \"شيخة بنت حمدان بن محمد آل مكتوم\", \"relation\": \"الابنة\", \"tags\": [\"شيخة\", \"ابنتي\", \"بنتي\", \"نور عيني\", \"حبيبتي\", \"فرحتي\", \"أملي\", \"ذريتي\"]},\n  {\"name\": \"مكتوم بن محمد بن راشد آل مكتوم\", \"relation\": \"الأخ\", \"tags\": [\"مكتوم\", \"أخي\", \"رفيق درب\", \"سندي\", \"نائب حاكم دبي\", \"وزير المالية\"]},\n  {\"name\": \"أحمد بن محمد بن راشد آل مكتوم\", \"relation\": \"الأخ\", \"tags\": [\"أحمد\", \"أخي\", \"رفيق درب\", \"سندي\", \"نائب حاكم دبي\"]},\n  {\"name\": \"راشد بن محمد بن راشد آل مكتوم\", \"relation\": \"الأخ (متوفى)\", \"tags\": [\"راشد\", \"أخي\", \"الفقيد\", \"رحمه الله\", \"طيب الله ثراه\", \"في ذمة الله\"]},\n  {\"name\": \"محمد بن زايد آل نهيان\", \"relation\": \"رئيس دولة الإمارات\", \"tags\": [\"محمد بن زايد\", \"قائدي\", \"سيدي\", \"أخي\", \"رئيس الدولة\", \"حاكم أبوظبي\", \"صاحب السمو\", \"رفيق درب\", \"بو خالد\", \"ابو خالد\"]},\n  {\"name\": \"زايد بن سلطان آل نهيان\", \"relation\": \"الوالد المؤسس\", \"tags\": [\"زايد\", \"المؤسس\", \"الوالد المؤسس\", \"أبو الأمة\", \"الباني\", \"رحمه الله\", \"طيب الله ثراه\", \"القائد الخالد\", \"شيخ زايد\"]},\n  {\"name\": \"فاطمة بنت مبارك الكتبي\", \"relation\": \"أم رئيس دولة الإمارات\", \"tags\": [\"فاطمة بنت مبارك\", \"أم الإمارات\", \"أم الأمة\", \"سيدتي\", \"الأميرة\"]},\n  {\"name\": \"حمدان بن زايد آل نهيان\", \"relation\": \"أخ رئيس دولة الإمارات\", \"tags\": [\"حمدان بن زايد\", \"سيدي\", \"أخي\", \"ممثل الحاكم\", \"صاحب السمو\"]},\n  {\"name\": \"منصور بن زايد آل نهيان\", \"relation\": \"أخ رئيس دولة الإمارات\", \"tags\": [\"منصور بن زايد\", \"سيدي\", \"أخي\", \"نائب رئيس الدولة\", \"وزير شؤون الرئاسة\", \"صاحب السمو\"]},\n  {\"name\": \"طحنون بن زايد آل نهيان\", \"relation\": \"أخ رئيس دولة الإمارات\", \"tags\": [\"طحنون بن زايد\", \"سيدي\", \"أخي\", \"مستشار الأمن الوطني\", \"صاحب السمو\"]},\n  {\"name\": \"عبدالله بن زايد آل نهيان\", \"relation\": \"أخ رئيس دولة الإمارات\", \"tags\": [\"عبدالله بن زايد\", \"سيدي\", \"أخي\", \"وزير الخارجية\", \"صاحب السمو\"]},\n  {\"name\": \"سلمان بن عبدالعزيز آل سعود\", \"relation\": \"ملك المملكة العربية السعودية\", \"tags\": [\"سلمان\", \"ملك\", \"خادم الحرمين الشريفين\", \"ملك السعودية\", \"أخي\", \"قائد\", \"جار\"]},\n  {\"name\": \"محمد بن سلمان آل سعود\", \"relation\": \"ولي عهد المملكة العربية السعودية\", \"tags\": [\"محمد بن سلمان\", \"ولي العهد\", \"أمير\", \"أخي\", \"صديق\", \"رفيق\", \"قائد\"]},\n  {\"name\": \"تميم بن حمد آل ثاني\", \"relation\": \"أمير دولة قطر\", \"tags\": [\"تميم\", \"أمير\", \"أمير قطر\", \"أخي\", \"جار\", \"صديق\", \"قائد\"]},\n  {\"name\": \"حمد بن عيسى آل خليفة\", \"relation\": \"ملك مملكة البحرين\", \"tags\": [\"حمد\", \"ملك\", \"ملك البحرين\", \"أخي\", \"جار\", \"صديق\", \"قائد\"]},\n  {\"name\": \"مشعل الأحمد الجابر الصباح\", \"relation\": \"أمير دولة الكويت\", \"tags\": [\"مشعل\", \"أمير\", \"أمير الكويت\", \"أخي\", \"جار\", \"صديق\", \"قائد\"]},\n  {\"name\": \"هيثم بن طارق\", \"relation\": \"سلطان عمان\", \"tags\": [\"هيثم\", \"سلطان\", \"سلطان عمان\", \"أخي\", \"جار\", \"صديق\", \"قائد\"]},\n  {\"name\": \"قابوس بن سعيد آل سعيد\", \"relation\": \"سلطان عمان السابق\", \"tags\": [\"قابوس\", \"سلطان عمان السابق\"]}\n]\n```\n## extract ambigious entities as well for example:\n{\"name\": \"الشاعر\", \"relation\": \"المتحدث\", \"tags\": [\"انا\", \"أنا\", \"لي\", \"اقول\", \"نويت\", \"حرك اشواقي\", \"العاشق الشاقي\", \"المشتاق\"]},\n{\"name\": \"الحبيب\", \"relation\": \"المحبوب\", \"tags\": [\"انت\", \"أنت\", \"ترحل\", \"حبك\", \"الغالي\", \"ذوقك\", \"خصرك\", \"شفاتك\", \"عشاقك\", \"عليك\"]}\noutput example:\n[\n  {\"row_id\": \"1\", \"الاشخاص\": [{\"name\": \"الشاعر\", \"relation\": \"المتحدث\", \"resolved_from\": [\"المشتاق\"]}, {\"name\": \"الحبيب\", \"relation\": \"المحبوب\", \"resolved_from\": [\"الوصل\"]}]},\n  {\"row_id\": \"2\", \"الاشخاص\": [{\"name\": \"الحبيب\", \"relation\": \"المحبوب\", \"resolved_from\": [\"انت\"]}, {\"name\": \"الشاعر\", \"relation\": \"المتحدث\", \"resolved_from\": [\"انا\"]}]},\n  {\"row_id\": \"3\", \"الاشخاص\": [{\"name\": \"الحبيب\", \"relation\": \"المحبوب\", \"resolved_from\": [\"حبك\", \"ترحل\"]}, {\"name\": \"الشاعر\", \"relation\": \"المتحدث\", \"resolved_from\": [\"الاعماقي\", \"انا\"]}]},\n  {\"row_id\": \"4\", \"الاشخاص\": [{\"name\": \"الحبيب\", \"relation\": \"المحبوب\", \"resolved_from\": [\"بينك\"]}, {\"name\": \"الشاعر\", \"relation\": \"المتحدث\", \"resolved_from\": [\"بيني\"]}]}\n]\n\n## Output Requirements (STRICT FORMAT)\n- For **EACH LINE**, output **EXACTLY ONE** JSON object in this format:\n```json\n{\"row_id\": \"line_number\", \"الاشخاص\": [array_of_entities]}\n```\n- `row_id`: Must match the line number from input (e.g., \"666\", \"667\")\n- `الاشخاص`: JSON array of entities. Empty array `[]` if no EXACT matches.\n- Entity format: `{\"name\": \"Full Arabic Name\", \"relation\": \"relation value\", \"resolved_from\": [\"exact_trigger1\", \"exact_trigger2\"]}`\n- `resolved_from`: ONLY the exact triggering words/phrases found in that line (normalized form).\n- **NO** explanations, **NO** metadata, **ONLY** valid JSON objects.\n\n## Examples (Line-by-Line for Sample Poem)\n\nInput:\n```json\n[\n  {\n    \"poem_id\": 44,\n    \"poem\": \"امر يا بو خالد\",\n    \"contents_tagged\": [\n      \"\\\"666\\\":\\\"طير السعد رفرف وغنا      وتمايلت خضر البساتين\\\"\",\n      \"\\\"667\\\":\\\"راياتكم فينا ومنا      لافراحكم جينا ملبين\\\"\",\n      \"\\\"668\\\":\\\"بك نفخر ويفخر وطنا      شرفتنا يا قايد العين\\\"\",\n      \"\\\"669\\\":\\\"عم الفرح والكل هنا      شرفتنا يالعين يالعين\\\"\",\n      \"\\\"670\\\":\\\"الفوز راياته لفنا      والفوز تشهد له ميادين\\\"\",\n      \"\\\"671\\\":\\\"غصن الثنا لجلك تثنا      خذها يابو خالد عن يمين\\\"\",\n      \"\\\"672\\\":\\\"امر يابو (خالد) تمني      واسكن قبل هالعين هالعين\\\"\",\n      \"\\\"673\\\":\\\"نقولها عنكم وعنا      هذي عوايدنا من سنين\\\"\",\n      \"\\\"674\\\":\\\"سقنا البراهين وضمنا      بافعالنا سقنا البراهين\\\"\",\n      \"\\\"675\\\":\\\"بالحق في شفكم شهدنا      والحق ترجح به موازين\\\"\"\n    ]\n  }\n]\n```\n# notice how \"poem\": \"امر يا بو خالد\" could relate that the person in question is \"بو خالد\" which from entity map you know he is \"محمد بن زايد آل نهيان\"\nOutput:\n```json\n[\n  {\"row_id\": \"666\", \"الاشخاص\": []},\n  {\"row_id\": \"667\", \"الاشخاص\": []},\n  {\"row_id\": \"668\", \"الاشخاص\": []},\n  {\"row_id\": \"669\", \"الاشخاص\": []},\n  {\"row_id\": \"670\", \"الاشخاص\": []},\n  {\"row_id\": \"671\", \"الاشخاص\": [{\"name\": \"محمد بن زايد آل نهيان\", \"relation\": \"UAE President\", \"resolved_from\": [\"يابو خالد\"]}]},\n  {\"row_id\": \"672\", \"الاشخاص\": [{\"name\": \"محمد بن زايد آل نهيان\", \"relation\": \"UAE President\", \"resolved_from\": [\"يابو (خالد)\"]}]},\n  {\"row_id\": \"673\", \"الاشخاص\": []},\n  {\"row_id\": \"674\", \"الاشخاص\": []},\n  {\"row_id\": \"675\", \"الاشخاص\": []}\n]\n```\n# NOTE\noutput is strictly arabic\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        6256,
        2464
      ],
      "id": "458213df-f343-40d4-b207-9c75261ba870",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nlet results = [];\n\n// --- helper: extract JSON array safely ---\nfunction extractJsonArray(text) {\n  if (typeof text !== \"string\") return null;\n\n  let raw = text.trim();\n\n  // 1. Remove ```json / ``` wrappers if present\n  raw = raw.replace(/```json/i, \"\").replace(/```/g, \"\").trim();\n\n  // 2. If double-encoded JSON string → decode once\n  if (\n    (raw.startsWith('\"') && raw.endsWith('\"')) ||\n    (raw.startsWith(\"'\") && raw.endsWith(\"'\"))\n  ) {\n    try {\n      raw = JSON.parse(raw);\n    } catch {\n      // continue anyway\n    }\n  }\n\n  // 3. Try direct parse\n  try {\n    const parsed = JSON.parse(raw);\n    if (Array.isArray(parsed)) return parsed;\n  } catch {}\n\n  // 4. Fallback: extract first [...] block\n  const start = raw.indexOf(\"[\");\n  const end = raw.lastIndexOf(\"]\");\n  if (start === -1 || end === -1) return null;\n\n  const sliced = raw.slice(start, end + 1);\n\n  try {\n    return JSON.parse(sliced);\n  } catch {\n    return null;\n  }\n}\n\n// --- main loop ---\nitems.forEach(item => {\n  const text =\n    item.json?.output ??\n    item.json ??\n    \"\";\n\n  const data = extractJsonArray(text);\n  if (!Array.isArray(data)) return;\n\n  data.forEach(obj => {\n    if (obj?.row_id && obj?.الاشخاص) {\n      results.push({\n        row_id: obj.row_id,\n        الاشخاص: obj.الاشخاص\n      });\n    }\n  });\n});\n\nreturn results.map(r => ({ json: r }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6816,
        2560
      ],
      "id": "2059cea2-2402-4790-bf79-59ce6fdebaa5",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        6000,
        2448
      ],
      "id": "27b6bb3c-0033-4bcb-87b0-eb5d59372c8e",
      "name": "Loop Over Items",
      "executeOnce": false
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1F_DGCeI7vJP_SZE1RO4uiR97Vk0rCa_BYLpQq0myLKk",
          "mode": "list",
          "cachedResultName": "FAZ3_POEMS_Exact_Search",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1F_DGCeI7vJP_SZE1RO4uiR97Vk0rCa_BYLpQq0myLKk/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1031138690,
          "mode": "list",
          "cachedResultName": "Exact_search",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1F_DGCeI7vJP_SZE1RO4uiR97Vk0rCa_BYLpQq0myLKk/edit#gid=1031138690"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Row_ID": "={{ $json.row_id }}",
            "شخص": "={{ $json['الاشخاص'] }}",
            "شخص_status": "Done"
          },
          "matchingColumns": [
            "Row_ID"
          ],
          "schema": [
            {
              "id": "poem_id",
              "displayName": "poem_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Row_ID",
              "displayName": "Row_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Title_raw",
              "displayName": "Title_raw",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Poem_line_raw",
              "displayName": "Poem_line_raw",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "summary",
              "displayName": "summary",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Title_cleaned",
              "displayName": "Title_cleaned",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Poem_line_cleaned",
              "displayName": "Poem_line_cleaned",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "قافية",
              "displayName": "قافية",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "روي",
              "displayName": "روي",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "البحر",
              "displayName": "البحر",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "وصل",
              "displayName": "وصل",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "حركة",
              "displayName": "حركة",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "شخص",
              "displayName": "شخص",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "شخص_status",
              "displayName": "شخص_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "sentiments",
              "displayName": "sentiments",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "أحداث",
              "displayName": "أحداث",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "دين",
              "displayName": "دين",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "مواضيع",
              "displayName": "مواضيع",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "أماكن",
              "displayName": "أماكن",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "تصنيف",
              "displayName": "تصنيف",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        7040,
        2560
      ],
      "id": "2791e384-ac7c-494d-a3eb-61a8b0df20bd",
      "name": "Append or update row in sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "OV5c4nxTt4atkgGW",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "content": "## Entity enhancements\n\n",
        "height": 176,
        "width": 336
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        4992,
        2432
      ],
      "typeVersion": 1,
      "id": "df0629a3-0f5b-4aa0-a32b-d09049ddf9c1",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst grouped = items.reduce((acc, item) => {\n  const json = item.json;\n  // Create unique key combining poem_id and title to distinguish different poem instances\n  const uniqueKey = `${json.poem_id}-${json.Title_cleaned}`;\n  if (!acc[uniqueKey]) {\n    acc[uniqueKey] = {\n      poem_id: json.poem_id,\n      poem: json.Title_cleaned.trim(),\n      contents_tagged: []\n    };\n  }\n  const lineText = (json.Poem_line_cleaned || \"\").trim();\n  const rowId = json.Row_ID;  // This line is present in your original code\n  acc[uniqueKey].contents_tagged.push(`\"${rowId}\":\"${lineText}\"`);\n  return acc;\n}, {});\nconst result = Object.values(grouped);\nreturn result;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5792,
        2448
      ],
      "id": "0c08436a-5300-42d3-8703-6039cf5cfa9c",
      "name": "Code in JavaScript21"
    }
  ],
  "connections": {
    "When clicking ‘Execute workflow’": {
      "main": [
        [
          {
            "node": "Get row(s) in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet7": {
      "main": [
        [
          {
            "node": "Code in JavaScript10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent6": {
      "main": [
        [
          {
            "node": "Code in JavaScript9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript9": {
      "main": [
        [
          {
            "node": "Append or update row in sheet6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items7": {
      "main": [
        [],
        [
          {
            "node": "AI Agent6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append or update row in sheet6": {
      "main": [
        [
          {
            "node": "Loop Over Items7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript10": {
      "main": [
        [
          {
            "node": "Loop Over Items7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "xAI Grok Chat Model5": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent6",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet3": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent3": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items3": {
      "main": [
        [],
        [
          {
            "node": "AI Agent3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append or update row in sheet3": {
      "main": [
        [
          {
            "node": "Loop Over Items3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent3",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Loop Over Items3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "Append or update row in sheet3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet4": {
      "main": [
        [
          {
            "node": "Code in JavaScript6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent4": {
      "main": [
        [
          {
            "node": "Code in JavaScript5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript5": {
      "main": [
        [
          {
            "node": "Append or update row in sheet4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items5": {
      "main": [
        [],
        [
          {
            "node": "AI Agent4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append or update row in sheet4": {
      "main": [
        [
          {
            "node": "Loop Over Items5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript6": {
      "main": [
        [
          {
            "node": "Loop Over Items5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent4",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet8": {
      "main": [
        [
          {
            "node": "Code in JavaScript12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent7": {
      "main": [
        [
          {
            "node": "Code in JavaScript11",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript11": {
      "main": [
        [
          {
            "node": "Append or update row in sheet7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items8": {
      "main": [
        [],
        [
          {
            "node": "AI Agent7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append or update row in sheet7": {
      "main": [
        [
          {
            "node": "Loop Over Items8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript12": {
      "main": [
        [
          {
            "node": "Loop Over Items8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "xAI Grok Chat Model6": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent7",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet9": {
      "main": [
        [
          {
            "node": "Code in JavaScript14",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent8": {
      "main": [
        [
          {
            "node": "Code in JavaScript13",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript13": {
      "main": [
        [
          {
            "node": "Append or update row in sheet8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items9": {
      "main": [
        [],
        [
          {
            "node": "AI Agent8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append or update row in sheet8": {
      "main": [
        [
          {
            "node": "Loop Over Items9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript14": {
      "main": [
        [
          {
            "node": "Loop Over Items9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "xAI Grok Chat Model7": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent8",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet10": {
      "main": [
        [
          {
            "node": "Code in JavaScript16",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent9": {
      "main": [
        [
          {
            "node": "Code in JavaScript15",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript15": {
      "main": [
        [
          {
            "node": "Append or update row in sheet9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items10": {
      "main": [
        [],
        [
          {
            "node": "AI Agent9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append or update row in sheet9": {
      "main": [
        [
          {
            "node": "Loop Over Items10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript16": {
      "main": [
        [
          {
            "node": "Loop Over Items10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "xAI Grok Chat Model8": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent9",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "xAI Grok Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent11",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet12": {
      "main": [
        [
          {
            "node": "Code in JavaScript20",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent11": {
      "main": [
        [
          {
            "node": "Code in JavaScript19",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript19": {
      "main": [
        [
          {
            "node": "Append or update row in sheet11",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items12": {
      "main": [
        [],
        [
          {
            "node": "AI Agent11",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append or update row in sheet11": {
      "main": [
        [
          {
            "node": "Loop Over Items12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript20": {
      "main": [
        [
          {
            "node": "Loop Over Items12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "xAI Grok Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet": {
      "main": [
        [
          {
            "node": "Code in JavaScript21",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Append or update row in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append or update row in sheet": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript21": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "pinData": {},
  "triggerCount": 0,
  "meta": {
    "templateCredsSetupCompleted": true
  }
}