<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Exact Word Match Test</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
        direction: rtl;
      }
      input {
        width: 100%;
        padding: 12px;
        font-size: 18px;
        border: 2px solid #ddd;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .result {
        border: 1px solid #e0e0e0;
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        background: #fafafa;
      }
      .title {
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 8px;
      }
      .poem {
        line-height: 1.8;
        color: #34495e;
      }
      mark {
        background: #ffd700;
        padding: 2px 4px;
        border-radius: 3px;
      }
      .info {
        font-size: 12px;
        color: #7f8c8d;
        margin-top: 8px;
      }
      .loading {
        text-align: center;
        color: #3498db;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¯Ù‚ÙŠÙ‚</h1>
    <div style="display: flex; gap: 10px; margin-bottom: 20px">
      <input
        type="text"
        id="search"
        placeholder="Ø§Ø¨Ø­Ø«... (Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ØŒ Ø¯Ø¨ÙŠØŒ Ø¨Ùˆ Ø®Ø§Ù„Ø¯)"
        autofocus
        style="flex: 1; margin: 0"
      />
      <button
        id="searchBtn"
        style="
          padding: 12px 24px;
          font-size: 18px;
          cursor: pointer;
          border-radius: 8px;
          border: none;
          background: #3498db;
          color: white;
        "
      >
        Ø¨Ø­Ø«
      </button>
    </div>
    <div id="results"></div>

    <script>
      const SUPABASE_URL = "https://ezcbshyresjinfyscals.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV6Y2JzaHlyZXNqaW5meXNjYWxzIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MzE2MjY0NSwiZXhwIjoyMDc4NzM4NjQ1fQ.ozzNCzjvWOym1QqxkQXxgDH2_zf-Y7trpvaaUF7ZpFs";

      const searchInput = document.getElementById("search");
      const searchBtn = document.getElementById("searchBtn");
      const resultsDiv = document.getElementById("results");

      // Search on button click
      searchBtn.addEventListener("click", () => {
        console.log("Button clicked");
        search(searchInput.value);
      });

      // Search on Enter key
      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          console.log("Enter pressed");
          search(e.target.value);
        }
      });

      async function search(query) {
        if (!query.trim()) {
          resultsDiv.innerHTML = "";
          return;
        }

        resultsDiv.innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div>';

        try {
          const response = await fetch(
            `${SUPABASE_URL}/rest/v1/rpc/hybrid_search_exact`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                apikey: SUPABASE_KEY,
                Authorization: `Bearer ${SUPABASE_KEY}`,
              },
              body: JSON.stringify({
                query_text: query,
                match_count: 5,
              }),
            }
          );

          const data = await response.json();
          displayResults(data, query);
        } catch (error) {
          resultsDiv.innerHTML = `<div class="result">Ø®Ø·Ø£: ${error.message}</div>`;
        }
      }

      function displayResults(results, query) {
        if (!results || results.length === 0) {
          resultsDiv.innerHTML = '<div class="result">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
          return;
        }

        resultsDiv.innerHTML = results
          .map((r) => {
            const positions = r.highlight_positions?.positions || [];
            const poemWords = r.poem_raw ? r.poem_raw.split(" ") : [];
            const title = r.metadata?.poem_name || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†";

            // Highlight poem body using positions
            const highlightedPoem = poemWords
              .map((word, idx) => {
                if (positions.includes(idx)) {
                  return `<mark>${word}</mark>`;
                }
                return word;
              })
              .join(" ");

            // Highlight title using query tokens
            const tokens = r.highlight_positions?.tokens || [];
            let highlightedTitle = title;
            tokens.forEach((token) => {
              if (token) {
                // Remove special chars from token for matching
                const cleanToken = token.replace(/[()ØŒØ›.!?Â«Â»"""''\-]/g, "");
                const regex = new RegExp(`(${cleanToken})`, "gi");
                highlightedTitle = highlightedTitle.replace(
                  regex,
                  "<mark>$1</mark>"
                );
              }
            });

            return `
                    <div class="result">
                        <div class="title">${highlightedTitle}</div>
                        <div class="poem">${
                          highlightedPoem || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Øµ"
                        }</div>
                        <div class="info">
                            Ù†ÙˆØ¹ Ø§Ù„ØªØ·Ø§Ø¨Ù‚: ${r.match_type} | 
                            Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${r.final_score.toFixed(4)} |
                            Ù…ÙˆØ§Ø¶Ø¹: ${
                              positions.length > 0
                                ? positions.join(", ")
                                : "Ù„Ø§ ÙŠÙˆØ¬Ø¯"
                            }
                        </div>
                    </div>
                `;
          })
          .join("");
      }
    </script>
  </body>
</html>
