<!-- prettier-ignore-start -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ø¨Ø­Ø« Ø°ÙƒÙŠ - Entity-Aware Search</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }
      .container {
        max-width: 1000px;
        margin: 0 auto;
      }
      .search-box {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        margin-bottom: 30px;
      }
      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 20px;
        font-size: 2em;
      }
      .search-input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }
      input[type="text"] {
        flex: 1;
        padding: 15px;
        font-size: 18px;
        border: 2px solid #ddd;
        border-radius: 8px;
        outline: none;
        transition: border-color 0.3s;
      }
      input[type="text"]:focus {
        border-color: #667eea;
      }
      button {
        padding: 15px 30px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s;
      }
      button:hover {
        transform: translateY(-2px);
      }

      /* Summary Stats */
      .summary-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
      }
      .stat-item {
        text-align: center;
        padding: 10px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
      }
      .stat-value {
        font-size: 28px;
        font-weight: bold;
        margin-bottom: 5px;
      }
      .stat-label {
        font-size: 14px;
        opacity: 0.9;
      }

      /* Tag Pills */
      .tags-container {
        background: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .tag-pill {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 6px 15px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
      }

      /* Result Cards */
      .result-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
        border-right: 5px solid #667eea;
      }
      .result-card:hover {
        transform: translateX(-5px);
      }

      .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }
      .result-title {
        font-size: 22px;
        font-weight: bold;
        color: #667eea;
        flex: 1;
      }
      .result-score {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 16px;
      }

      .result-poem {
        font-size: 18px;
        color: #333;
        line-height: 2;
        margin-bottom: 15px;
        white-space: pre-wrap;
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
      }

      .result-meta {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        font-size: 13px;
        color: #666;
        padding-top: 15px;
        border-top: 1px solid #eee;
      }
      .meta-item {
        background: #f5f5f5;
        padding: 5px 12px;
        border-radius: 15px;
      }
      .meta-tag {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        color: #333;
        font-weight: 600;
      }
      .meta-location {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        color: #333;
        font-weight: 600;
      }

      mark {
        background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: bold;
      }

      .no-results,
      .loading {
        text-align: center;
        padding: 40px;
        color: white;
        font-size: 18px;
        display: none;
      }
      .show {
        display: block;
      }

      /* Skeleton Loading */
      .skeleton {
        background: linear-gradient(
          90deg,
          #f0f0f0 25%,
          #e0e0e0 50%,
          #f0f0f0 75%
        );
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 8px;
        margin-bottom: 15px;
      }
      .skeleton-title {
        height: 30px;
        width: 60%;
        margin-bottom: 15px;
      }
      .skeleton-poem {
        height: 80px;
        width: 100%;
        margin-bottom: 15px;
      }
      .skeleton-meta {
        height: 25px;
        width: 40%;
      }

      @keyframes loading {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="search-box">
        <h1>ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ø¨Ø§Ù„ÙƒÙŠØ§Ù†Ø§Øª</h1>
        <div class="search-input-group">
          <input
            type="text"
            id="searchQuery"
            placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø´Ø®ØµØŒ Ù…ÙƒØ§Ù†ØŒ Ø­Ø¯Ø«..."
          />
          <button onclick="searchPoems()">Ø¨Ø­Ø«</button>
        </div>
      </div>

      <div class="loading" id="loading">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ...</div>

      <!-- Summary Stats -->
      <div id="summaryContainer" style="display: none"></div>

      <!-- Tags -->
      <div id="tagsContainer" style="display: none"></div>

      <!-- Results -->
      <div class="results" id="results"></div>
    </div>

    <script>
      const CONFIG = {
        SUPABASE_URL: "https://uffjlburuvsnstvgyito.supabase.co",
        SUPABASE_ANON_KEY:
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVmZmpsYnVydXZzbnN0dmd5aXRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTczMTcsImV4cCI6MjA4MjA5MzMxN30.cywWITSP-aJfuXlzyBYHf9Ipnhu-6_mVCZ30h3b1-38",
        N8N_WEBHOOK_URL: "https://ihisam002.app.n8n.cloud/webhook/N8N",
      };

      document
        .getElementById("searchQuery")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") searchPoems();
        });

      async function searchPoems() {
        const resultsDiv = document.getElementById("results");
        const loadingDiv = document.getElementById("loading");
        const summaryDiv = document.getElementById("summaryContainer");
        const tagsDiv = document.getElementById("tagsContainer");

        loadingDiv.classList.add("show");
        resultsDiv.innerHTML = createSkeletonCards(3);

        try {
          // HARDCODED TEST - bypass N8N completely
          const hardcodedPayload = {
            N8N_query: {
              Exact_query: "Ø¨Ùˆ Ø®Ø§Ù„Ø¯",
              column: "Ø´Ø®Øµ",
              tag: "Ø¨Ùˆ Ø®Ø§Ù„Ø¯",
              confidence_score: 100,
              expanded_queries: [
                {
                  query: "Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø²Ø§ÙŠØ¯",
                  column: "Ø´Ø®Øµ",
                  tag: "Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø²Ø§ÙŠØ¯",
                  confidence_score: 95,
                  reason: "related_entity",
                },
              ],
              individual_Limit: 10,
              total_limit: 50,
            },
          };

          console.log(
            "ğŸ“¤ Calling PostgreSQL with hardcoded payload:",
            hardcodedPayload
          );
          const payload_key = "n8n_payload";
          const limit_key = "total_limit";
          const score_key = "min_score";

          const pgResponse = await fetch(
            `${CONFIG.SUPABASE_URL}/rest/v1/rpc/hybrid_search_v2_entity_aware`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                apikey: CONFIG.SUPABASE_ANON_KEY,
                Authorization: `Bearer ${CONFIG.SUPABASE_ANON_KEY}`,
              },
              body: JSON.stringify({
                [payload_key]: hardcodedPayload,
                [limit_key]: 50,
                [score_key]: 30,
              }),
            }
          );

          if (!pgResponse.ok) {
            throw new Error(`PostgreSQL error: ${pgResponse.status}`);
          }

          const pgData = await pgResponse.json();
          console.log("ğŸ“¥ PostgreSQL Response:", pgData);

          loadingDiv.classList.remove("show");

          if (pgData && pgData.length > 0) {
            const data = pgData[0];
            const results = data.results;
            console.log("ğŸ¯ Results:", results);

            if (results && results.length > 0) {
              displaySummary(data);
              displayTags(data.tags);
              displayResults(results);
            } else {
              resultsDiv.innerHTML =
                '<div class="no-results">ğŸ˜” Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ - results is null or empty</div>';
            }
          } else {
            resultsDiv.innerHTML =
              '<div class="no-results">ğŸ˜” pgData is empty</div>';
          }
        } catch (error) {
          console.error("âŒ Search error:", error);
          loadingDiv.classList.remove("show");
          resultsDiv.innerHTML = `<div class="no-results">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ${error.message}</div>`;
        }
      }
      function createSkeletonCards(count) {
        let html = "";
        for (let i = 0; i < count; i++) {
          html += `
                    <div class="result-card">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-poem"></div>
                        <div class="skeleton skeleton-meta"></div>
                    </div>
                `;
        }
        return html;
      }

      function displaySummary(data) {
        const summaryDiv = document.getElementById("summaryContainer");
        summaryDiv.innerHTML = `
                <div class="summary-card">
                    <div class="stat-item">
                        <div class="stat-value">${data.poems || 0}</div>
                        <div class="stat-label">Ù‚ØµÙŠØ¯Ø©</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${data.lines || 0}</div>
                        <div class="stat-label">Ø¨ÙŠØª</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${data.words || 0}</div>
                        <div class="stat-label">ÙƒÙ„Ù…Ø©</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${data.results.length}</div>
                        <div class="stat-label">Ù†ØªÙŠØ¬Ø©</div>
                    </div>
                </div>
            `;
        summaryDiv.style.display = "block";
      }

      function displayTags(tagsString) {
        if (!tagsString) return;

        const tagsDiv = document.getElementById("tagsContainer");
        const tags = tagsString
          .split(",")
          .map((t) => t.trim())
          .filter((t) => t);

        if (tags.length === 0) return;

        tagsDiv.innerHTML = `
                <div class="tags-container">
                    ${tags
                      .map((tag) => `<span class="tag-pill">${tag}</span>`)
                      .join("")}
                </div>
            `;
        tagsDiv.style.display = "block";
      }

      function normalizeForComparison(text) {
        if (!text) return "";
        return text
          .replace(/[^\u0600-\u06FFa-zA-Z]/g, "")
          .replace(/[\u0640]/g, "")
          .replace(/[Ø£Ø¥Ø¢]/g, "Ø§")
          .replace(/[Ù‰]/g, "ÙŠ")
          .replace(/[Ø©]/g, "Ù‡");
      }

      function highlightText(rawText, matchData, displayRowId) {
        let wordsToHighlight = new Set();

        if (Array.isArray(matchData)) {
          matchData.forEach((m) => {
            if (m.text) wordsToHighlight.add(normalizeForComparison(m.text));
          });
        } else if (matchData && matchData.matched_words) {
          if (matchData.row_id && matchData.row_id !== displayRowId)
            return rawText;
          matchData.matched_words.forEach((m) => {
            if (m.text && m.positions !== "metadata") {
              wordsToHighlight.add(normalizeForComparison(m.text));
            }
          });
        } else {
          return rawText;
        }

        if (wordsToHighlight.size === 0) return rawText;

        const tokens = rawText.split(/(\s+)/);
        return tokens
          .map((token) => {
            if (!token.trim()) return token;

            const tokenNorm = normalizeForComparison(token);

            if (wordsToHighlight.has(tokenNorm)) {
              return `<mark>${token}</mark>`;
            }

            for (let target of wordsToHighlight) {
              if (target.length > 2 && tokenNorm.includes(target)) {
                return `<mark>${token}</mark>`;
              }
            }

            return token;
          })
          .join("");
      }

      function displayResults(results) {
        const resultsDiv = document.getElementById("results");
        let html = "";

        results.forEach((result) => {
          const titleHighlighted = highlightText(
            result.title_raw,
            result.match.title,
            null
          );

          const poemHighlighted = highlightText(
            result.poem_line_raw,
            result.match.poem_line,
            result.row_id
          );

          // Extract metadata indicators
          const hasMetadata =
            result.match.poem_line?.matched_words?.some(
              (w) => w.positions === "metadata"
            ) || false;

          html += `
                    <div class="result-card">
                        <div class="result-header">
                            <div class="result-title">${titleHighlighted}</div>
                            <div class="result-score">${result.score}</div>
                        </div>
                        <div class="result-poem">${poemHighlighted}</div>
                        <div class="result-meta">
                            <span class="meta-item">Ø³Ø·Ø±: ${result.row_id}</span>
                            <span class="meta-item meta-location">
                                ${result.match_location.join(" + ")}
                            </span>
                            <span class="meta-item">${translateMatchType(
                              result.match_type
                            )}</span>
                            ${
                              result.tag
                                ? `<span class="meta-item meta-tag">ğŸ·ï¸ ${result.tag}</span>`
                                : ""
                            }
                            ${
                              hasMetadata
                                ? '<span class="meta-item" style="background: #ffe5b4;">ğŸ“Š Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØµÙÙŠØ©</span>'
                                : ""
                            }
                        </div>
                    </div>
                `;
        });

        resultsDiv.innerHTML = html;
      }

      function translateMatchType(type) {
        const map = {
          exact_phrase: "Ù…Ø·Ø§Ø¨Ù‚Ø© ØªØ§Ù…Ø©",
          partial_match: "Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¬Ø²Ø¦ÙŠØ©",
          consecutive_words: "ÙƒÙ„Ù…Ø§Øª Ù…ØªØªØ§Ù„ÙŠØ©",
          all_words_scattered: "ÙƒÙ„Ù…Ø§Øª Ù…ØªÙØ±Ù‚Ø©",
          partial_words: "ÙƒÙ„Ù…Ø§Øª Ù…ÙØ±Ø¯Ø©",
          entity_match: "Ù…Ø·Ø§Ø¨Ù‚Ø© ÙƒÙŠØ§Ù†",
          hybrid_match: "Ù…Ø·Ø§Ø¨Ù‚Ø© Ù‡Ø¬ÙŠÙ†Ø©",
          no_match: "Ø¨Ø¯ÙˆÙ† Ù…Ø·Ø§Ø¨Ù‚Ø©",
        };
        return map[type] || type;
      }
    </script>
  </body>
</html>
