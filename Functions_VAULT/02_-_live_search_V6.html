<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø´Ø¹Ø±</title>
    <script src="https://cdn.jsdelivr.net/npm/flexsearch@0.7.31/dist/flexsearch.bundle.js"></script>
    <style>
      :root {
        --bg: #f9fafb;
        --card: #fff;
        --accent: #ffd54f;
        --border: #e8e8e8;
        --text: #111;
        --muted: #666;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Noto Naskh Arabic", "Segoe UI", Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
        direction: rtl;
        padding: 20px;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
      }

      h1 {
        font-size: 24px;
        margin-bottom: 8px;
      }

      .status {
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 16px;
      }

      .search-bar {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
      }

      input {
        flex: 1;
        padding: 14px 16px;
        border: 1px solid var(--border);
        border-radius: 10px;
        font-size: 17px;
        background: white;
      }

      button {
        padding: 10px 16px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: white;
        cursor: pointer;
        font-size: 14px;
      }

      button:hover {
        background: #f5f5f5;
      }

      .results {
        margin-top: 16px;
      }

      .result {
        background: white;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .result:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
      }

      .title {
        font-weight: 700;
        font-size: 18px;
        margin-bottom: 10px;
        color: #2c3e50;
      }

      .poem-lines {
        line-height: 1.9;
        font-size: 18px;
        color: var(--text);
        font-family: "Noto Naskh Arabic", "Traditional Arabic", serif;
      }

      .poetry-line {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 4px;
        max-width: 550px;
        margin-left: auto;
        margin-right: auto;
      }

      .hemistich {
        text-align: justify;
        word-spacing: 0.05em;
      }

      .hemistich-right {
        text-align-last: right;
      }

      .hemistich-left {
        text-align-last: left;
      }

      /* Modern minimal metadata panel */
      .metadata-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border-radius: 28px 28px 0 0;
        padding: 0;
        box-shadow: 0 -20px 60px rgba(0, 0, 0, 0.15);
        transform: translateY(100%);
        transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        max-height: 50vh;
        overflow: hidden;
        z-index: 2000;
      }

      .metadata-panel.visible {
        transform: translateY(0);
      }

      .metadata-header {
        padding: 24px 28px 16px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        background: linear-gradient(
          180deg,
          rgba(255, 249, 230, 0.3) 0%,
          transparent 100%
        );
      }

      .metadata-body {
        padding: 20px 28px 32px;
        overflow-y: auto;
        max-height: calc(50vh - 120px);
      }

      .summary-box {
        background: linear-gradient(135deg, #fffbf0 0%, #fff8e6 100%);
        border: 1px solid rgba(255, 213, 79, 0.3);
        border-radius: 16px;
        padding: 20px 24px;
        margin-bottom: 24px;
        line-height: 1.8;
        font-size: 15px;
        color: #4a4a4a;
        position: relative;
        overflow: hidden;
      }

      .summary-box::before {
        content: "ğŸ“";
        position: absolute;
        top: 16px;
        left: 16px;
        font-size: 28px;
        opacity: 0.3;
      }

      .summary-box .summary-label {
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #b8860b;
        margin-bottom: 8px;
        display: block;
      }

      .metadata-section {
        margin-bottom: 20px;
      }

      .metadata-section-title {
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        color: #999;
        margin-bottom: 12px;
        padding-right: 8px;
      }

      .metadata-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .metadata-chip {
        background: white;
        border: 1.5px solid rgba(255, 213, 79, 0.4);
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 13px;
        color: #333;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      }

      .metadata-chip:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border-color: #ffd54f;
      }

      .metadata-chip .label {
        font-weight: 600;
        color: #b8860b;
      }

      .clickable-line {
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        padding: 12px 16px;
        margin: -12px -16px 4px;
        border-radius: 12px;
        position: relative;
      }

      .clickable-line::before {
        content: "";
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 3px;
        height: 0;
        background: linear-gradient(180deg, #ffd54f 0%, #ffb300 100%);
        border-radius: 0 3px 3px 0;
        transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .clickable-line:hover {
        background: rgba(255, 213, 79, 0.08);
      }

      .clickable-line:hover::before {
        height: 60%;
      }

      .clickable-line.active {
        background: linear-gradient(
          90deg,
          rgba(255, 213, 79, 0.15) 0%,
          rgba(255, 213, 79, 0.05) 100%
        );
      }

      .clickable-line.active::before {
        height: 80%;
      }

      .close-metadata-btn {
        background: rgba(0, 0, 0, 0.05);
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        color: #666;
        transition: all 0.2s;
        flex-shrink: 0;
      }

      .close-metadata-btn:hover {
        background: rgba(0, 0, 0, 0.1);
        transform: rotate(90deg);
      }

      mark {
        background: var(--accent);
        padding: 2px 4px;
        border-radius: 3px;
        font-weight: 600;
      }

      .meta {
        margin-top: 10px;
        font-size: 12px;
        color: var(--muted);
      }

      .badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 12px;
        background: #e3f2fd;
        color: #1976d2;
        font-size: 11px;
        margin-left: 4px;
      }

      .no-results {
        text-align: center;
        padding: 40px;
        color: var(--muted);
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø´Ø¹Ø±</h1>
      <div class="status" id="status">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

      <div class="search-bar">
        <input
          id="searchInput"
          type="search"
          placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø£Ùˆ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ (Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ØŒ Ø­Ø¨ØŒ Ø¯Ø¨ÙŠ)"
          disabled
        />
        <button id="clearBtn" disabled>Ù…Ø³Ø­</button>
      </div>

      <div id="results" class="results"></div>
    </div>

    <script>
      // ============================================================
      // CONFIG
      // ============================================================
      const CSV_FILE = "02 - live_search.csv";
      const DEBOUNCE_MS = 150;

      // Boosted words for priority matching
      const BOOSTED_WORDS = [
        // Immediate Family & Close Relations
        "Ù…Ø­Ù…Ø¯",
        "Ø±Ø§Ø´Ø¯",
        "Ø²Ø§ÙŠØ¯",
        "Ù‡Ù†Ø¯",
        "Ø´ÙŠØ®Ø©",
        "Ù…ÙƒØªÙˆÙ…",
        "Ø£Ø­Ù…Ø¯",
        "Ø­Ù…Ø¯Ø§Ù†",
        "ÙÙ„Ø°Ø©",
        "Ù†ÙˆØ±",
        "Ø­Ø¨ÙŠØ¨ÙŠ",
        "Ø£Ù…ÙŠ",
        "Ø£Ø¨ÙŠ",
        "Ø§Ø¨Ù†ÙŠ",
        "Ø§Ø¨Ù†ØªÙŠ",
        "Ø£Ø®ÙŠ",
        "Ø¨Ù†ØªÙŠ",
        "Ø§Ø¨Ù†ØªÙŠ",
        "ÙØ±Ø­ØªÙŠ",

        // Leadership & Founding Fathers
        "Ø¨Ùˆ Ø®Ø§Ù„Ø¯",
        "MBZ",
        "Ø®Ù„ÙŠÙØ©",
        "Ø³Ø¹ÙˆØ¯",
        "ØµÙ‚Ø±",
        "Ø­Ù…ÙŠØ¯",
        "Ø±Ø§Ø´Ø¯ Ø¨Ù† Ø³Ø¹ÙŠØ¯",
        "Ù…ÙƒØªÙˆÙ… Ø¨Ù† Ø±Ø§Ø´Ø¯",
        "Ø²Ø§ÙŠØ¯ Ø¨Ù† Ø³Ù„Ø·Ø§Ù†",
        "Ø­Ø§ÙƒÙ… Ø¯Ø¨ÙŠ",
        "Ø­Ø§ÙƒÙ… Ø£Ø¨ÙˆØ¸Ø¨ÙŠ",
        "Ø­Ø§ÙƒÙ… Ø§Ù„Ø´Ø§Ø±Ù‚Ø©",
        "Ø­Ø§ÙƒÙ… Ø§Ù„ÙØ¬ÙŠØ±Ø©",
        "Ø­Ø§ÙƒÙ… Ø±Ø£Ø³ Ø§Ù„Ø®ÙŠÙ…Ø©",
        "Ø­Ø§ÙƒÙ… Ø¹Ø¬Ù…Ø§Ù†",
        "Ù†Ø§Ø¦Ø¨ Ø±Ø¦ÙŠØ³ Ø§Ù„Ø¯ÙˆÙ„Ø©",
        "Ø±Ø¦ÙŠØ³ Ø§Ù„ÙˆØ²Ø±Ø§Ø¡",

        // Core National & Pride Terms
        "Ø§Ù„ÙˆØ·Ù†",
        "Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª",
        "Ø¯Ø¨ÙŠ",
        "Ø£Ø¨ÙˆØ¸Ø¨ÙŠ",
        "Ø§Ù„Ø´Ø§Ø±Ù‚Ø©",
        "Ø§Ù„ÙØ¬ÙŠØ±Ø©",
        "Ø±Ø£Ø³ Ø§Ù„Ø®ÙŠÙ…Ø©",
        "Ø¹Ø¬Ù…Ø§Ù†",
        "Ø£Ù… Ø§Ù„Ù‚ÙŠÙˆÙŠÙ†",
        "Ø§Ù„Ø´Ù‡Ø¯Ø§Ø¡",
        "Ø§Ù„Ø¬Ù†ÙˆØ¯",
        "Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ†",
        "Ø´Ø¹Ø¨ Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª",
        "Ø§Ù„Ø¢Ø¨Ø§Ø¡ Ø§Ù„Ù…Ø¤Ø³Ø³ÙŠÙ†",
        "Ø§Ù„Ø¹Ù„Ù…",
        "Ø§Ù„Ø±Ø§ÙŠØ©",
        "Ø§Ù„Ù…Ø¬Ø¯",
        "Ø§Ù„ÙØ®Ø±",
        "Ø§Ù„ÙƒØ±Ø§Ù…Ø©",
        "Ø§Ù„ÙˆÙØ§",
        "Ø§Ù„Ø¹Ø±ÙˆØ¨Ø©",
        "Ø§Ù„Ø£Ù…Ù„",
        "Ø§Ù„Ø²Ù…Ù†",

        // Common Poetic Words / Love Language
        "Ø­Ø¨",
        "Ø¹Ø´Ù‚",
        "Ù‚Ù„Ø¨",
        "Ø§Ù„Ø¹ÙŠÙˆÙ†",
        "Ø§Ù„Ø´ÙˆÙ‚",
        "Ø§Ù„ØºÙ„Ø§",
        "Ø§Ù„Ù‡Ø¬Ø±",
        "Ø§Ù„ÙØ±Ø§Ù‚",
        "Ø§Ù„ÙˆØµÙ„",
        "Ø§Ù„Ù‡ÙˆÙ‰",
        "Ø§Ù„ØºØ±Ø§Ù…",
        "Ø§Ù„Ù…Ø­Ø¨ÙŠÙ†",
        "Ø§Ù„Ø§Ø´ÙˆØ§Ù‚",
        "Ø§Ù„Ø­Ù†ÙŠÙ†",
        "Ø§Ù„ÙˆØ¬Ø¯",
        "Ø§Ù„Ù„ÙˆØ¹Ø©",
        "Ø§Ù„Ø´Ø¬Ù†",
        "Ø§Ù„Ø¬Ø±ÙˆØ­",
        "Ø§Ù„Ø£Ù„Ù…",
        "Ø§Ù„Ø¯Ù…ÙˆØ¹",
        "Ø§Ù„Ø­Ø²Ù†",
        "Ø§Ù„Ù…Ø­Ø§Ù†ÙŠ",
        "Ø§Ù„Ø¹Ø°Ø§Ù„",
        "Ø§Ù„ØµØ¯",
        "Ø§Ù„Ù‡Ø¬Ø±Ø§Ù†",
        "Ø§Ù„Ù…Ù„Ø§Ù…",

        // Key Events & Cultural Terms
        "ÙŠÙˆÙ… Ø§Ù„Ø´Ù‡ÙŠØ¯",
        "Ø§Ù„ÙŠÙˆÙ… Ø§Ù„ÙˆØ·Ù†ÙŠ",
        "ÙŠÙˆÙ… Ø§Ù„Ø¹Ù„Ù…",
        "ÙŠÙˆÙ… Ø§Ù„Ø§ØªØ­Ø§Ø¯",
        "Ø±Ù…Ø¶Ø§Ù†",
        "Ø¹ÙŠØ¯ Ø§Ù„ÙØ·Ø±",
        "Ø¹ÙŠØ¯ Ø§Ù„Ø£Ø¶Ø­Ù‰",
        "ÙŠÙˆÙ… Ø¹Ø±ÙØ©",
        "Ø±Ø£Ø³ Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù‡Ø¬Ø±ÙŠØ©",
        "Ø§Ù„Ù…ÙˆÙ„Ø¯ Ø§Ù„Ù†Ø¨ÙˆÙŠ",
        "ÙŠÙˆÙ… Ø§Ù„Ø£Ù…",
        "ØªØ­Ø¯ÙŠ Ø¯Ø¨ÙŠ Ù„Ù„ÙŠØ§Ù‚Ø©",
        "Ù…Ù‡Ø±Ø¬Ø§Ù† Ø¯Ø¨ÙŠ Ù„Ù„ØªØ³ÙˆÙ‚",
        "Ù…ÙØ§Ø¬Ø¢Øª Ø¯Ø¨ÙŠ Ø§Ù„ØµÙŠÙÙŠØ©",
        "Ù…Ø¹Ø±Ø¶ Ø¯Ø¨ÙŠ Ù„Ù„Ø·ÙŠØ±Ø§Ù†",
        "Ø¬Ø§Ø¦Ø²Ø© Ø£Ø¨ÙˆØ¸Ø¨ÙŠ Ø§Ù„ÙƒØ¨Ø±Ù‰",
        "ÙƒØ£Ø³ Ø¯Ø¨ÙŠ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ",
        "expo 2020",

        // Pan-Arab / Regional References
        "Ù…ØµØ±",
        "ÙÙ„Ø³Ø·ÙŠÙ†",
        "Ø§Ù„Ù…ØºØ±Ø¨",
        "Ø¨ØºØ¯Ø§Ø¯",
        "Ø§Ù„Ø´Ø§Ù…",
        "Ø³Ù„Ù…Ø§Ù†",
        "ØªÙ…ÙŠÙ…",
        "Ø­Ù…Ø¯",
        "Ù…Ø´Ø¹Ù„",
        "Ù‡ÙŠØ«Ù…",
        "Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø³Ù„Ù…Ø§Ù†",
        "MBS",

        // Miscellaneous Boosters from Poetry Style
        "Ù„ÙŠÙ„",
        "Ø§Ù„Ø¹Ø·Ø±",
        "Ø§Ù„Ø¹Ø´Ù‚",
        "Ø§Ù„Ø±ÙˆØ­",
        "Ø§Ù„Ø­ÙŠØ§Ø©",
        "Ø§Ù„Ø¯Ù†ÙŠØ§",
        "Ø§Ù„ØµØ¨Ø±",
        "Ø§Ù„Ø£Ù…Ù„",
        "Ø§Ù„Ù…Ø¬Ø¯",
        "Ø§Ù„Ø³Ù…Ø§Ø¡",
        "Ø§Ù„Ø£Ø±Ø¶",
        "Ø§Ù„Ù‡ÙˆØ§Ø¡",
        "Ø§Ù„Ø«Ø±Ø§",
        "Ø§Ù„Ù…Ø§Ø¡",
        "Ø§Ù„Ø¨Ø­Ø±",
        "Ø§Ù„Ø´Ù…Ø³",
        "Ø§Ù„Ù‚Ù…Ø±",
      ];

      // Latin to Arabic mapping
      const LATIN_TO_ARABIC = {
        // Names & Family
        mohamed: "Ù…Ø­Ù…Ø¯",
        mohammad: "Ù…Ø­Ù…Ø¯",
        ahmed: "Ø£Ø­Ù…Ø¯",
        hmd: "Ø­Ù…Ø¯",
        hamdan: "Ø­Ù…Ø¯Ø§Ù†",
        hind: "Ù‡Ù†Ø¯",
        sheikha: "Ø´ÙŠØ®Ø©",
        mktoum: "Ù…ÙƒØªÙˆÙ…",
        bin: "Ø¨Ù†",
        ibn: "Ø¨Ù†",

        // Leadership & Royalty
        mbz: "Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø²Ø§ÙŠØ¯",
        zayed: "Ø²Ø§ÙŠØ¯",
        zxayed: "Ø²Ø§ÙŠØ¯",
        khalifa: "Ø®Ù„ÙŠÙØ©",
        saud: "Ø³Ø¹ÙˆØ¯",
        saqr: "ØµÙ‚Ø±",
        hamid: "Ø­Ù…ÙŠØ¯",
        rashid: "Ø±Ø§Ø´Ø¯",
        "rashid bin said": "Ø±Ø§Ø´Ø¯ Ø¨Ù† Ø³Ø¹ÙŠØ¯",
        "maktoum bin rashid": "Ù…ÙƒØªÙˆÙ… Ø¨Ù† Ø±Ø§Ø´Ø¯",
        "zayed bin sultan": "Ø²Ø§ÙŠØ¯ Ø¨Ù† Ø³Ù„Ø·Ø§Ù†",
        "ruler of dubai": "Ø­Ø§ÙƒÙ… Ø¯Ø¨ÙŠ",
        "ruler of abu dhabi": "Ø­Ø§ÙƒÙ… Ø£Ø¨ÙˆØ¸Ø¨ÙŠ",
        "ruler of sharjah": "Ø­Ø§ÙƒÙ… Ø§Ù„Ø´Ø§Ø±Ù‚Ø©",
        "ruler of fujairah": "Ø­Ø§ÙƒÙ… Ø§Ù„ÙØ¬ÙŠØ±Ø©",
        "ruler of ras al khaimah": "Ø­Ø§ÙƒÙ… Ø±Ø£Ø³ Ø§Ù„Ø®ÙŠÙ…Ø©",
        "ruler of ajman": "Ø­Ø§ÙƒÙ… Ø¹Ø¬Ù…Ø§Ù†",
        "vice president": "Ù†Ø§Ø¦Ø¨ Ø±Ø¦ÙŠØ³ Ø§Ù„Ø¯ÙˆÙ„Ø©",
        "prime minister": "Ø±Ø¦ÙŠØ³ Ø§Ù„ÙˆØ²Ø±Ø§Ø¡",

        // National & Cultural terms
        home: "Ø§Ù„ÙˆØ·Ù†",
        uae: "Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª",
        dubai: "Ø¯Ø¨ÙŠ",
        abudhabi: "Ø£Ø¨ÙˆØ¸Ø¨ÙŠ",
        sharjah: "Ø§Ù„Ø´Ø§Ø±Ù‚Ø©",
        fujairah: "Ø§Ù„ÙØ¬ÙŠØ±Ø©",
        "ras alkhaimah": "Ø±Ø£Ø³ Ø§Ù„Ø®ÙŠÙ…Ø©",
        ajman: "Ø¹Ø¬Ù…Ø§Ù†",
        "um alqaiwain": "Ø£Ù… Ø§Ù„Ù‚ÙŠÙˆÙŠÙ†",
        martyrs: "Ø§Ù„Ø´Ù‡Ø¯Ø§Ø¡",
        soldiers: "Ø§Ù„Ø¬Ù†ÙˆØ¯",
        people: "Ø´Ø¹Ø¨ Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª",
        "founding father": "Ø§Ù„Ø¢Ø¨Ø§Ø¡ Ø§Ù„Ù…Ø¤Ø³Ø³ÙŠÙ†",
        flag: ["Ø§Ù„Ø¹Ù„Ù…", "Ø§Ù„Ø±Ø§ÙŠØ©"],
        glory: ["Ø§Ù„Ù…Ø¬Ø¯"],
        pride: ["Ø§Ù„ÙØ®Ø±"],
        dignity: ["Ø§Ù„ÙƒØ±Ø§Ù…Ø©"],
        loyalty: ["Ø§Ù„ÙˆÙØ§"],
        arob: ["Ø§Ù„Ø¹Ø±ÙˆØ¨Ø©"],
        hope: ["Ø§Ù„Ø£Ù…Ù„"],
        time: ["Ø§Ù„Ø²Ù…Ù†"],

        // Poetic / love
        love: "Ø­Ø¨",
        passion: "Ø¹Ø´Ù‚",
        heart: "Ù‚Ù„Ø¨",
        eyes: "Ø§Ù„Ø¹ÙŠÙˆÙ†",
        longing: "Ø§Ù„Ø´ÙˆÙ‚",
        affection: "Ø§Ù„ØºÙ„Ø§",
        separation: "Ø§Ù„Ù‡Ø¬Ø±",
        parting: "Ø§Ù„ÙØ±Ø§Ù‚",
        union: "Ø§Ù„ÙˆØµÙ„",
        desire: "Ø§Ù„Ù‡ÙˆÙ‰",
        romance: "Ø§Ù„ØºØ±Ø§Ù…",
        lovers: "Ø§Ù„Ù…Ø­Ø¨ÙŠÙ†",
        longings: "Ø§Ù„Ø§Ø´ÙˆØ§Ù‚",
        nostalgia: "Ø§Ù„Ø­Ù†ÙŠÙ†",
        existence: "Ø§Ù„ÙˆØ¬Ø¯",
        anguish: "Ø§Ù„Ù„ÙˆØ¹Ø©",
        melancholy: "Ø§Ù„Ø´Ø¬Ù†",
        wounds: "Ø§Ù„Ø¬Ø±ÙˆØ­",
        pain: "Ø§Ù„Ø£Ù„Ù…",
        sorrow: "Ø§Ù„Ø­Ø²Ù†",
        afflictions: "Ø§Ù„Ù…Ø­Ø§Ù†ÙŠ",
        reproaches: "Ø§Ù„Ø¹Ø°Ø§Ù„",
        rejection: "Ø§Ù„ØµØ¯",
        abandonment: "Ø§Ù„Ù‡Ø¬Ø±Ø§Ù†",
        reproach: "Ø§Ù„Ù…Ù„Ø§Ù…",
        night: "Ù„ÙŠÙ„",
        perfume: "Ø§Ù„Ø¹Ø·Ø±",
        soul: "Ø§Ù„Ø±ÙˆØ­",
        life: "Ø§Ù„Ø­ÙŠØ§Ø©",
        world: "Ø§Ù„Ø¯Ù†ÙŠØ§",

        // Events & holidays
        "martyrs day": "ÙŠÙˆÙ… Ø§Ù„Ø´Ù‡ÙŠØ¯",
        "national day": "Ø§Ù„ÙŠÙˆÙ… Ø§Ù„ÙˆØ·Ù†ÙŠ",
        "flag day": "ÙŠÙˆÙ… Ø§Ù„Ø¹Ù„Ù…",
        "union day": "ÙŠÙˆÙ… Ø§Ù„Ø§ØªØ­Ø§Ø¯",
        ramadan: "Ø±Ù…Ø¶Ø§Ù†",
        "eid al fitr": "Ø¹ÙŠØ¯ Ø§Ù„ÙØ·Ø±",
        "eid al adha": "Ø¹ÙŠØ¯ Ø§Ù„Ø£Ø¶Ø­Ù‰",
        "arafah day": "ÙŠÙˆÙ… Ø¹Ø±ÙØ©",
        "hijri new year": "Ø±Ø£Ø³ Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù‡Ø¬Ø±ÙŠØ©",
        "mawlid al nabawi": "Ø§Ù„Ù…ÙˆÙ„Ø¯ Ø§Ù„Ù†Ø¨ÙˆÙŠ",
        "mothers day": "ÙŠÙˆÙ… Ø§Ù„Ø£Ù…",

        "dubai fitness challenge": "ØªØ­Ø¯ÙŠ Ø¯Ø¨ÙŠ Ù„Ù„ÙŠØ§Ù‚Ø©",
        "dubai shopping festival": "Ù…Ù‡Ø±Ø¬Ø§Ù† Ø¯Ø¨ÙŠ Ù„Ù„ØªØ³ÙˆÙ‚",
        "dubai summer surprises": "Ù…ÙØ§Ø¬Ø¢Øª Ø¯Ø¨ÙŠ Ø§Ù„ØµÙŠÙÙŠØ©",
        "dubai airshow": "Ù…Ø¹Ø±Ø¶ Ø¯Ø¨ÙŠ Ù„Ù„Ø·ÙŠØ±Ø§Ù†",
        "abu dhabi grand prix": "Ø¬Ø§Ø¦Ø²Ø© Ø£Ø¨ÙˆØ¸Ø¨ÙŠ Ø§Ù„ÙƒØ¨Ø±Ù‰",
        "dubai world cup": "ÙƒØ£Ø³ Ø¯Ø¨ÙŠ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ",
        expo2020: "expo 2020",

        // Pan-Arab / Regional (UAE-relevant)
        egypt: "Ù…ØµØ±",
        palestine: "ÙÙ„Ø³Ø·ÙŠÙ†",
        morocco: "Ø§Ù„Ù…ØºØ±Ø¨",
        baghdad: "Ø¨ØºØ¯Ø§Ø¯",
        sham: "Ø§Ù„Ø´Ø§Ù…",

        // GCC (Closest to UAE)
        uae: "Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª",
        dubai: "Ø¯Ø¨ÙŠ",
        abu_dhabi: "Ø£Ø¨ÙˆØ¸Ø¨ÙŠ",
        sharjah: "Ø§Ù„Ø´Ø§Ø±Ù‚Ø©",

        saudi: "Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©",
        ksa: "Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©",
        riyadh: "Ø§Ù„Ø±ÙŠØ§Ø¶",
        jeddah: "Ø¬Ø¯Ø©",

        oman: "Ø¹ÙÙ…Ø§Ù†",
        muscat: "Ù…Ø³Ù‚Ø·",

        kuwait: "Ø§Ù„ÙƒÙˆÙŠØª",

        qatar: "Ù‚Ø·Ø±",
        doha: "Ø§Ù„Ø¯ÙˆØ­Ø©",

        bahrain: "Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†",
        manama: "Ø§Ù„Ù…Ù†Ø§Ù…Ø©",

        // Nearby Arab states with strong relation
        jordan: "Ø§Ù„Ø£Ø±Ø¯Ù†",
        amman: "Ø¹Ù…Ù‘Ø§Ù†",

        iraq: "Ø§Ù„Ø¹Ø±Ø§Ù‚",
        basra: "Ø§Ù„Ø¨ØµØ±Ø©",

        syria: "Ø³ÙˆØ±ÙŠØ§",
        damascus: "Ø¯Ù…Ø´Ù‚",

        lebanon: "Ù„Ø¨Ù†Ø§Ù†",
        beirut: "Ø¨ÙŠØ±ÙˆØª",

        yemen: "Ø§Ù„ÙŠÙ…Ù†",
        sanaa: "ØµÙ†Ø¹Ø§Ø¡",

        // North Africa (frequent cultural ties)
        tunisia: "ØªÙˆÙ†Ø³",
        algeria: "Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±",
        libya: "Ù„ÙŠØ¨ÙŠØ§",
        sudan: "Ø§Ù„Ø³ÙˆØ¯Ø§Ù†",

        salman: "Ø³Ù„Ù…Ø§Ù†",
        tamim: "ØªÙ…ÙŠÙ…",
        mishal: "Ù…Ø´Ø¹Ù„",
        haitham: "Ù‡ÙŠØ«Ù…",
        "mohamed bin salman": "Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø³Ù„Ù…Ø§Ù†",
        mbs: "MBS",

        // Elements / natural
        perfume: "Ø§Ù„Ø¹Ø·Ø±",
        love: "Ø§Ù„Ø¹Ø´Ù‚",
        soul: "Ø§Ù„Ø±ÙˆØ­",
        life: "Ø§Ù„Ø­ÙŠØ§Ø©",
        world: "Ø§Ù„Ø¯Ù†ÙŠØ§",
        patience: "Ø§Ù„ØµØ¨Ø±",
        hope: "Ø§Ù„Ø£Ù…Ù„",
        sky: "Ø§Ù„Ø³Ù…Ø§Ø¡",
        earth: "Ø§Ù„Ø£Ø±Ø¶",
        air: "Ø§Ù„Ù‡ÙˆØ§Ø¡",
        soil: "Ø§Ù„Ø«Ø±Ø§",
        water: "Ø§Ù„Ù…Ø§Ø¡",
        sea: "Ø§Ù„Ø¨Ø­Ø±",
        sun: "Ø§Ù„Ø´Ù…Ø³",
        moon: "Ø§Ù„Ù‚Ù…Ø±",
      };

      // ============================================================
      // STATE
      // ============================================================
      let flexIndex = null;
      let poemsData = [];
      let debounceTimer = null;

      const searchInput = document.getElementById("searchInput");
      const clearBtn = document.getElementById("clearBtn");
      const resultsDiv = document.getElementById("results");
      const statusDiv = document.getElementById("status");

      // ============================================================
      // ARABIC NORMALIZATION
      // ============================================================
      function normalize(text) {
        if (!text) return "";
        return String(text)
          .replace(/[\u0610-\u061A\u064B-\u065F\u06D6-\u06ED]/g, "")
          .replace(/\u0640/g, "")
          .replace(/[Ø¥Ø£Ø¢Ø§]/g, "Ø§")
          .replace(/Ù‰/g, "ÙŠ")
          .replace(/[Ø¤Ø¦]/g, "Ø¡")
          .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()ØŸÙ¬Â«Â»"""''\-â€“â€”]/g, " ")
          .replace(/\s+/g, " ")
          .trim();
      }

      function mapLatinToArabic(query) {
        const tokens = query.toLowerCase().split(/\s+/);
        return tokens.map((t) => LATIN_TO_ARABIC[t] || t).join(" ");
      }

      // ============================================================
      // CSV LOADER
      // ============================================================
      async function loadCSV(path) {
        const response = await fetch(path);
        if (!response.ok) throw new Error(`Failed to load ${path}`);

        const text = await response
          .text()
          .then((t) => t.replace(/^\uFEFF/, ""));
        const lines = text.trim().split(/\r?\n/);

        if (lines.length < 2) throw new Error("CSV is empty");

        const headers = lines[0].split(",").map((h) => h.trim());
        const rows = [];

        let i = 1;
        while (i < lines.length) {
          let currentLine = lines[i];
          let parts = [];
          let current = "";
          let inQuotes = false;

          // Handle multi-line quoted fields
          while (i < lines.length) {
            for (let j = 0; j < currentLine.length; j++) {
              const char = currentLine[j];

              if (char === '"') {
                if (inQuotes && currentLine[j + 1] === '"') {
                  current += '"';
                  j++;
                } else {
                  inQuotes = !inQuotes;
                }
              } else if (char === "," && !inQuotes) {
                parts.push(current);
                current = "";
              } else {
                current += char;
              }
            }

            if (inQuotes) {
              current += "\n";
              i++;
              if (i < lines.length) {
                currentLine = lines[i];
              } else {
                break;
              }
            } else {
              parts.push(current);
              break;
            }
          }

          // NEW CSV has: poem_id, Row_ID, Title_raw, Poem_line_raw, summary, Title_cleaned, Poem_line_cleaned, Ù‚Ø§ÙÙŠØ©, Ø§Ù„Ø¨Ø­Ø±, ÙˆØµÙ„, Ø­Ø±ÙƒØ©, Ù†ÙˆØ¹, Ø´Ø®Øµ, sentiments, Ø£Ù…Ø§ÙƒÙ†, Ø£Ø­Ø¯Ø§Ø«, Ù…ÙˆØ§Ø¶ÙŠØ¹, ØªØµÙ†ÙŠÙ, overall confidence, Status
          if (parts.length >= 7) {
            rows.push({
              poem_id: parts[0]?.trim(),
              Row_ID: parts[1]?.trim(),
              Title_raw: parts[2]?.trim(),
              Poem_line_raw: parts[3]?.trim(),
              summary: parts[4]?.trim(),
              Title_cleaned: parts[5]?.trim(),
              Poem_line_cleaned: parts[6]?.trim(),
              qafiya: parts[7]?.trim(),
              bahr: parts[8]?.trim(),
              wasl: parts[9]?.trim(),
              haraka: parts[10]?.trim(),
              naw3: parts[11]?.trim(),
              shaks: parts[12]?.trim(),
              sentiments: parts[13]?.trim(),
              amakin: parts[14]?.trim(),
              ahdath: parts[15]?.trim(),
              mawadi3: parts[16]?.trim(),
              tasnif: parts[17]?.trim(),
              confidence: parts[18]?.trim(),
              status: parts[19]?.trim(),
            });
          }

          i++;
        }

        console.log(`âœ… Parsed ${rows.length} lines`);
        return { headers, rows };
      }

      // ============================================================
      // INDEX BUILDER
      // ============================================================
      function buildIndex(rows) {
        poemsData = rows.map((r, idx) => ({
          idx: idx,
          poem_id: r.poem_id || "",
          row_id: r.Row_ID || "",
          title_raw: r.Title_raw || "",
          line_raw: r.Poem_line_raw || "",
          summary: r.summary || "",
          title_clean: normalize(r.Title_cleaned || r.Title_raw || ""),
          line_clean: normalize(r.Poem_line_cleaned || r.Poem_line_raw || ""),
          qafiya: r.qafiya || "",
          bahr: r.bahr || "",
          wasl: r.wasl || "",
          haraka: r.haraka || "",
          naw3: r.naw3 || "",
          shaks: r.shaks || "",
          sentiments: r.sentiments || "",
          amakin: r.amakin || "",
          ahdath: r.ahdath || "",
          mawadi3: r.mawadi3 || "",
          tasnif: r.tasnif || "",
          confidence: r.confidence || "",
          status: r.status || "",
        }));

        // GROUP lines by poem_id
        const poemGroups = {};
        poemsData.forEach((line) => {
          if (!poemGroups[line.poem_id]) {
            poemGroups[line.poem_id] = {
              poem_id: line.poem_id,
              title_raw: line.title_raw,
              lines: [],
              linesData: [], // Store full line objects with metadata
            };
          }
          poemGroups[line.poem_id].lines.push(line.line_raw);
          poemGroups[line.poem_id].linesData.push(line); // Store full object
        });

        // Store grouped poems globally
        window.poemsGrouped = poemGroups;

        const uniquePoems = Object.keys(poemGroups).length;
        console.log(`âœ… Loaded ${rows.length} lines from ${uniquePoems} poems`);

        // Build FlexSearch index
        flexIndex = new FlexSearch.Document({
          document: {
            id: "idx",
            store: [
              "poem_id",
              "row_id",
              "title_raw",
              "line_raw",
              "summary",
              "title_clean",
              "line_clean",
            ],
            index: [
              { field: "title_clean", tokenize: "forward", weight: 3 },
              { field: "line_clean", tokenize: "forward", weight: 1 },
            ],
          },
          tokenize: "forward",
          cache: true,
        });

        poemsData.forEach((doc) => flexIndex.add(doc));
      }
      console.log(`âœ… Indexed ${poemsData.length} poems`);

      // ============================================================
      // SEARCH ENGINE - ADAPTED FROM WORKING FUZZY_SEARCH.HTML
      // ============================================================
      function search(rawQuery) {
        if (!rawQuery.trim()) return [];

        // MAP LATIN TO ARABIC FIRST (like old fuzzy_search.html)
        const arabicQuery = mapLatinToArabic(rawQuery);
        const normQuery = normalize(arabicQuery);

        console.log("Original query:", rawQuery);
        console.log("Arabic query:", arabicQuery);
        console.log("Normalized query:", normQuery);

        const rawResults = flexIndex.search(normQuery, {
          enrich: true,
          limit: 500,
          suggest: true,
        });

        const candidateMap = new Map();
        rawResults.forEach((bucket) => {
          if (bucket.result) {
            bucket.result.forEach((r) => {
              if (!candidateMap.has(r.id)) {
                candidateMap.set(r.id, r.doc);
              }
            });
          }
        });

        const candidates = Array.from(candidateMap.values());

        // EXACT SCORING FROM WORKING VERSION
        const scored = candidates.map((doc) => {
          let score = 0;
          const title = doc.title_clean || "";
          const line = doc.line_clean || "";

          const titleTokens = title.split(" ").filter(Boolean);
          const lineTokens = line.split(" ").filter(Boolean);

          if (titleTokens.includes(normQuery)) score += 120;
          if (lineTokens.includes(normQuery)) score += 80;

          if (title.indexOf(normQuery) !== -1) score += 60;
          if (line.indexOf(normQuery) !== -1) score += 30;

          if (title.startsWith(normQuery)) score += 40;
          if (line.startsWith(normQuery)) score += 20;

          let boostCount = 0;
          for (const w of BOOSTED_WORDS) {
            if (!w) continue;
            const nw = normalize(w);
            if (title.indexOf(nw) !== -1 || line.indexOf(nw) !== -1)
              boostCount++;
          }
          score += boostCount * 8;

          score -= Math.abs((title.length || 0) - normQuery.length) * 0.5;

          if (
            normQuery.length >= 2 &&
            title.length < normQuery.length &&
            line.length < normQuery.length
          ) {
            score -= 8;
          }

          return { doc, score };
        });

        scored.sort((a, b) => b.score - a.score);

        const resultsPerPoem = new Map();
        const limitedResults = [];

        for (const item of scored) {
          const poemId = item.doc.poem_id;
          const count = resultsPerPoem.get(poemId) || 0;

          if (count < 2) {
            limitedResults.push(item.doc);
            resultsPerPoem.set(poemId, count + 1);
          }

          if (limitedResults.length >= 10) break;
        }

        return limitedResults;
      }

      // ============================================================
      // ANALYTICS - ACCURATE COUNTING
      // ============================================================
      function getAnalytics(query) {
        if (!query.trim()) return { wordCount: 0, poemCount: 0 };

        const arabicQuery = mapLatinToArabic(query);
        const normQuery = normalize(arabicQuery);

        const uniquePoems = new Set();
        let totalOccurrences = 0;

        poemsData.forEach((doc) => {
          const title = doc.title_clean || "";
          const line = doc.line_clean || "";
          const combined = title + " " + line;

          if (combined.indexOf(normQuery) !== -1) {
            uniquePoems.add(doc.poem_id);
            const matches = (
              combined.match(
                new RegExp(
                  normQuery.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"),
                  "g"
                )
              ) || []
            ).length;
            totalOccurrences += matches;
          }
        });

        return {
          wordCount: totalOccurrences,
          poemCount: uniquePoems.size,
        };
      }

      // ============================================================
      // HIGHLIGHTING
      // ============================================================
      function escapeHtml(str) {
        if (!str) return "";
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      function highlight(text, query) {
        if (!text || !query) return escapeHtml(text);

        const normTokens = normalize(query).split(/\s+/).filter(Boolean);
        let result = escapeHtml(text);

        normTokens.forEach((token) => {
          const pattern = Array.from(token)
            .map(
              (ch) =>
                ch + "[\\u0610-\\u061A\\u064B-\\u065F\\u06D6-\\u06ED\\u0640]*"
            )
            .join("");
          const regex = new RegExp(pattern, "gi");
          result = result.replace(regex, (match) => `<mark>${match}</mark>`);
        });

        return result;
      }

      // ============================================================
      // POETRY FORMATTING
      // ============================================================
      function wrapPoetryLine(highlightedText) {
        if (!highlightedText) return "";

        // Split by 4+ spaces
        const parts = highlightedText.split(/\s{4,}/);

        if (parts.length === 2) {
          return `<div class="poetry-line">
            <div class="hemistich hemistich-right">${parts[0].trim()}</div>
            <div class="hemistich hemistich-left">${parts[1].trim()}</div>
          </div>`;
        }

        return highlightedText;
      }

      // ============================================================
      // WIDGET
      // ============================================================
      function openPoemWidget(titleRaw, linesData, poemId, query) {
        const overlay = document.createElement("div");
        overlay.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.7); z-index: 1000;
        display: flex; align-items: center; justify-content: center;
        padding: 20px;
    `;

        // Format each line in the poem with metadata
        const formattedLines = linesData
          .map((lineData, idx) => {
            const lineHTML = wrapPoetryLine(
              highlight(lineData.line_raw, query || "")
            );

            // Wrap line in clickable div with data attributes
            return `<div class="clickable-line" data-line-idx="${idx}" style="margin-bottom: 12px;">
            ${lineHTML}
          </div>`;
          })
          .join("");

        const highlightedTitle = highlight(titleRaw, query || "");

        overlay.innerHTML = `
        <div id="poemWidget" style="
            background: white; border-radius: 16px; padding: 32px;
            max-width: 900px; width: 90%; max-height: 80vh; overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
        ">
            <h2 style="margin-bottom: 20px; font-size: 24px; color: #2c3e50; text-align: center;">${highlightedTitle}</h2>
            <div style="line-height: 2; font-size: 18px; padding-bottom: 20px;">
                ${formattedLines}
            </div>
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; font-size: 13px; color: #666; text-align: center;">
                Ù‚ØµÙŠØ¯Ø© #${poemId}
            </div>
            <button id="closeWidget" style="
                margin-top: 20px; padding: 12px 24px; border-radius: 12px;
                background: #3498db; color: white; border: none;
                cursor: pointer; font-size: 16px; display: block; margin: 20px auto 0;
                font-weight: 500;
            ">Ø¥ØºÙ„Ø§Ù‚</button>
            
            <!-- Modern metadata panel -->
            <div id="metadataPanel" class="metadata-panel">
                <div class="metadata-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 17px; font-weight: 600; color: #2c3e50;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨ÙŠØª</h3>
                        <button id="closeMetadata" class="close-metadata-btn">Ã—</button>
                    </div>
                </div>
                <div class="metadata-body" id="metadataContent"></div>
            </div>
        </div>
    `;

        document.body.appendChild(overlay);

        // Add click handlers for lines
        const clickableLines = overlay.querySelectorAll(".clickable-line");
        const metadataPanel = overlay.querySelector("#metadataPanel");
        const metadataContent = overlay.querySelector("#metadataContent");
        const closeMetadataBtn = overlay.querySelector("#closeMetadata");

        clickableLines.forEach((lineEl, idx) => {
          lineEl.addEventListener("click", () => {
            // Remove active state from all lines
            clickableLines.forEach((l) => l.classList.remove("active"));
            // Add active state to clicked line
            lineEl.classList.add("active");

            // Get line data
            const lineData = linesData[idx];

            // Parse JSON fields
            let shaksDisplay = "";
            let sentimentsDisplay = "";
            let mawadi3Display = "";
            let amakinDisplay = "";
            let ahdathDisplay = "";

            try {
              if (lineData.shaks && lineData.shaks !== "[]") {
                const shaksArray = JSON.parse(lineData.shaks);
                if (shaksArray.length > 0) {
                  shaksDisplay = shaksArray.map((s) => s.name || s).join("ØŒ ");
                }
              }
            } catch (e) {}

            try {
              if (lineData.sentiments && lineData.sentiments !== "[]") {
                const sentArray = JSON.parse(lineData.sentiments);
                if (sentArray.length > 0) {
                  sentimentsDisplay = sentArray.join("ØŒ ");
                }
              }
            } catch (e) {}

            try {
              if (lineData.mawadi3 && lineData.mawadi3 !== "[]") {
                const mawArray = JSON.parse(lineData.mawadi3);
                if (mawArray.length > 0) {
                  mawadi3Display = mawArray.join("ØŒ ");
                }
              }
            } catch (e) {}

            try {
              if (lineData.amakin && lineData.amakin !== "[]") {
                const amakinArray = JSON.parse(lineData.amakin);
                if (amakinArray.length > 0) {
                  amakinDisplay = amakinArray.join("ØŒ ");
                }
              }
            } catch (e) {}

            try {
              if (lineData.ahdath && lineData.ahdath !== "[]") {
                const ahdathArray = JSON.parse(lineData.ahdath);
                if (ahdathArray.length > 0) {
                  ahdathDisplay = ahdathArray.join("ØŒ ");
                }
              }
            } catch (e) {}

            // Build metadata content with beautiful design
            let contentHTML = "";

            // Summary box (most important - show first)
            if (lineData.summary && lineData.summary.trim()) {
              contentHTML += `
                <div class="summary-box">
                  <span class="summary-label">Ù…Ù„Ø®Øµ Ø§Ù„Ø¨ÙŠØª</span>
                  <div>${lineData.summary}</div>
                </div>
              `;
            }

            // Prosody section (Ø§Ù„Ø¨Ø­Ø± ÙˆØ§Ù„Ù‚Ø§ÙÙŠØ©)
            const prosodyItems = [];
            if (lineData.bahr)
              prosodyItems.push(
                `<div class="metadata-chip"><span class="label">Ø§Ù„Ø¨Ø­Ø±:</span> ${lineData.bahr}</div>`
              );
            if (lineData.qafiya)
              prosodyItems.push(
                `<div class="metadata-chip"><span class="label">Ø§Ù„Ù‚Ø§ÙÙŠØ©:</span> ${lineData.qafiya}</div>`
              );
            if (lineData.wasl)
              prosodyItems.push(
                `<div class="metadata-chip"><span class="label">Ø§Ù„ÙˆØµÙ„:</span> ${lineData.wasl}</div>`
              );
            if (lineData.haraka)
              prosodyItems.push(
                `<div class="metadata-chip"><span class="label">Ø§Ù„Ø­Ø±ÙƒØ©:</span> ${lineData.haraka}</div>`
              );

            if (prosodyItems.length > 0) {
              contentHTML += `
                <div class="metadata-section">
                  <div class="metadata-section-title">Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ§Ù„Ù‚Ø§ÙÙŠØ©</div>
                  <div class="metadata-chips">${prosodyItems.join("")}</div>
                </div>
              `;
            }

            // Content section (Ø§Ù„Ù…Ø­ØªÙˆÙ‰)
            const contentItems = [];
            if (shaksDisplay)
              contentItems.push(
                `<div class="metadata-chip"><span class="label">ğŸ‘¤</span> ${shaksDisplay}</div>`
              );
            if (sentimentsDisplay)
              contentItems.push(
                `<div class="metadata-chip"><span class="label">ğŸ’­</span> ${sentimentsDisplay}</div>`
              );
            if (amakinDisplay)
              contentItems.push(
                `<div class="metadata-chip"><span class="label">ğŸ“</span> ${amakinDisplay}</div>`
              );
            if (ahdathDisplay)
              contentItems.push(
                `<div class="metadata-chip"><span class="label">ğŸ“…</span> ${ahdathDisplay}</div>`
              );
            if (mawadi3Display)
              contentItems.push(
                `<div class="metadata-chip"><span class="label">ğŸ·ï¸</span> ${mawadi3Display}</div>`
              );

            if (contentItems.length > 0) {
              contentHTML += `
                <div class="metadata-section">
                  <div class="metadata-section-title">Ø§Ù„Ù…Ø­ØªÙˆÙ‰</div>
                  <div class="metadata-chips">${contentItems.join("")}</div>
                </div>
              `;
            }

            // Classification (don't show if it's "Ù…Ø¹Ø§ØµØ±" only)
            if (
              lineData.naw3 ||
              (lineData.tasnif && lineData.tasnif !== "Ù…Ø¹Ø§ØµØ±")
            ) {
              const classItems = [];
              if (lineData.naw3)
                classItems.push(
                  `<div class="metadata-chip"><span class="label">Ø§Ù„Ù†ÙˆØ¹:</span> ${lineData.naw3}</div>`
                );
              if (lineData.tasnif && lineData.tasnif !== "Ù…Ø¹Ø§ØµØ±")
                classItems.push(
                  `<div class="metadata-chip"><span class="label">Ø§Ù„ØªØµÙ†ÙŠÙ:</span> ${lineData.tasnif}</div>`
                );

              if (classItems.length > 0) {
                contentHTML += `
                  <div class="metadata-section">
                    <div class="metadata-section-title">Ø§Ù„ØªØµÙ†ÙŠÙ</div>
                    <div class="metadata-chips">${classItems.join("")}</div>
                  </div>
                `;
              }
            }

            if (contentHTML) {
              metadataContent.innerHTML = contentHTML;
              metadataPanel.classList.add("visible");
            } else {
              metadataContent.innerHTML = `
                <div style="text-align: center; color: #999; padding: 40px 20px;">
                  <div style="font-size: 48px; margin-bottom: 12px; opacity: 0.3;">ğŸ“–</div>
                  <div>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙŠØª</div>
                </div>
              `;
              metadataPanel.classList.add("visible");
            }
          });
        });

        // Close metadata panel button
        closeMetadataBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          metadataPanel.classList.remove("visible");
          clickableLines.forEach((l) => l.classList.remove("active"));
        });

        // Scroll to first highlight if it exists
        setTimeout(() => {
          const firstMark = overlay.querySelector("mark");
          if (firstMark) {
            firstMark.scrollIntoView({ behavior: "smooth", block: "center" });
          }
        }, 100);

        overlay.addEventListener("click", (e) => {
          if (e.target === overlay || e.target.id === "closeWidget") {
            overlay.remove();
          }
        });
      }

      // ============================================================
      // UI RENDERING
      // ============================================================
      function displayResults(results, query) {
        if (!results || results.length === 0) {
          resultsDiv.innerHTML = '<div class="no-results">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
          return;
        }

        const analytics = getAnalytics(query);
        const arabicQuery = mapLatinToArabic(query);
        const normQuery = normalize(arabicQuery);

        const analyticsHTML = `
        <div style="background: white; border: 1px solid var(--border); border-radius: 10px; padding: 12px 16px; margin-bottom: 16px; display: flex; gap: 20px;">
            <div><span style="color: var(--muted);">Ø§Ù„Ù†ØªØ§Ø¦Ø¬:</span> <strong>${results.length}</strong></div>
            <div><span style="color: var(--muted);">Ø§Ù„Ù‚ØµØ§Ø¦Ø¯:</span> <strong style="color: #2196F3;">${analytics.poemCount}</strong></div>
            <div><span style="color: var(--muted);">Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª:</span> <strong style="color: #4CAF50;">${analytics.wordCount}</strong></div>
        </div>
    `;

        const resultsHTML = results
          .map((r) => {
            const poem = window.poemsGrouped[r.poem_id];
            const totalLines = poem ? poem.lines.length : 0;

            // Find all matching line numbers in this poem
            const matchingLineNumbers = [];
            let occurrenceCount = 0;

            if (poem) {
              poem.lines.forEach((line, idx) => {
                const lineNorm = normalize(line);
                const matches = (
                  lineNorm.match(
                    new RegExp(
                      normQuery.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"),
                      "g"
                    )
                  ) || []
                ).length;
                if (matches > 0) {
                  matchingLineNumbers.push(idx + 1); // 1-indexed
                  occurrenceCount += matches;
                }
              });
            }

            const lineNumbersDisplay =
              matchingLineNumbers.length > 5
                ? matchingLineNumbers.slice(0, 5).join(", ") + "..."
                : matchingLineNumbers.join(", ");

            return `
            <div class="result" data-poem-id="${r.poem_id}">
                <div class="title">${highlight(r.title_raw, arabicQuery)}</div>
                <div class="poem-lines">${wrapPoetryLine(
                  highlight(r.line_raw, arabicQuery)
                )}</div>
                <div class="meta" style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <span class="badge">Ù‚ØµÙŠØ¯Ø© #${r.poem_id}</span>
                    <span class="badge" style="background: #e8f5e9; color: #2e7d32;">ØªÙƒØ±Ø§Ø±: ${occurrenceCount}</span>
                    <span class="badge" style="background: #fff3e0; color: #e65100;">Ø³Ø·Ø±: ${lineNumbersDisplay}</span>
                    <span class="badge" style="background: #e3f2fd; color: #1565c0;">Ø£Ø³Ø·Ø±: ${totalLines}</span>
                </div>
            </div>
        `;
          })
          .join("");

        resultsDiv.innerHTML = analyticsHTML + resultsHTML;

        // Click handler - opens FULL POEM with highlights
        document.querySelectorAll(".result").forEach((el) => {
          el.addEventListener("click", function () {
            const poemId = this.getAttribute("data-poem-id");
            const poem = window.poemsGrouped[poemId];

            if (poem) {
              openPoemWidget(
                poem.title_raw,
                poem.linesData,
                poemId,
                arabicQuery
              );
            }
          });
        });
      }
      // ============================================================
      // EVENT HANDLERS
      // ============================================================
      searchInput.addEventListener("input", (e) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          const query = e.target.value;
          if (!query.trim()) {
            resultsDiv.innerHTML = "";
            return;
          }
          const results = search(query);
          displayResults(results, query);
        }, DEBOUNCE_MS);
      });

      clearBtn.addEventListener("click", () => {
        searchInput.value = "";
        resultsDiv.innerHTML = "";
      });

      // ============================================================
      // INITIALIZATION
      // ============================================================
      (async function init() {
        try {
          statusDiv.textContent = "Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ØµØ§Ø¦Ø¯...";
          const { rows } = await loadCSV(CSV_FILE);
          buildIndex(rows);
          statusDiv.textContent = `âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${rows.length} Ø³Ø·Ø± Ù…Ù† ${
            Object.keys(window.poemsGrouped).length
          } Ù‚ØµÙŠØ¯Ø©`;

          searchInput.disabled = false;
          clearBtn.disabled = false;
          searchInput.focus();
        } catch (error) {
          statusDiv.textContent = "âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„: " + error.message;
          console.error(error);
        }
      })();
    </script>
  </body>
</html>
