<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8"/>
<title>Ø¨Ø­Ø« Ø°ÙƒÙŠ - Fixed</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px;
}
.container { max-width: 1200px; margin: 0 auto; }
.search-box {
  background: white;
  padding: 30px;
  border-radius: 15px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  margin-bottom: 30px;
}
h1 { text-align: center; color: #333; margin-bottom: 20px; font-size: 2em; }
.search-input-group { display: flex; gap: 10px; margin-bottom: 15px; }
input[type="text"] {
  flex: 1;
  padding: 15px;
  font-size: 18px;
  border: 2px solid #ddd;
  border-radius: 8px;
  outline: none;
}
input[type="text"]:focus { border-color: #667eea; }
button {
  padding: 15px 30px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 18px;
  font-weight: bold;
  cursor: pointer;
}
button:hover { transform: translateY(-2px); }
.test-buttons { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
.test-btn {
  padding: 10px 20px;
  background: #f093fb;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
.summary-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
}
.stat-item {
  text-align: center;
  padding: 10px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
}
.stat-value { font-size: 28px; font-weight: bold; margin-bottom: 5px; }
.stat-label { font-size: 14px; opacity: 0.9; }
.tags-container {
  background: white;
  padding: 15px;
  border-radius: 10px;
  margin-bottom: 20px;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}
.tag-pill {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  color: white;
  padding: 6px 15px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
}
.result-card {
  background: white;
  padding: 25px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  border-right: 5px solid #667eea;
}
.result-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}
.result-title {
  font-size: 22px;
  font-weight: bold;
  color: #667eea;
  flex: 1;
}
.result-score {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 8px 15px;
  border-radius: 20px;
  font-weight: bold;
}
.result-poem {
  font-size: 18px;
  color: #333;
  line-height: 2;
  margin-bottom: 15px;
  white-space: pre-wrap;
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
}
.result-meta {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  font-size: 13px;
  color: #666;
  padding-top: 15px;
  border-top: 1px solid #eee;
}
.meta-item {
  background: #f5f5f5;
  padding: 5px 12px;
  border-radius: 15px;
}
.meta-tag {
  background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
  color: #333;
  font-weight: 600;
}
.meta-location {
  background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
  color: #333;
  font-weight: 600;
}
mark {
  background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
  color: white;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: bold;
}
mark.metadata-highlight {
  background: linear-gradient(135deg, #ffe5b4 0%, #ff9966 100%);
  color: #333;
  border: 1px dashed #ff6600;
}
.loading { text-align: center; padding: 40px; color: white; font-size: 18px; display: none; }
.show { display: block; }
</style>
</head>
<body>
<div class="container">
  <div class="search-box">
    <h1>ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ</h1>
    <div class="search-input-group">
      <input type="text" id="searchQuery" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø´Ø®ØµØŒ Ù…ÙƒØ§Ù†ØŒ Ø­Ø¯Ø«..."/>
      <button onclick="searchPoems()">Ø¨Ø­Ø«</button>
    </div>
    <div class="test-buttons">
      <button class="test-btn" onclick="testGrouped()">Ø¨Ùˆ Ø®Ø§Ù„Ø¯</button>
      <button class="test-btn" onclick="testOldFormat()">Ø¨Ùˆ Ø±Ø§Ø´Ø¯</button>
      <button class="test-btn" onclick="testComplex()">Ø²Ø§ÙŠØ¯</button>
    </div>
  </div>
  <div class="loading" id="loading">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div>
  <div id="summaryContainer" style="display:none"></div>
  <div id="tagsContainer" style="display:none"></div>
  <div id="results"></div>
</div>

<script>
const CONFIG = {
  N8N_WEBHOOK_URL: "http://localhost:5678/webhook/N8N",
  SUPABASE_URL: "https://uffjlburuvsnstvgyito.supabase.co",
  SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVmZmpsYnVydXZzbnN0dmd5aXRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTczMTcsImV4cCI6MjA4MjA5MzMxN30.cywWITSP-aJfuXlzyBYHf9Ipnhu-6_mVCZ30h3b1-38",
  USE_N8N: true
};

document.getElementById("searchQuery").addEventListener("keypress", (e) => {
  if (e.key === "Enter") searchPoems();
});

function normalizeForComparison(text) {
  if (!text) return "";
  return text
    .replace(/[^\u0600-\u06FFa-zA-Z0-9]/g, "")
    .replace(/[\u0640]/g, "")
    .replace(/[Ø£Ø¥Ø¢]/g, "Ø§")
    .replace(/[Ù‰]/g, "ÙŠ")
    .replace(/[Ø©]/g, "Ù‡");
}

// FIXED: Accept array directly, handle "pos" field
function highlightText(rawText, matchArray) {
  if (!matchArray || !Array.isArray(matchArray) || matchArray.length === 0) {
    return rawText;
  }

  let positionsToHighlight = new Set();
  let metadataWordsToHighlight = new Set();
  let phrasePartsToHighlight = new Set();

  matchArray.forEach((m) => {
    const posField = m.pos || m.positions; // Handle both field names
    const text = m.text;

    if (posField && posField !== "meta" && posField !== "metadata" && posField !== "phrase") {
      const positions = posField.toString();
      if (positions.includes("-")) {
        const [start, end] = positions.split("-").map(Number);
        for (let i = start; i <= end; i++) positionsToHighlight.add(i);
      } else if (positions.includes(",")) {
        positions.split(",").forEach((p) => positionsToHighlight.add(Number(p.trim())));
      } else {
        positionsToHighlight.add(Number(positions));
      }
    } else if (posField === "phrase" && text) {
      text.split(/\s+/).forEach((w) => {
        if (w) phrasePartsToHighlight.add(normalizeForComparison(w));
      });
    } else if ((posField === "meta" || posField === "metadata") && text) {
      text.split(/\s+/).forEach((w) => {
        if (w) metadataWordsToHighlight.add(normalizeForComparison(w));
      });
    }
  });

  if (positionsToHighlight.size === 0 && metadataWordsToHighlight.size === 0 && phrasePartsToHighlight.size === 0) {
    return rawText;
  }

  const tokens = rawText.split(/(\s+)/);
  let wordIndex = 0;

  return tokens.map((token) => {
    if (!token.trim()) return token;
    const tokenNorm = normalizeForComparison(token);
    if (!tokenNorm) return token;

    const isIndexMatch = positionsToHighlight.has(wordIndex);
    const isPhraseMatch = [...phrasePartsToHighlight].some((target) => 
      tokenNorm.includes(target) || target.includes(tokenNorm)
    );
    const isMetadataMatch = [...metadataWordsToHighlight].some((target) => 
      tokenNorm.includes(target) || target.includes(tokenNorm)
    );

    wordIndex++;

    if (isIndexMatch || isPhraseMatch) return `<mark>${token}</mark>`;
    if (isMetadataMatch) return `<mark class="metadata-highlight">${token}</mark>`;
    return token;
  }).join("");
}

async function searchPoems() {
  const resultsDiv = document.getElementById("results");
  const loadingDiv = document.getElementById("loading");
  
  document.getElementById("summaryContainer").style.display = "none";
  document.getElementById("tagsContainer").style.display = "none";
  loadingDiv.classList.add("show");
  resultsDiv.innerHTML = "";

  try {
    const queryText = document.getElementById("searchQuery").value;
    const payload = { query: queryText, user_language: "ar" };

    const response = await fetch(CONFIG.N8N_WEBHOOK_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!response.ok) throw new Error(`Error: ${response.status}`);
    
    const data = await response.json();
    loadingDiv.classList.remove("show");

    const result = Array.isArray(data) ? data[0] : data;

    if (result && result.results && result.results.length > 0) {
      displaySummary(result);
      displayResults(result.results);
    } else {
      resultsDiv.innerHTML = '<div class="loading show">ğŸ˜• Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
    }
  } catch (error) {
    console.error("Error:", error);
    loadingDiv.classList.remove("show");
    resultsDiv.innerHTML = `<div class="loading show">âŒ Ø®Ø·Ø£: ${error.message}</div>`;
  }
}

function displaySummary(data) {
  const summaryDiv = document.getElementById("summaryContainer");
  summaryDiv.innerHTML = `
    <div class="summary-card">
      <div class="stat-item">
        <div class="stat-value">${data.poems || 0}</div>
        <div class="stat-label">Ù‚ØµÙŠØ¯Ø©</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${data.lines || 0}</div>
        <div class="stat-label">Ø¨ÙŠØª</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${data.results.length}</div>
        <div class="stat-label">Ù†ØªÙŠØ¬Ø©</div>
      </div>
    </div>`;
  summaryDiv.style.display = "block";
}

// FIXED: Use result.title, result.line, result.matches.title, result.matches.line, result.sources
function displayResults(results) {
  const resultsDiv = document.getElementById("results");
  let html = "";

  results.forEach((result) => {
    const titleHighlighted = highlightText(result.title, result.matches?.title || []);
    const poemHighlighted = highlightText(result.line, result.matches?.line || []);
    const hasMetadata = result.matches?.line?.some((w) => w.pos === "meta" || w.pos === "metadata") || false;

    html += `
      <div class="result-card">
        <div class="result-header">
          <div class="result-title">${titleHighlighted}</div>
          <div class="result-score">${result.score}</div>
        </div>
        <div class="result-poem">${poemHighlighted}</div>
        <div class="result-meta">
          <span class="meta-item">Ø³Ø·Ø±: ${result.row_id}</span>
          <span class="meta-item meta-location">${result.sources.join(" + ")}</span>
          ${result.tag ? `<span class="meta-item meta-tag">ğŸ·ï¸ ${result.tag}</span>` : ""}
          ${hasMetadata ? '<span class="meta-item" style="background: #ffe5b4;">ğŸ“Š Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØµÙÙŠØ©</span>' : ""}
        </div>
      </div>`;
  });

  resultsDiv.innerHTML = html;
}

function testGrouped() {
  document.getElementById("searchQuery").value = "Ø¨Ùˆ Ø®Ø§Ù„Ø¯";
  searchPoems();
}
function testOldFormat() {
  document.getElementById("searchQuery").value = "Ø¨Ùˆ Ø±Ø§Ø´Ø¯";
  searchPoems();
}
function testComplex() {
  document.getElementById("searchQuery").value = "Ø²Ø§ÙŠØ¯";
  searchPoems();
}
</script>
</body>
</html>